<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>幻想冒險 V7.3</title>
    <style>
        :root {
            --bg-dark: #0a0a0e;
            --panel-bg: #16161d;
            --panel-border: #333;
            --accent: #ff9800;
            --text-main: #e0e0e0;
            --danger: #ff5252;
            --mana: #448aff;
            --success: #4caf50;
            --r-common: #9e9e9e;
            --r-rare: #2196f3;
            --r-epic: #9c27b0;
            --r-legend: #ffab00;
            --r-mythic: #ff4081;
            --category-potion: #e91e63;
            --category-weapon: #4caf50;
            --category-armor: #795548;
            --category-material: #ff9800;
            --chest-good: #4caf50;
            --chest-bad: #f44336;
            --event-good: #4caf50;
            --event-bad: #f44336;
            --event-neutral: #ff9800;
        }

        * { 
            box-sizing: border-box; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0; 
            background: var(--bg-dark); 
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, sans-serif; 
            height: 100vh;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden;
            padding: 5px;
            touch-action: manipulation;
        }

        #game-container {
            width: 100%; 
            height: 100%; 
            max-width: 1600px; 
            display: grid;
            grid-template-columns: minmax(250px, 1fr) 2fr minmax(250px, 1fr); 
            grid-template-rows: auto 1fr auto;
            gap: 8px; 
            padding: 5px; 
            overflow: hidden;
        }

        .panel {
            background: var(--panel-bg); 
            border: 1px solid var(--panel-border);
            border-radius: 8px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .header { 
            grid-column: 1 / -1; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--accent); 
            padding: 0 15px; 
            font-size: 1em;
        }

        .main-stage { 
            grid-column: 2 / 3; 
            grid-row: 2 / 3; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            background: radial-gradient(circle, #222 0%, #111 100%); 
            overflow: hidden; 
        }

        .control-area { 
            grid-column: 2 / 3; 
            grid-row: 3 / 4; 
            display: grid; 
            grid-template-columns: 1fr 1fr 1.2fr; 
            gap: 8px; 
            min-height: 180px;
        }

        .enemy-sprite { 
            font-size: 5.5em; 
            transition: 0.2s; 
            text-align: center;
        }

        .enemy-ui { 
            width: 95%; 
            background: rgba(0,0,0,0.7); 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid #444; 
            margin-bottom: 12px; 
        }

        .enemy-stats {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 8px; 
            font-weight: bold; 
            color: var(--danger);
            font-size: 1em; 
            white-space: nowrap;
        }

        .enemy-stats span:first-child {
            display: flex; 
            align-items: center; 
            gap: 6px;
        }

        .bar-container { 
            height: 16px; 
            background: #222; 
            border-radius: 8px; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid #444; 
        }

        .bar-fill { 
            height: 100%; 
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .hp-fill { 
            background: var(--danger); 
            box-shadow: 0 0 8px var(--danger); 
        }

        .mp-fill { 
            background: var(--mana); 
            box-shadow: 0 0 8px var(--mana); 
        }

        .bar-text { 
            position: absolute; 
            width: 100%; 
            text-align: center; 
            top:0; 
            font-size: 10px; 
            font-weight: bold; 
            line-height: 16px; 
            text-shadow: 1px 1px black; 
            color: white;
            z-index: 2;
        }

        .btn { 
            border: 1px solid #444; 
            background: #2a2a35; 
            color: white; 
            padding: 14px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-weight: bold; 
            font-size: 0.9em; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px;
        }

        .btn:hover:not(:disabled) { 
            background: #3a3a45; 
            transform: translateY(-2px); 
        }

        .btn:active { 
            transform: translateY(0); 
        }

        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            filter: grayscale(70%);
        }

        .btn.combat-disabled {
            opacity: 0.4;
            filter: grayscale(80%);
            background: #1a1a24;
            border-color: #555;
        }

        .btn-exp { background: #2e7d32; border-color: #4caf50; }
        .btn-atk { background: #c62828; border-color: #ff5252; }
        .btn-shop { background: #4a148c; border-color: #9c27b0; }
        .btn-craft { background: #5d4037; border-color: #8d6e63; }
        .btn-upgrade { background: #006064; border-color: #00bcd4; }

        .grid-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 6px;
            align-items: stretch;
        }

        .item-slot { 
            aspect-ratio: 1; 
            border: 2px solid var(--panel-border); 
            background: #1a1a24;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            border-radius: 6px; 
            cursor: pointer; 
            position: relative; 
            font-size: 1.1em;
            min-height: 50px;
            max-height: 60px;
            width: 100%;
            padding: 4px;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .item-slot:hover {
            transform: scale(1.05);
            border-color: var(--accent);
        }

        .item-slot.r-common { border-color: var(--r-common); }
        .item-slot.r-rare { border-color: var(--r-rare); box-shadow: inset 0 0 4px rgba(33,150,243,0.3); }
        .item-slot.r-epic { border-color: var(--r-epic); box-shadow: inset 0 0 4px rgba(156,39,176,0.3); }
        .item-slot.r-legend { border-color: var(--r-legend); box-shadow: 0 0 6px rgba(255,171,0,0.4); }
        .item-slot.r-mythic { border-color: var(--r-mythic); box-shadow: 0 0 8px rgba(255,64,129,0.6); }

        .item-slot.enhanced::after {
            content: attr(data-enhance);
            position: absolute;
            top: 2px;
            right: 2px;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 4px;
            min-width: 18px;
            text-align: center;
        }

        .category-potion { border-left: 4px solid var(--category-potion); }
        .category-weapon { border-left: 4px solid var(--category-weapon); }
        .category-armor { border-left: 4px solid var(--category-armor); }
        .category-material { border-left: 4px solid var(--category-material); }

        .shop-page, .forge-page, .upgrade-page, .chest-page, .event-page { 
            display: none; 
            flex-direction: column; 
            height: 100%; 
            width: 100%; 
            overflow: hidden;
        }

        .shop-page.active, .forge-page.active, .upgrade-page.active, .chest-page.active, .event-page.active { 
            display: flex; 
        }

        .stage-page { display: none; }
        .stage-page.active { display: flex; flex-direction: column; min-height: 0; }

        .shop-category-tabs, .bag-category-tabs { 
            display: flex; 
            gap: 6px; 
            margin-bottom: 12px; 
            flex-shrink: 0;
        }

        .shop-category-tabs button, .bag-category-tabs button { 
            flex: 1; 
            padding: 8px; 
            font-size: 0.9em; 
            min-width: 80px;
        }

        .shop-grid, .upgrade-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); 
            gap: 10px; 
            overflow-y: auto; 
            flex: 1;
            padding-right: 6px;
            padding-bottom: 20px;
            margin-bottom: 12px;
        }

        .shop-category {
            display: none;
        }

        .shop-category.active {
            display: grid;
        }

        .shop-card, .upgrade-card { 
            background: #252530; 
            border: 1px solid #444; 
            padding: 10px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: 0.2s; 
            display: flex; 
            flex-direction: column;
        }

        .shop-card:hover, .upgrade-card:hover { 
            transform: translateY(-2px); 
            border-color: var(--accent); 
        }

        .shop-card-icon, .upgrade-card-icon { 
            font-size: 2em; 
            margin-bottom: 6px; 
            text-align: center; 
        }

        .shop-card-name, .upgrade-card-name { 
            font-weight: bold; 
            font-size: 0.9em; 
            margin-bottom: 4px; 
        }

        .shop-card-desc, .upgrade-card-desc { 
            font-size: 0.75em; 
            color: #999; 
            margin-bottom: 8px; 
            flex-grow: 1; 
        }

        .shop-card-footer, .upgrade-card-footer { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: auto; 
        }

        .shop-card-price, .upgrade-card-price { 
            color: #ffd700; 
            font-weight: bold; 
            font-size: 0.9em; 
        }

        .forge-page { 
            display: none; 
            flex-direction: column; 
            height: 100%; 
        }

        .forge-page.active { 
            display: flex; 
        }

        .recipe-list { 
            overflow-y: auto; 
            flex: 1;
            padding-right: 6px;
            padding-bottom: 20px;
            margin-bottom: 12px;
        }

        .recipe-card { 
            background: #252530; 
            border: 1px solid #444; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            transition: 0.2s; 
        }

        .recipe-card:hover { 
            border-color: var(--accent); 
        }

        .recipe-card.available { 
            background: rgba(76, 175, 80, 0.1); 
            border-color: var(--success); 
        }

        .recipe-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
        }

        .recipe-icon { 
            font-size: 1.8em; 
        }

        .recipe-name { 
            font-weight: bold; 
            font-size: 1em; 
        }

        .recipe-desc { 
            color: #aaa; 
            font-size: 0.8em; 
            margin-bottom: 10px; 
        }

        .recipe-materials { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
        }

        .material-item { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            background: rgba(0,0,0,0.3); 
            padding: 4px 8px; 
            border-radius: 5px; 
            font-size: 0.9em; 
        }

        .material-item.has-enough { color: var(--success); }
        .material-item.not-enough { opacity: 0.5; }

        @keyframes floatUp { 
            0% { opacity: 1; transform: translateY(0); } 
            100% { opacity: 0; transform: translateY(-60px); } 
        }

        .floating-text { 
            position: absolute; 
            font-size: 2.2em; 
            font-weight: bold; 
            animation: floatUp 1s forwards; 
            z-index: 100; 
            pointer-events: none; 
        }

        .shake { animation: shake 0.3s; }

        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-8px); } 
            75% { transform: translateX(8px); } 
        }

        .modal-overlay { 
            position: fixed; 
            top:0; left:0; 
            width:100%; 
            height:100%; 
            background:rgba(0,0,0,0.9); 
            display:none; 
            align-items:center; 
            justify-content:center; 
            z-index:1000; 
        }

        .modal-box { 
            background: var(--panel-bg); 
            padding: 24px; 
            border-radius: 12px; 
            border: 2px solid #555; 
            width: 90%; 
            max-width: 450px; 
            text-align: center; 
            max-height: 80vh; 
            overflow-y: auto; 
        }

        .tabs-container { 
            display: flex; 
            gap: 6px; 
            margin-bottom: 10px; 
            flex-shrink: 0;
        }

        .tabs-container button { 
            flex: 1; 
            padding: 8px; 
            font-size: 0.85em; 
            height: 40px;
        }

        .tab-content { 
            display: none; 
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .tab-content.active { 
            display: flex;
        }

        #bag-tab {
            flex: 1;
            overflow: hidden;
            display: none;
            flex-direction: column;
            min-height: 0;
        }

        #bag-tab.active {
            display: flex;
        }

        #bag-tab .grid-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
            padding-bottom: 8px;
        }

        #log-tab {
            flex: 1;
            overflow-y: auto;
            font-size: 0.8em;
            color: #aaa;
            line-height: 1.5;
            padding-right: 4px;
            display: none;
            padding-bottom: 15px;
        }

        #log-tab.active {
            display: block;
        }

        .boss-warning { 
            background: linear-gradient(135deg, rgba(255,171,0,0.2), rgba(255,107,0,0.2)); 
            border: 2px solid #ffab00; 
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            text-align: center; 
        }

        .boss-warning-title { 
            color: #ffab00; 
            font-weight: bold; 
            font-size: 1em; 
        }

        .class-card { 
            padding:15px; 
            text-align:left; 
            height:auto; 
            display:flex; 
            gap:12px; 
            align-items:flex-start; 
            cursor:pointer; 
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ffb74d;
        }

        #combat-warning {
            grid-column: 1 / -1;
            color: #ff9800;
            font-size: 0.85em;
            text-align: center;
            margin-top: 8px;
            display: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .equipment-info {
            margin-top: 10px;
            font-size: 0.8em;
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 6px;
            overflow-y: visible;
            max-height: none;
            min-height: 120px;
        }

        .equipment-item {
            margin-bottom: 6px;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .equipment-item:last-child {
            border-bottom: none;
        }

        @keyframes enhanceGlow {
            0% { box-shadow: 0 0 5px #ff9800; }
            50% { box-shadow: 0 0 25px #ff9800; }
            100% { box-shadow: 0 0 5px #ff9800; }
        }

        .enhance-success {
            animation: enhanceGlow 1s ease-in-out;
        }

        .enhance-level {
            color: #ff9800;
            font-weight: bold;
            font-size: 1em;
        }

        @media (hover: none) {
            .btn:hover:not(:disabled) {
                transform: none;
            }
            
            .item-slot:hover {
                transform: none;
            }
            
            .shop-card:hover, .upgrade-card:hover, .recipe-card:hover {
                transform: none;
            }
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin: 12px 0;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            font-size: 1.1em;
            text-align: center;
        }

        .password-error {
            color: #ff5252;
            font-size: 0.9em;
            margin-top: 8px;
            min-height: 24px;
        }

        .skill-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            width: 100%;
        }

        .chest-result-good {
            color: var(--chest-good);
            font-weight: bold;
            font-size: 1.2em;
        }

        .chest-result-bad {
            color: var(--chest-bad);
            font-weight: bold;
            font-size: 1.2em;
        }

        .chest-reward {
            font-size: 1.1em;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
        }

        @keyframes chestOpen {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .chest-opening {
            animation: chestOpen 0.5s ease-in-out;
        }

        #difficulty-easy.active, #difficulty-normal.active, #difficulty-hard.active {
            box-shadow: 0 0 10px currentColor;
            transform: translateY(-2px);
        }

        .event-result-good {
            color: var(--event-good);
            font-weight: bold;
            font-size: 1.2em;
        }

        .event-result-bad {
            color: var(--event-bad);
            font-weight: bold;
            font-size: 1.2em;
        }

        .event-result-neutral {
            color: var(--event-neutral);
            font-weight: bold;
            font-size: 1.2em;
        }

        .event-reward {
            font-size: 1.1em;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
        }

        /* 電腦版背包標籤優化 */
        @media (min-width: 1025px) {
            .bag-category-tabs {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 6px;
                overflow-x: visible;
            }
            
            .bag-category-tabs button {
                min-width: auto;
                font-size: 0.8em !important;
            }
        }

        /* 左側面板間距修正 */
        aside.panel:first-of-type {
            padding: 15px !important;
        }

        /* 修正經驗、生命、魔力條的間距 */
        .stat-label {
            font-size: 0.7em; 
            color: #888; 
            margin-top: 8px !important; 
            margin-bottom: 4px !important;
        }

        .bar-container {
            margin-bottom: 8px !important;
        }

        /* 手機版佈局 */
        @media (max-width: 768px) {
            body {
                padding: 3px;
                height: 100vh;
                overflow: hidden;
                align-items: flex-start;
            }
            
            #game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto auto;
                gap: 5px;
                height: 100%;
                padding: 3px;
            }
            
            .header { 
                grid-column: 1; 
                grid-row: 1;
                padding: 5px 10px;
                font-size: 0.9em;
            }
            
            aside:first-of-type { 
                grid-column: 1; 
                grid-row: 2; 
                max-height: 220px;
                overflow: hidden;
            }
            
            .main-stage { 
                grid-column: 1; 
                grid-row: 3; 
                min-height: 220px;
                max-height: 320px;
            }
            
            .control-area { 
                grid-column: 1; 
                grid-row: 4; 
                grid-template-columns: 1fr;
                min-height: auto;
                gap: 5px;
                max-height: 250px;
                overflow: hidden;
            }
            
            aside:last-of-type { 
                grid-column: 1; 
                grid-row: 5; 
                flex: 1;
                overflow: hidden;
            }
            
            .grid-list {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 4px !important;
            }
            
            .item-slot {
                min-height: 45px !important;
                max-height: 55px !important;
                font-size: 0.9em !important;
                padding: 6px !important;
            }
            
            .btn {
                padding: 14px 10px !important;
                font-size: 0.9em !important;
                min-height: 70px;
                line-height: 1.3;
            }
            
            .enemy-sprite {
                font-size: 4em !important;
            }
            
            .modal-box {
                width: 95% !important;
                padding: 20px !important;
                margin: 10px;
                max-height: 80vh !important;
            }
            
            .panel {
                padding: 12px !important;
            }
            
            .shop-grid, .recipe-list, .upgrade-list {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important;
            }
            
            /* 技能按鈕調整 */
            #skill-1, #skill-2, #skill-3 {
                padding: 8px 4px !important;
                font-size: 0.8em !important;
                min-height: 70px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            
            #skill-1 small, #skill-2 small, #skill-3 small {
                font-size: 0.7em !important;
                margin-top: 4px;
            }
            
            /* 控制區域按鈕調整 */
            .control-area > .panel {
                padding: 8px !important;
                gap: 6px !important;
            }
            
            .control-area > .panel > div {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            
            /* 背包標籤調整 */
            .bag-category-tabs {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 8px;
                gap: 4px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .bag-category-tabs::-webkit-scrollbar {
                display: none;
            }
            
            .bag-category-tabs button {
                min-width: 70px;
                padding: 8px 4px !important;
                font-size: 0.75em !important;
                flex-shrink: 0;
                white-space: nowrap;
            }
            
            /* 商店標籤調整 */
            .shop-category-tabs {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 8px;
                gap: 4px;
            }
            
            .shop-category-tabs button {
                min-width: 70px;
                padding: 8px 4px !important;
                font-size: 0.75em !important;
                flex-shrink: 0;
            }
            
            .equipment-info {
                min-height: 100px !important;
                padding: 6px !important;
            }
        }

        @media (max-width: 480px) {
            .grid-list {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            
            .item-slot {
                min-height: 45px !important;
                max-height: 55px !important;
                font-size: 0.85em !important;
                padding: 6px !important;
            }
            
            .btn {
                padding: 14px 8px !important;
                font-size: 0.85em !important;
                min-height: 70px;
            }
            
            .enemy-sprite {
                font-size: 3.5em !important;
            }
            
            .shop-grid, .recipe-list, .upgrade-list {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
            }
            
            #skill-1, #skill-2, #skill-3 {
                font-size: 0.75em !important;
                min-height: 65px;
                padding: 6px 3px !important;
            }
            
            .bag-category-tabs button {
                min-width: 65px;
                font-size: 0.7em !important;
            }
        }

        /* 平板版佈局 */
        @media (min-width: 769px) and (max-width: 1024px) {
            #game-container {
                grid-template-columns: 1fr 1.5fr;
                grid-template-rows: auto 1fr auto auto;
            }
            
            aside:first-of-type { 
                grid-column: 1; 
                grid-row: 2; 
            }
            
            .main-stage { 
                grid-column: 2; 
                grid-row: 2; 
            }
            
            .control-area { 
                grid-column: 1 / span 2; 
                grid-row: 3; 
            }
            
            aside:last-of-type { 
                grid-column: 1 / span 2; 
                grid-row: 4; 
            }
            
            .control-area > .panel {
                padding: 10px !important;
            }
            
            #skill-1, #skill-2, #skill-3 {
                padding: 10px 6px !important;
                font-size: 0.85em !important;
            }
            
            .bag-category-tabs {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 8px;
                gap: 4px;
            }
            
            .bag-category-tabs button {
                min-width: 70px;
                padding: 8px 4px !important;
                font-size: 0.8em !important;
                flex-shrink: 0;
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <header class="panel header">
        <div style="font-size:1.2em; font-weight:bold; color:var(--accent);">⚔️ 幻想冒險 <span style="font-size:0.6em;">V7.3</span></div>
        <div style="font-size:0.9em;">Lv.<span id="ui-level">1</span> | 深度: <span id="ui-depth">0</span> 層 | 金幣: <span id="ui-gold" style="color:#ffd700">50</span> G</div>
    </header>

    <aside class="panel">
        <div style="text-align:center; font-size:3em; margin-bottom:8px;" id="ui-avatar">👤</div>
        <h2 id="ui-class" style="text-align:center; margin:0 0 8px 0; color:var(--accent); font-size:1em;">請選擇職業</h2>
        
        <div class="stat-label">經驗值 EXP</div>
        <div class="bar-container"><div id="exp-bar" class="bar-fill" style="background:var(--accent);"></div><div id="exp-text" class="bar-text">0/100</div></div>
        
        <div class="stat-label">生命值 HP</div>
        <div class="bar-container"><div id="hp-bar" class="bar-fill hp-fill"></div><div id="hp-text" class="bar-text">100/100</div></div>
        
        <div class="stat-label">魔力值 MP</div>
        <div class="bar-container"><div id="mp-bar" class="bar-fill mp-fill"></div><div id="mp-text" class="bar-text">100/100</div></div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin-top:15px;">
            <div style="text-align:center; background:#222; padding:6px; border-radius:5px;">
                <div style="font-size:0.6em; color:#666;">攻擊力</div>
                <div id="ui-atk" style="font-size:1em; font-weight:bold;">10</div>
            </div>
            <div style="text-align:center; background:#222; padding:6px; border-radius:5px;">
                <div style="font-size:0.6em; color:#666;">防禦力</div>
                <div id="ui-def" style="font-size:1em; font-weight:bold;">0</div>
            </div>
            <div style="text-align:center; background:#222; padding:6px; border-radius:5px; grid-column: 1 / -1;">
                <div style="font-size:0.6em; color:#666;">暴擊率</div>
                <div id="ui-crit" style="font-size:1em; font-weight:bold;">5%</div>
            </div>
        </div>
        <div class="equipment-info">
            <div style="color:#666; margin-bottom:4px;">目前裝備</div>
            <div class="equipment-item">
                <div id="ui-weapon" style="color:var(--r-rare); font-size:0.8em;">武器: - 無 -</div>
                <div id="weapon-desc" style="font-size:0.6em; color:#888;">無效果</div>
            </div>
            <div class="equipment-item">
                <div id="ui-armor" style="color:var(--r-rare); font-size:0.8em;">盔甲: - 無 -</div>
                <div id="armor-desc" style="font-size:0.6em; color:#888;">無效果</div>
            </div>
        </div>
    </aside>

    <main class="panel main-stage" id="stage">
        <div id="adventure-page" class="stage-page active">
            <div id="enemy-sprite" class="enemy-sprite">🌲</div>
            
            <div id="event-name" style="font-size:1.5em; font-weight:bold; text-align:center;">冒險者,歡迎</div>
            <div id="event-desc" style="color:#888; margin-top:6px; text-align:center; max-width:90%; font-size:0.85em;">在右側選擇你的出身,開始這段傳奇...</div>
        </div>

        <div id="boss-warning" class="boss-warning" style="display:none; width:90%; position: absolute; top: 15px; left: 50%; transform: translateX(-50%);">
            <div class="boss-warning-title">⚡ BOSS 來臨 ⚡</div>
            <div style="color:#ffab00; font-size:0.8em;">這是第 <span id="boss-number">0</span> 尊 Boss！</div>
        </div>
        
        <div id="enemy-panel" class="enemy-ui" style="display:none; position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);">
            <div class="enemy-stats">
                <span>⚔️ ATK: <span id="enemy-atk">0</span></span>
                <span id="enemy-hp-text">0/0</span>
            </div>
            <div class="bar-container" style="height:10px;"><div id="enemy-hp-bar" class="bar-fill hp-fill"></div></div>
        </div>

        <div id="shop-page" class="shop-page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">🏪 商店</h2>
                <button class="btn" onclick="Game.closeShop()" style="padding:5px 10px; font-size:0.75em;">← 返回</button>
            </div>
            <div class="shop-category-tabs">
                <button class="btn active" onclick="UI.switchShopCategory('potion')">🧪 藥水</button>
                <button class="btn" onclick="UI.switchShopCategory('weapon')">⚔️ 武器</button>
                <button class="btn" onclick="UI.switchShopCategory('armor')">🛡️ 盔甲</button>
                <button class="btn" onclick="UI.switchShopCategory('material')">📦 素材</button>
            </div>
            <div id="shop-potion" class="shop-grid shop-category active"></div>
            <div id="shop-weapon" class="shop-grid shop-category"></div>
            <div id="shop-armor" class="shop-grid shop-category"></div>
            <div id="shop-material" class="shop-grid shop-category"></div>
        </div>

        <div id="forge-page" class="forge-page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">⚒️ 鍛造場</h2>
                <button class="btn" onclick="Game.closeForge()" style="padding:5px 10px; font-size:0.75em;">← 返回</button>
            </div>
            <div id="recipe-list" class="recipe-list"></div>
        </div>

        <div id="upgrade-page" class="upgrade-page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">🔧 進化台</h2>
                <button class="btn" onclick="Game.closeUpgrade()" style="padding:5px 10px; font-size:0.75em;">← 返回</button>
            </div>
            <div id="upgrade-list" class="upgrade-list"></div>
        </div>
        
        <!-- 新增寶箱界面 -->
        <div id="chest-page" class="chest-page" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">🎁 神秘寶箱</h2>
            </div>
            <div id="chest-content" style="text-align:center;">
                <div id="chest-icon" style="font-size:5em; margin:20px 0;">🎁</div>
                <div id="chest-message" style="font-size:1.1em; margin-bottom:20px;">你發現了一個神秘寶箱！要打開它嗎？</div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-exp" onclick="Chest.open()" style="flex:1; padding:12px;">打開寶箱</button>
                    <button class="btn" onclick="Chest.skip()" style="flex:1; padding:12px;">忽略寶箱</button>
                </div>
            </div>
        </div>
        
        <!-- 新增隨機事件頁面 -->
        <div id="event-page" class="event-page" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">🎲 隨機事件</h2>
            </div>
            <div id="event-content" style="text-align:center;">
                <div id="event-icon" style="font-size:5em; margin:20px 0;">🎲</div>
                <div id="event-name" style="font-size:1.5em; font-weight:bold; margin-bottom:10px;">隨機事件</div>
                <div id="event-desc" style="font-size:1.1em; margin-bottom:20px;">你遇到了一個隨機事件</div>
                <div id="event-result" style="margin-bottom:20px;"></div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-exp" onclick="RandomEvent.process()" style="flex:1; padding:12px;">繼續</button>
                    <button class="btn" onclick="RandomEvent.skip()" style="flex:1; padding:12px;">跳過</button>
                </div>
            </div>
        </div>
    </main>

    <section class="control-area">
        <div class="panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; padding:5px;">
            <button class="btn skill-btn" id="skill-1" onclick="Combat.useSkill(1)">
                <div>強力擊</div>
                <small id="sk1-val" style="color:var(--accent); font-size:0.7em">0</small>
            </button>
            <button class="btn skill-btn" id="skill-2" onclick="Combat.useSkill(2)">
                <div>治癒術</div>
                <small id="sk2-val" style="color:var(--success); font-size:0.7em">0</small>
            </button>
            <button class="btn skill-btn" id="skill-3" onclick="Combat.useSkill(3)">
                <div>雷鳴斬</div>
                <small id="sk3-val" style="color:var(--mana); font-size:0.7em">0</small>
            </button>
        </div>
        <div class="panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; padding:5px;">
            <button id="btn-explore" class="btn btn-exp" onclick="Game.explore()">🐾 冒險</button>
            <button id="btn-attack" class="btn btn-atk" onclick="Combat.playerAttack()" disabled>⚔️ 攻擊</button>
            <button id="btn-flee" class="btn" onclick="Combat.flee()" disabled>🏃 逃跑</button>
        </div>
        <div class="panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; padding:5px;">
            <button id="btn-shop" class="btn btn-shop" onclick="Game.openShop()">🏪 商店</button>
            <button id="btn-craft" class="btn btn-craft" onclick="Game.openForge()">⚒️ 鍛造</button>
            <button id="btn-upgrade" class="btn btn-upgrade" onclick="Game.openUpgrade()">🔧 進化</button>
        </div>
        <div id="combat-warning" style="display: none; color: #ff9800; font-size: 0.75em; text-align: center; margin-top: 5px;">戰鬥中無法進入商店、鍛造或進化</div>
    </section>

    <aside class="panel" style="min-height: 0; overflow: hidden; display: flex; flex-direction: column;">
        <div class="tabs-container">
            <button class="btn active" onclick="UI.switchTab('bag', this)">🎒 背包</button>
            <button class="btn" onclick="UI.switchTab('log', this)">📜 日誌</button>
        </div>
        
        <div id="bag-tab" class="tab-content active">
            <div class="bag-category-tabs">
                <button class="btn active" onclick="UI.switchBagCategory('all')">📦 全部</button>
                <button class="btn" onclick="UI.switchBagCategory('potion')">🧪 藥水</button>
                <button class="btn" onclick="UI.switchBagCategory('weapon')">⚔️ 武器</button>
                <button class="btn" onclick="UI.switchBagCategory('armor')">🛡️ 盔甲</button>
                <button class="btn" onclick="UI.switchBagCategory('material')">🔧 素材</button>
            </div>
            <div class="grid-list" id="bag-grid"></div>
        </div>
        <div id="log-tab" class="tab-content"></div>
    </aside>
</div>

<div id="item-modal" class="modal-overlay">
    <div class="modal-box">
        <div id="m-icon" style="font-size:3em;"></div>
        <h2 id="m-title" style="font-size:1.1em; margin: 5px 0;"></h2>
        <div id="m-rarity" style="margin-bottom:6px; font-weight:bold; font-size:0.8em;"></div>
        <p id="m-desc" style="color:#aaa; margin-bottom:10px; font-size:0.8em;"></p>
        <div id="m-stats" style="margin-bottom:10px; font-size:0.8em; color:#ccc;"></div>
        <div style="display:flex; gap:6px;">
            <button class="btn" style="flex:1" onclick="UI.closeModal()">關閉</button>
            <button id="m-action" class="btn btn-exp" style="flex:1">執行</button>
        </div>
    </div>
</div>

<div id="dead-modal" class="modal-overlay">
    <div class="modal-box">
        <div style="font-size:3.5em; margin-bottom:12px;">💀</div>
        <h2 style="color:var(--danger); margin-bottom:6px; font-size:1.3em;">冒險者戰死</h2>
        <p style="color:#aaa; margin-bottom:15px; line-height:1.5; font-size:0.85em;">
            你的傳奇止步於第 <span id="dead-depth">0</span> 層<br>
            擊敗了 <span id="dead-bosses">0</span> 個BOSS<br>
            最終等級: Lv.<span id="dead-level">1</span>
        </p>
        <div>
            <button class="restart-btn" onclick="Game.restart()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">🔄 重新開始</button>
        </div>
        <p style="color:#666; font-size:0.8em; margin-top:12px;">你的勇氣將被後世傳頌...</p>
    </div>
</div>

<div id="start-modal" class="modal-overlay" style="display:flex;">
    <div class="modal-box" style="width:90%; max-width:650px; max-height:85vh;">
        <h2 style="color:var(--accent); margin-bottom:6px; font-size:1.3em;">⚔️ 選擇你的傳奇起點</h2>
        <p style="color:#888; margin-bottom:15px; font-size:0.85em;">每個職業都有獨特的成長優勢。</p>
        
        <!-- 難度選擇 -->
        <div style="margin-bottom:15px; text-align:center;">
            <div style="color:#aaa; margin-bottom:5px; font-size:0.9em;">選擇難度：</div>
            <div style="display:flex; gap:8px; justify-content:center;">
                <button id="difficulty-easy" class="btn" onclick="Game.setDifficulty('easy')" style="padding:6px 12px; font-size:0.8em; background:#2e7d32;">簡單</button>
                <button id="difficulty-normal" class="btn active" onclick="Game.setDifficulty('normal')" style="padding:6px 12px; font-size:0.8em; background:#006064;">普通</button>
                <button id="difficulty-hard" class="btn" onclick="Game.setDifficulty('hard')" style="padding:6px 12px; font-size:0.8em; background:#c62828;">困難</button>
            </div>
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">
            <div class="btn class-card" onclick="startGame('knight')">
                <div style="font-size:2.2em;">⚔️</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">騎士</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>❤️ HP: 180</div>
                        <div>⚡ MP: 80</div>
                        <div>⚔️ ATK: 12 | 🛡️ DEF: 2</div>
                        <div style="color:#888; margin-top:5px;">防禦力強,生存能力最高</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="startGame('thief')">
                <div style="font-size:2.2em;">🗡️</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">盜賊</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>❤️ HP: 110</div>
                        <div>⚡ MP: 100</div>
                        <div>⚔️ ATK: 18 | 暴擊: 15%</div>
                        <div style="color:#888; margin-top:5px;">高傷害與暴擊,攻速迅捷</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="startGame('mage')">
                <div style="font-size:2.2em;">🧙</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">法師</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>❤️ HP: 90</div>
                        <div>⚡ MP: 200</div>
                        <div>⚔️ ATK: 10</div>
                        <div style="color:#888; margin-top:5px;">魔法豐沛,技能無限施放</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="startGame('ranger')">
                <div style="font-size:2.2em;">🏹</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">獵人</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>❤️ HP: 130</div>
                        <div>⚡ MP: 120</div>
                        <div>⚔️ ATK: 16 | 暴擊: 12%</div>
                        <div style="color:#888; margin-top:5px;">均衡發展,穩定輸出</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="showPasswordModal()">
                <div style="font-size:2.2em;">👑</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">上帝</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>❤️ HP: 10000</div>
                        <div>⚡ MP: 10000</div>
                        <div>⚔️ ATK: 1000 | 🛡️ DEF: 100</div>
                        <div style="color:#888; margin-top:5px;">全能的神明，擁有無限的力量</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="password-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <div style="font-size:3em; margin-bottom:10px;">🔒</div>
        <h2 style="color:var(--accent); margin-bottom:10px;">輸入密碼解鎖上帝模式</h2>
        <input type="password" id="password-input" class="password-input" placeholder="輸入密碼">
        <div class="password-error" id="password-error"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn" style="flex:1" onclick="checkPassword()">確認</button>
            <button class="btn" style="flex:1" onclick="hidePasswordModal()">取消</button>
        </div>
    </div>
</div>

<script>
    // 遊戲全局變量
    let isCombatAction = false;
    let currentBagCategory = 'all';
    let currentShopCategory = 'potion';
    let gameDifficulty = 'normal'; // 預設為普通難度
    let isOpeningChest = false; // 防止寶箱重複開啟
    let isProcessingEvent = false; // 防止事件重複處理

    // 密碼驗證相關
    const GOD_PASSWORDS = ['940516', '991103'];
    let passwordAttempts = 0;
    const MAX_PASSWORD_ATTEMPTS = 5;

    // 難度係數
    const DIFFICULTY_MODIFIERS = {
        easy: {
            monsterGrowth: 0.04, // 怪物成長係數
            playerDamageMultiplier: 1.3, // 玩家傷害加成
            monsterDamageMultiplier: 0.7, // 怪物傷害降低
            goldMultiplier: 1.5, // 金幣獲得加成
            expMultiplier: 1.5, // 經驗獲得加成
            chestChance: 0.2, // 寶箱出現機率（改為平均5層觸發一次）
            eventChance: 0.2 // 隨機事件機率（改為平均5層觸發一次）
        },
        normal: {
            monsterGrowth: 0.08,
            playerDamageMultiplier: 1.0,
            monsterDamageMultiplier: 1.0,
            goldMultiplier: 1.0,
            expMultiplier: 1.0,
            chestChance: 0.2, // 改為平均5層觸發一次
            eventChance: 0.2 // 改為平均5層觸發一次
        },
        hard: {
            monsterGrowth: 0.12,
            playerDamageMultiplier: 0.8,
            monsterDamageMultiplier: 1.3,
            goldMultiplier: 0.7,
            expMultiplier: 0.8,
            chestChance: 0.2, // 改為平均5層觸發一次
            eventChance: 0.2 // 改為平均5層觸發一次
        }
    };

    // 擴展的遊戲數據庫
    const DB = {
        monsters: [
            // 初級怪物
            { name: "史萊姆", hp: 30, atk: 4, icon: "🟢", rarity: 1 },
            { name: "小蝙蝠", hp: 25, atk: 5, icon: "🦇", rarity: 1 },
            { name: "哥布林", hp: 45, atk: 7, icon: "👹", rarity: 1 },
            { name: "骷髏兵", hp: 55, atk: 9, icon: "💀", rarity: 1 },
            { name: "泥沼怪", hp: 65, atk: 8, icon: "🟤", rarity: 1 },
            
            // 中級怪物
            { name: "野狼", hp: 80, atk: 12, icon: "🐺", rarity: 2 },
            { name: "石像鬼", hp: 100, atk: 15, icon: "🗿", rarity: 2 },
            { name: "毒蜘蛛", hp: 70, atk: 18, icon: "🕷️", rarity: 2 },
            { name: "幽靈", hp: 90, atk: 14, icon: "👻", rarity: 2 },
            { name: "巨蟻", hp: 85, atk: 16, icon: "🐜", rarity: 2 },
            
            // 高級怪物
            { name: "火焰元素", hp: 150, atk: 25, icon: "🔥", rarity: 3 },
            { name: "冰霜精靈", hp: 140, atk: 22, icon: "❄️", rarity: 3 },
            { name: "雷電獸", hp: 160, atk: 28, icon: "⚡", rarity: 3 },
            { name: "岩漿怪", hp: 180, atk: 32, icon: "🌋", rarity: 3 },
            { name: "暗影豹", hp: 130, atk: 30, icon: "🐆", rarity: 3 },
            
            // 稀有怪物
            { name: "獨眼巨人", hp: 250, atk: 40, icon: "👁️", rarity: 4 },
            { name: "雙頭犬", hp: 220, atk: 35, icon: "🐕‍🦺", rarity: 4 },
            { name: "飛龍", hp: 300, atk: 45, icon: "🐲", rarity: 4 },
            { name: "海怪", hp: 280, atk: 38, icon: "🐙", rarity: 4 },
            { name: "樹精", hp: 240, atk: 33, icon: "🌳", rarity: 4 }
        ],
        
        bosses: [
            { name: "火焰之王", hp: 800, atk: 100, icon: "🔥👑", rarity: 5 },
            { name: "冰霜女皇", hp: 900, atk: 110, icon: "❄️👑", rarity: 5 },
            { name: "雷霆泰坦", hp: 1000, atk: 120, icon: "⚡👑", rarity: 5 },
            { name: "深淵領主", hp: 1200, atk: 140, icon: "👿👑", rarity: 5 },
            { name: "聖光天使", hp: 1100, atk: 130, icon: "👼👑", rarity: 5 }
        ],
        
        // 物品數據庫
        items: {
            // 藥水類
            "小型紅藥水": { type: "potion", category: "potion", effect: "hp", val: 80, price: 15, icon: "🧪", r: "common", desc: "恢復 80 HP" },
            "中型紅藥水": { type: "potion", category: "potion", effect: "hp", val: 200, price: 45, icon: "🧪", r: "rare", desc: "恢復 200 HP" },
            "大型紅藥水": { type: "potion", category: "potion", effect: "hp", val: 500, price: 100, icon: "🧪", r: "epic", desc: "恢復 500 HP" },
            "小型藍藥水": { type: "potion", category: "potion", effect: "mp", val: 60, price: 15, icon: "💧", r: "common", desc: "恢復 60 MP" },
            "中型藍藥水": { type: "potion", category: "potion", effect: "mp", val: 150, price: 40, icon: "💧", r: "rare", desc: "恢復 150 MP" },
            "大型藍藥水": { type: "potion", category: "potion", effect: "mp", val: 300, price: 80, icon: "💧", r: "epic", desc: "恢復 300 MP" },
            "全恢復藥水": { type: "potion", category: "potion", effect: "both", val: 999, price: 200, icon: "🌟", r: "epic", desc: "恢復全部HP和MP" },
            
            // 武器類 - 普通武器可在商店購買
            "木劍": { type: "weapon", category: "weapon", atk: 10, price: 30, icon: "🪵", r: "common", desc: "ATK +10" },
            "鐵劍": { type: "weapon", category: "weapon", atk: 25, price: 80, icon: "🗡️", r: "common", desc: "ATK +25" },
            "鋼鐵長劍": { type: "weapon", category: "weapon", atk: 45, price: 150, icon: "⚔️", r: "rare", desc: "ATK +45" },
            "銀製長劍": { type: "weapon", category: "weapon", atk: 65, price: 250, icon: "🔪", r: "rare", desc: "ATK +65" },
            "魔力法杖": { type: "weapon", category: "weapon", atk: 40, price: 180, icon: "🪄", r: "rare", desc: "ATK +40 (魔法加成)" },
            
            // 百分比武器 - 只能通過鍛造獲得 (craftOnly: true)
            "火焰劍": { type: "weapon", category: "weapon", atk: 85, atkPercent: 5, price: 400, icon: "🔥🗡️", r: "epic", desc: "ATK +85，攻擊力+5%", craftOnly: true },
            "冰霜之刃": { type: "weapon", category: "weapon", atk: 90, atkPercent: 8, price: 450, icon: "❄️🗡️", r: "epic", desc: "ATK +90，攻擊力+8%", craftOnly: true },
            "英雄之刃": { type: "weapon", category: "weapon", atk: 120, atkPercent: 10, price: 800, icon: "✨", r: "epic", desc: "ATK +120，攻擊力+10%", craftOnly: true },
            "聖劍艾克斯": { type: "weapon", category: "weapon", atk: 200, atkPercent: 15, price: 2000, icon: "🔱", r: "legend", desc: "ATK +200，攻擊力+15%", craftOnly: true },
            "龍牙劍": { type: "weapon", category: "weapon", atk: 180, atkPercent: 12, price: 1500, icon: "🐉🗡️", r: "legend", desc: "ATK +180，攻擊力+12%", craftOnly: true },
            
            // 盔甲類 - 普通盔甲可在商店購買
            "布衣": { type: "armor", category: "armor", hp: 20, def: 1, price: 40, icon: "👕", r: "common", desc: "HP +20, DEF +1" },
            "皮甲": { type: "armor", category: "armor", hp: 50, def: 3, price: 100, icon: "🧥", r: "common", desc: "HP +50, DEF +3" },
            "鎖子甲": { type: "armor", category: "armor", hp: 100, def: 5, price: 250, icon: "🥼", r: "rare", desc: "HP +100, DEF +5" },
            "鋼鐵盔甲": { type: "armor", category: "armor", hp: 200, def: 8, price: 500, icon: "🤖", r: "rare", desc: "HP +200, DEF +8" },
            "魔法袍": { type: "armor", category: "armor", hp: 150, def: 4, mp: 50, price: 400, icon: "🧙‍♂️", r: "rare", desc: "HP +150, DEF +4, MP +50" },
            
            // 百分比盔甲 - 只能通過鍛造獲得 (craftOnly: true)
            "龍鱗甲": { type: "armor", category: "armor", hp: 300, def: 12, price: 1000, icon: "🐉🛡️", r: "epic", desc: "HP +300, DEF +12", craftOnly: true },
            "聖騎士盔甲": { type: "armor", category: "armor", hp: 400, def: 15, price: 1500, icon: "⚜️", r: "epic", desc: "HP +400, DEF +15", craftOnly: true },
            "神聖戰甲": { type: "armor", category: "armor", hp: 500, def: 20, price: 2500, icon: "✨🛡️", r: "legend", desc: "HP +500, DEF +20", craftOnly: true },
            
            // 特殊神話裝備 - 只能通過鍛造獲得 (craftOnly: true)
            "不朽戰甲": { type: "armor", category: "armor", hp: 0, hpPercent: 25, def: 15, price: 5000, icon: "♾️🛡️", r: "mythic", desc: "神級戰甲，增加25%最大生命值和15點防禦", craftOnly: true },
            "生命之源護甲": { type: "armor", category: "armor", hp: 0, hpPercent: 15, def: 8, price: 3000, icon: "🌿🛡️", r: "mythic", desc: "神秘護甲，增加15%最大生命值和8點防禦", craftOnly: true },
            
            // 素材類 - 普通素材可在商店購買
            "木材": { type: "material", category: "material", price: 5, icon: "🪵", r: "common", desc: "基礎木材" },
            "鐵礦石": { type: "material", category: "material", price: 10, icon: "🪨", r: "common", desc: "鐵製品的原料" },
            "銅礦石": { type: "material", category: "material", price: 15, icon: "🥉", r: "common", desc: "銅製品的原料" },
            "銀礦石": { type: "material", category: "material", price: 30, icon: "🥈", r: "common", desc: "銀製品的原料" },
            "金礦石": { type: "material", category: "material", price: 50, icon: "🥇", r: "rare", desc: "金製品的原料" },
            "獸皮": { type: "material", category: "material", price: 8, icon: "🐺", r: "common", desc: "野獸的皮毛" },
            "尖牙": { type: "material", category: "material", price: 12, icon: "🦷", r: "common", desc: "怪物的尖牙" },
            "爪子": { type: "material", category: "material", price: 15, icon: "🐾", r: "common", desc: "怪物的利爪" },
            "羽毛": { type: "material", category: "material", price: 10, icon: "🪶", r: "common", desc: "鳥類的羽毛" },
            "魔法結晶": { type: "material", category: "material", price: 40, icon: "💎", r: "rare", desc: "蘊含魔力的晶體" },
            "靈魂碎片": { type: "material", category: "material", price: 60, icon: "👻", r: "rare", desc: "怪物靈魂的碎片" },
            "火焰之心": { type: "material", category: "material", price: 80, icon: "❤️‍🔥", r: "rare", desc: "火焰元素的精華" },
            "冰霜核心": { type: "material", category: "material", price: 80, icon: "❄️", r: "rare", desc: "冰霜元素的精華" },
            "雷電之核": { type: "material", category: "material", price: 80, icon: "⚡", r: "rare", desc: "雷電元素的精華" },
            "強化寶石": { type: "material", category: "material", price: 100, icon: "💎", r: "rare", desc: "用於強化裝備" },
            
            // 稀有素材 - 只能通過掉落獲得 (craftOnly: true)
            "龍鱗": { type: "material", category: "material", price: 150, icon: "🐉", r: "epic", desc: "傳說生物的鱗片", craftOnly: true },
            "鳳凰之羽": { type: "material", category: "material", price: 200, icon: "🦚", r: "epic", desc: "鳳凰的神聖羽毛", craftOnly: true },
            "惡魔角": { type: "material", category: "material", price: 180, icon: "👿", r: "epic", desc: "惡魔的角", craftOnly: true },
            "天使之羽": { type: "material", category: "material", price: 250, icon: "👼", r: "legend", desc: "天使的純白羽毛", craftOnly: true },
            "星辰碎片": { type: "material", category: "material", price: 300, icon: "⭐", r: "legend", desc: "墜落星辰的碎片", craftOnly: true },
            "神之血": { type: "material", category: "material", price: 500, icon: "🩸", r: "mythic", desc: "神明的血液", craftOnly: true },
            
            // 護符類 - 改為只能通過鍛造獲得 (craftOnly: true)
            "力量護符": { type: "buff", category: "material", stat: "atk", val: 10, price: 0, icon: "💍", r: "rare", desc: "永久 ATK +10", craftOnly: true },
            "防禦護符": { type: "buff", category: "material", stat: "def", val: 5, price: 0, icon: "🛡️", r: "rare", desc: "永久 DEF +5", craftOnly: true },
            "生命護符": { type: "buff", category: "material", stat: "maxHp", val: 50, price: 0, icon: "❤️", r: "rare", desc: "永久 MaxHP +50", craftOnly: true },
            "魔力護符": { type: "buff", category: "material", stat: "maxMp", val: 30, price: 0, icon: "🌀", r: "rare", desc: "永久 MaxMP +30", craftOnly: true },
            "暴擊寶珠": { type: "buff", category: "material", stat: "crit", val: 8, price: 0, icon: "✨", r: "epic", desc: "暴擊率 +8%", craftOnly: true },
            
            // 上帝模式專屬裝備
            "神怒之刃": { type: "weapon", category: "weapon", atk: 150, atkPercent: 20, price: 0, icon: "⚡🗡️", r: "mythic", desc: "神明憤怒的武器，增加150點攻擊力和20%攻擊力", godOnly: true },
            "不朽戰甲": { type: "armor", category: "armor", hp: 0, hpPercent: 25, def: 15, price: 0, icon: "♾️🛡️", r: "mythic", desc: "神級戰甲，增加25%最大生命值和15點防禦", godOnly: true },
            "生命之源護甲": { type: "armor", category: "armor", hp: 0, hpPercent: 15, def: 8, price: 0, icon: "🌿🛡️", r: "mythic", desc: "神秘護甲，增加15%最大生命值和8點防禦", godOnly: true }
        },
        
        // 合成配方
        recipes: [
            {
                id: 1,
                name: "鐵劍",
                icon: "🗡️",
                result: "鐵劍",
                desc: "基礎武器，增加25點攻擊力",
                materials: [
                    { name: "鐵礦石", amount: 5 },
                    { name: "木材", amount: 3 }
                ]
            },
            {
                id: 2,
                name: "鋼鐵長劍",
                icon: "⚔️",
                result: "鋼鐵長劍",
                desc: "堅固的鋼劍，增加45點攻擊力",
                materials: [
                    { name: "鐵礦石", amount: 8 },
                    { name: "銅礦石", amount: 3 },
                    { name: "獸皮", amount: 2 }
                ]
            },
            {
                id: 3,
                name: "鎖子甲",
                icon: "🥼",
                result: "鎖子甲",
                desc: "防護盔甲，增加100HP和5點防禦",
                materials: [
                    { name: "鐵礦石", amount: 10 },
                    { name: "銅礦石", amount: 5 },
                    { name: "獸皮", amount: 3 }
                ]
            },
            {
                id: 4,
                name: "龍鱗甲",
                icon: "🐉🛡️",
                result: "龍鱗甲",
                desc: "傳說龍鱗製成的盔甲，增加300HP和12點防禦",
                materials: [
                    { name: "龍鱗", amount: 5 },
                    { name: "金礦石", amount: 10 },
                    { name: "魔法結晶", amount: 8 }
                ]
            },
            {
                id: 5,
                name: "火焰劍",
                icon: "🔥🗡️",
                result: "火焰劍",
                desc: "附魔火焰之劍，增加85點攻擊力和5%攻擊力",
                materials: [
                    { name: "鐵礦石", amount: 10 },
                    { name: "火焰之心", amount: 3 },
                    { name: "魔法結晶", amount: 2 }
                ]
            },
            {
                id: 6,
                name: "生命之源護甲",
                icon: "🌿🛡️",
                result: "生命之源護甲",
                desc: "神秘護甲，增加15%最大生命值和8點防禦",
                materials: [
                    { name: "天使之羽", amount: 2 },
                    { name: "星辰碎片", amount: 3 },
                    { name: "魔法結晶", amount: 10 },
                    { name: "神之血", amount: 1 }
                ]
            },
            {
                id: 7,
                name: "不朽戰甲",
                icon: "♾️🛡️",
                result: "不朽戰甲",
                desc: "神級戰甲，增加25%最大生命值和15點防禦",
                materials: [
                    { name: "神之血", amount: 3 },
                    { name: "星辰碎片", amount: 5 },
                    { name: "龍鱗", amount: 10 },
                    { name: "鳳凰之羽", amount: 5 }
                ]
            },
            {
                id: 8,
                name: "聖劍艾克斯",
                icon: "🔱",
                result: "聖劍艾克斯",
                desc: "神聖傳說之劍，增加200點攻擊力和15%攻擊力",
                materials: [
                    { name: "天使之羽", amount: 2 },
                    { name: "星辰碎片", amount: 3 },
                    { name: "金礦石", amount: 8 },
                    { name: "魔法結晶", amount: 5 }
                ]
            },
            {
                id: 9,
                name: "冰霜之刃",
                icon: "❄️🗡️",
                result: "冰霜之刃",
                desc: "寒冰附魔之劍，增加90點攻擊力和8%攻擊力",
                materials: [
                    { name: "銀製長劍", amount: 1 },
                    { name: "冰霜核心", amount: 5 },
                    { name: "魔法結晶", amount: 8 }
                ]
            },
            {
                id: 10,
                name: "英雄之刃",
                icon: "✨",
                result: "英雄之刃",
                desc: "英雄的武器，增加120點攻擊力和10%攻擊力",
                materials: [
                    { name: "鋼鐵長劍", amount: 1 },
                    { name: "龍鱗", amount: 3 },
                    { name: "星辰碎片", amount: 2 },
                    { name: "強化寶石", amount: 5 }
                ]
            },
            // 新增護符配方
            {
                id: 11,
                name: "力量護符",
                icon: "💍",
                result: "力量護符",
                desc: "永久增加10點攻擊力",
                materials: [
                    { name: "金礦石", amount: 5 },
                    { name: "魔法結晶", amount: 3 },
                    { name: "強化寶石", amount: 2 }
                ]
            },
            {
                id: 12,
                name: "防禦護符",
                icon: "🛡️",
                result: "防禦護符",
                desc: "永久增加5點防禦力",
                materials: [
                    { name: "銀礦石", amount: 5 },
                    { name: "獸皮", amount: 3 },
                    { name: "強化寶石", amount: 2 }
                ]
            },
            {
                id: 13,
                name: "生命護符",
                icon: "❤️",
                result: "生命護符",
                desc: "永久增加50點最大生命值",
                materials: [
                    { name: "金礦石", amount: 3 },
                    { name: "魔法結晶", amount: 5 },
                    { name: "強化寶石", amount: 3 }
                ]
            },
            {
                id: 14,
                name: "魔力護符",
                icon: "🌀",
                result: "魔力護符",
                desc: "永久增加30點最大魔力值",
                materials: [
                    { name: "銀礦石", amount: 3 },
                    { name: "魔法結晶", amount: 8 },
                    { name: "強化寶石", amount: 3 }
                ]
            },
            {
                id: 15,
                name: "暴擊寶珠",
                icon: "✨",
                result: "暴擊寶珠",
                desc: "永久增加8%暴擊率",
                materials: [
                    { name: "金礦石", amount: 10 },
                    { name: "星辰碎片", amount: 2 },
                    { name: "強化寶石", amount: 5 }
                ]
            }
        ],
        
        // 強化規則
        enhancementRules: {
            // 每次強化增加的屬性
            weapon: {
                atk: 5, // 每次強化增加5點攻擊力
                atkPercent: 1, // 每次強化增加1%攻擊力
                costMultiplier: 100, // 基礎金幣消耗
                materialCost: 2, // 每次強化需要的強化寶石數量
                successRate: [100, 90, 80, 70, 60, 50, 40, 30, 20, 10] // 強化等級0-9的成功率
            },
            armor: {
                hp: 20, // 每次強化增加20HP
                def: 2, // 每次強化增加2點防禦
                hpPercent: 0.5, // 每次強化增加0.5%生命值
                costMultiplier: 80,
                materialCost: 2,
                successRate: [100, 90, 80, 70, 60, 50, 40, 30, 20, 10]
            }
        },
        
        // 寶箱獎勵與懲罰
        chestRewards: {
            good: [
                { type: "gold", amount: 500, message: "發現了 500 金幣！", icon: "💰" },
                { type: "exp", amount: 100, message: "獲得 100 經驗值！", icon: "⭐" },
                { type: "item", item: "大型紅藥水", message: "發現了 大型紅藥水！", icon: "🧪" },
                { type: "item", item: "大型藍藥水", message: "發現了 大型藍藥水！", icon: "💧" },
                { type: "material", item: "強化寶石", amount: 10, message: "發現了 10 個強化寶石！", icon: "💎" },
                { type: "material", item: "金礦石", amount: 5, message: "發現了 5 個金礦石！", icon: "🥇" },
                { type: "buff", stat: "atk", val: 5, message: "獲得力量祝福！攻擊力永久 +5", icon: "💪" },
                { type: "buff", stat: "maxHp", val: 50, message: "獲得生命祝福！最大生命值永久 +50", icon: "❤️" }
            ],
            bad: [
                { type: "damage", amount: 30, message: "寶箱爆炸！受到 30 點傷害", icon: "💥" },
                { type: "curse", stat: "atk", val: -5, message: "被詛咒了！攻擊力永久 -5", icon: "👹" },
                { type: "trap", damage: 50, message: "觸發陷阱！受到 50 點傷害", icon: "⚠️" },
                { type: "goldLoss", amount: 200, message: "寶箱是空的，還損失了 200 金幣", icon: "😭" },
                { type: "poison", damage: 20, duration: 3, message: "中毒了！每回合受到 20 點傷害，持續 3 回合", icon: "☠️" },
                { type: "confusion", message: "陷入混亂！下回合攻擊可能失誤", icon: "🌀" }
            ]
        },
        
        // 隨機事件
        randomEvents: [
            // 壞事件
            {
                name: "跌落山谷",
                icon: "🪨",
                desc: "你不小心跌落山谷，受到了一些傷害。",
                type: "bad",
                effect: function() {
                    const damage = Math.floor(Player.maxHp * 0.15);
                    Player.hp = Math.max(1, Player.hp - damage);
                    UI.log(`跌落山谷，受到 ${damage} 點傷害！`);
                    return `你跌落山谷，受到 ${damage} 點傷害！`;
                }
            },
            {
                name: "遭遇陷阱",
                icon: "⚠️",
                desc: "你不小心觸發了陷阱，受到了傷害。",
                type: "bad",
                effect: function() {
                    const damage = Math.floor(Player.maxHp * 0.1);
                    Player.hp = Math.max(1, Player.hp - damage);
                    UI.log(`觸發陷阱，受到 ${damage} 點傷害！`);
                    return `你觸發了陷阱，受到 ${damage} 點傷害！`;
                }
            },
            {
                name: "迷路",
                icon: "🌀",
                desc: "你在迷宮中迷路了，浪費了一些時間。",
                type: "bad",
                effect: function() {
                    UI.log("你在迷宮中迷路了，浪費了一些時間。");
                    return "你在迷宮中迷路了，浪費了一些時間。";
                }
            },
            
            // 好事件
            {
                name: "神明保佑",
                icon: "👼",
                desc: "你感受到了神明的祝福，獲得了金幣和素材。",
                type: "good",
                effect: function() {
                    const gold = 200 + Math.floor(Math.random() * 300);
                    Player.gold += gold;
                    
                    // 獲得隨機稀有素材
                    const rareMats = ["龍鱗", "鳳凰之羽", "星辰碎片", "天使之羽", "神之血"];
                    const mat = rareMats[Math.floor(Math.random() * rareMats.length)];
                    Game.addMaterial(mat, 1 + Math.floor(Math.random() * 2));
                    
                    UI.log(`神明保佑，獲得 ${gold} 金幣和 ${mat}！`);
                    return `神明保佑，獲得 ${gold} 金幣和 ${mat}！`;
                }
            },
            {
                name: "發現寶藏",
                icon: "💎",
                desc: "你在路上發現了一個隱藏的寶藏。",
                type: "good",
                effect: function() {
                    const gold = 500 + Math.floor(Math.random() * 1000);
                    Player.gold += gold;
                    UI.log(`發現寶藏，獲得 ${gold} 金幣！`);
                    return `發現寶藏，獲得 ${gold} 金幣！`;
                }
            },
            {
                name: "神秘商人",
                icon: "🛒",
                desc: "你遇到了一位神秘商人，他低價賣給你一些好東西。",
                type: "good",
                effect: function() {
                    const items = ["中型紅藥水", "中型藍藥水", "強化寶石", "魔法結晶"];
                    const item = items[Math.floor(Math.random() * items.length)];
                    const amount = 3 + Math.floor(Math.random() * 5);
                    
                    if (DB.items[item].type === "material") {
                        Game.addMaterial(item, amount);
                    } else {
                        for (let i = 0; i < amount; i++) {
                            Game.addItem(item);
                        }
                    }
                    
                    UI.log(`神秘商人賣給你 ${item} x${amount}！`);
                    return `神秘商人賣給你 ${item} x${amount}！`;
                }
            },
            
            // 中性事件
            {
                name: "休息點",
                icon: "🌿",
                desc: "你發現了一個安全的休息點，恢復了一些生命值。",
                type: "neutral",
                effect: function() {
                    const heal = Math.floor(Player.maxHp * 0.3);
                    Player.hp = Math.min(Player.maxHp, Player.hp + heal);
                    UI.log(`在休息點恢復了 ${heal} HP！`);
                    return `在休息點恢復了 ${heal} HP！`;
                }
            },
            {
                name: "神秘泉水",
                icon: "💧",
                desc: "你發現了一處神秘的泉水，恢復了一些魔力值。",
                type: "neutral",
                effect: function() {
                    const mana = Math.floor(Player.maxMp * 0.4);
                    Player.mp = Math.min(Player.maxMp, Player.mp + mana);
                    UI.log(`飲用神秘泉水恢復了 ${mana} MP！`);
                    return `飲用神秘泉水恢復了 ${mana} MP！`;
                }
            }
        ]
    };

    // 玩家狀態
    const Player = {
        hp: 100, maxHp: 100, mp: 100, maxMp: 100,
        atk: 10, crit: 5, def: 0, gold: 50,
        depth: 0, level: 1, exp: 0, maxExp: 100,
        bag: [], weapon: null, armor: null, class: "",
        materials: {},
        baseMaxHp: 100,
        baseAtk: 10,
        baseDef: 0,
        equipmentHpBonus: 0,
        equipmentHpPercent: 0,
        equipmentAtkPercent: 0,
        equipmentDefBonus: 0,
        // 新增狀態效果
        buffs: [],
        debuffs: []
    };

    // 遊戲主邏輯
    const Game = {
        state: "idle",
        enemy: null,
        bossCount: 0,
        currentPage: "adventure",
        chestActive: false,
        eventActive: false,

        init(clsId) {
            // 職業初始化
            if(clsId === 'knight'){ 
                Player.class = "騎士"; 
                Player.maxHp = 180; Player.hp = 180; 
                Player.baseMaxHp = 180;
                Player.atk = 12; Player.def = 2; // 騎士防禦2
                Player.baseAtk = 12;
                Player.baseDef = 2;
                Player.maxMp = 80; Player.mp = 80; 
            }
            else if(clsId === 'thief'){ 
                Player.class = "盜賊"; 
                Player.maxHp = 110; Player.hp = 110;
                Player.baseMaxHp = 110;
                Player.atk = 18; Player.crit = 15; 
                Player.def = 0; // 盜賊無防禦
                Player.baseAtk = 18;
                Player.baseDef = 0;
                Player.maxMp = 100; Player.mp = 100; 
            }
            else if(clsId === 'mage'){ 
                Player.class = "法師"; 
                Player.maxHp = 90; Player.hp = 90;
                Player.baseMaxHp = 90;
                Player.atk = 10; 
                Player.def = 0; // 法師無防禦
                Player.baseAtk = 10;
                Player.baseDef = 0;
                Player.maxMp = 200; Player.mp = 200; 
            }
            else if(clsId === 'ranger'){ 
                Player.class = "獵人"; 
                Player.maxHp = 130; Player.hp = 130;
                Player.baseMaxHp = 130;
                Player.atk = 16; Player.crit = 12; 
                Player.def = 0; // 獵人無防禦
                Player.baseAtk = 16;
                Player.baseDef = 0;
                Player.maxMp = 120; Player.mp = 120; 
            }
            else if(clsId === 'god'){ 
                Player.class = "上帝"; 
                Player.maxHp = 10000; Player.hp = 10000; 
                Player.baseMaxHp = 10000;
                Player.atk = 1000; 
                Player.baseAtk = 1000;
                Player.def = 100;
                Player.baseDef = 100;
                Player.crit = 50;
                Player.maxMp = 10000; Player.mp = 10000; 
                Player.gold = 999999;
                
                // 添加所有藥水各999個
                const potions = ["小型紅藥水", "中型紅藥水", "大型紅藥水", "小型藍藥水", "中型藍藥水", "大型藍藥水", "全恢復藥水"];
                potions.forEach(potion => {
                    for (let i = 0; i < 999; i++) {
                        Player.bag.push({ name: potion, ...DB.items[potion], enhanceLevel: 0 });
                    }
                });
                
                // 添加所有素材各999個
                const materials = ["木材", "鐵礦石", "銅礦石", "銀礦石", "金礦石", "獸皮", "尖牙", "爪子", "羽毛", 
                                 "魔法結晶", "靈魂碎片", "火焰之心", "冰霜核心", "雷電之核", "龍鱗", "鳳凰之羽", 
                                 "惡魔角", "天使之羽", "星辰碎片", "神之血", "強化寶石"];
                materials.forEach(mat => {
                    Player.materials[mat] = 999;
                });
                
                // 添加所有護符各999個
                const buffs = ["力量護符", "防禦護符", "生命護符", "魔力護符", "暴擊寶珠"];
                buffs.forEach(buff => {
                    for (let i = 0; i < 999; i++) {
                        Player.bag.push({ name: buff, ...DB.items[buff], enhanceLevel: 0 });
                    }
                });
                
                // 添加上帝專屬裝備
                Player.bag.push({ name: "神怒之刃", ...DB.items["神怒之刃"], enhanceLevel: 0 });
                Player.bag.push({ name: "不朽戰甲", ...DB.items["不朽戰甲"], enhanceLevel: 0 });
                
                // 自動裝備最好的裝備
                const godWeapon = Player.bag.find(item => item.name === "神怒之刃");
                const godArmor = Player.bag.find(item => item.name === "不朽戰甲");
                
                if (godWeapon) {
                    Player.weapon = godWeapon;
                    Player.equipmentAtkPercent = godWeapon.atkPercent || 0;
                    // 從背包移除
                    Player.bag = Player.bag.filter(item => !(item.name === "神怒之刃" && item === godWeapon));
                }
                
                if (godArmor) {
                    Player.armor = godArmor;
                    if (godArmor.hp) Player.equipmentHpBonus += godArmor.hp;
                    if (godArmor.hpPercent) Player.equipmentHpPercent += godArmor.hpPercent;
                    if (godArmor.def) Player.equipmentDefBonus += godArmor.def;
                    // 從背包移除
                    Player.bag = Player.bag.filter(item => !(item.name === "不朽戰甲" && item === godArmor));
                }
                
                UI.log("⚡ 上帝模式已激活！");
            }
            
            // 重置其他狀態
            Player.depth = 0;
            Player.level = 1;
            Player.exp = 0;
            Player.maxExp = 100;
            if (clsId !== 'god') Player.gold = 50;
            if (clsId !== 'god') {
                Player.bag = [];
                Player.weapon = null;
                Player.armor = null;
                Player.materials = {};
                Player.equipmentHpBonus = 0;
                Player.equipmentHpPercent = 0;
                Player.equipmentAtkPercent = 0;
                Player.equipmentDefBonus = 0;
                Player.buffs = [];
                Player.debuffs = [];
                
                // 給初始物品
                this.addItem("小型紅藥水");
                this.addMaterial("強化寶石", 5);
            }
            
            Game.bossCount = 0;
            Game.currentPage = "adventure";
            isCombatAction = false;
            isOpeningChest = false;
            isProcessingEvent = false;
            currentBagCategory = 'all';
            currentShopCategory = 'potion';
            
            // 更新玩家屬性
            this.updatePlayerStats();
            
            document.getElementById('start-modal').style.display = 'none';
            this.next();
        },

        next() {
            this.state = "idle";
            isCombatAction = false;
            this.showPage("adventure");
            UI.renderStage("🌲", "森林小徑", "選擇冒險或鍛造...", false);
            UI.update();
            this.updateButtons();
        },

        showPage(page) {
            this.currentPage = page;
            document.getElementById('adventure-page').classList.remove('active');
            document.getElementById('shop-page').classList.remove('active');
            document.getElementById('forge-page').classList.remove('active');
            document.getElementById('upgrade-page').classList.remove('active');
            document.getElementById('chest-page').style.display = 'none';
            document.getElementById('event-page').style.display = 'none';
            
            if (page === 'chest') {
                document.getElementById('chest-page').style.display = 'block';
            } else if (page === 'event') {
                document.getElementById('event-page').style.display = 'block';
            } else {
                const pageElement = document.getElementById(page + '-page');
                if (pageElement) {
                    pageElement.classList.add('active');
                }
            }
            
            if (page === 'upgrade') {
                UI.renderUpgrade();
            }
            
            this.updateButtons();
        },

        updateButtons() {
            const inCombat = this.state === 'combat';
            const isAdventure = this.currentPage === 'adventure';
            
            document.getElementById('btn-explore').disabled = inCombat || !isAdventure;
            document.getElementById('btn-attack').disabled = !inCombat || !isAdventure;
            document.getElementById('btn-flee').disabled = !inCombat || !isAdventure;
            
            // 戰鬥中特殊處理商店、鍛造和進化按鈕
            const shopBtn = document.getElementById('btn-shop');
            const craftBtn = document.getElementById('btn-craft');
            const upgradeBtn = document.getElementById('btn-upgrade');
            
            shopBtn.disabled = inCombat;
            craftBtn.disabled = inCombat;
            upgradeBtn.disabled = inCombat;
            
            if (inCombat) {
                shopBtn.classList.add('combat-disabled');
                craftBtn.classList.add('combat-disabled');
                upgradeBtn.classList.add('combat-disabled');
                document.getElementById('combat-warning').style.display = 'block';
            } else {
                shopBtn.classList.remove('combat-disabled');
                craftBtn.classList.remove('combat-disabled');
                upgradeBtn.classList.remove('combat-disabled');
                document.getElementById('combat-warning').style.display = 'none';
            }
            
            shopBtn.innerHTML = inCombat ? '🏪 商店<br><small style="font-size:0.6em">戰鬥中</small>' : '🏪 商店';
            craftBtn.innerHTML = inCombat ? '⚒️ 鍛造<br><small style="font-size:0.6em">戰鬥中</small>' : '⚒️ 鍛造';
            upgradeBtn.innerHTML = inCombat ? '🔧 進化<br><small style="font-size:0.6em">戰鬥中</small>' : '🔧 進化';
        },

        setDifficulty(difficulty) {
            gameDifficulty = difficulty;
            
            // 更新按鈕樣式
            document.querySelectorAll('[id^="difficulty-"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`difficulty-${difficulty}`).classList.add('active');
            
            UI.log(`難度設定為：${difficulty === 'easy' ? '簡單' : difficulty === 'normal' ? '普通' : '困難'}`);
        },

        openShop() {
            if (this.state === 'combat') return;
            this.showPage("shop");
            UI.renderShop();
            UI.log("進入了商店");
        },

        closeShop() {
            this.showPage("adventure");
        },

        openForge() {
            if (this.state === 'combat') return;
            this.showPage("forge");
            UI.renderRecipes();
            UI.log("進入了鍛造場");
        },

        closeForge() {
            this.showPage("adventure");
        },

        openUpgrade() {
            if (this.state === 'combat') return;
            this.showPage("upgrade");
            UI.log("進入了進化台");
        },

        closeUpgrade() {
            this.showPage("adventure");
        },

        explore() {
            if (this.currentPage !== 'adventure') return;
            
            Player.depth++;
            UI.log(`深入到第 ${Player.depth} 層`);
            
            // 隨機事件觸發（根據難度）
            const eventChance = DIFFICULTY_MODIFIERS[gameDifficulty].eventChance;
            if (Math.random() < eventChance && Player.depth > 3) {
                this.triggerRandomEvent();
                return;
            }
            
            // 隨機遇到寶箱
            const chestChance = DIFFICULTY_MODIFIERS[gameDifficulty].chestChance;
            if (Math.random() < chestChance && Player.depth > 5) {
                this.triggerChest();
                return;
            }
            
            if (Player.depth > 0 && Player.depth % 100 === 0) {
                this.triggerBoss();
            } else {
                this.triggerCombat();
            }
        },

        triggerCombat() {
            this.state = "combat";
            const lvl = Math.max(0, Math.floor((Player.depth - 1) / 5));
            const idx = Math.min(DB.monsters.length - 1, lvl);
            const m = DB.monsters[idx];
            const growth = 1 + (Player.depth * DIFFICULTY_MODIFIERS[gameDifficulty].monsterGrowth);
            this.enemy = { 
                ...m, 
                hp: Math.floor(m.hp * growth), 
                maxHp: Math.floor(m.hp * growth),
                atk: Math.floor(m.atk * growth)
            };
            UI.renderStage(this.enemy.icon, this.enemy.name, "準備戰鬥！", true);
            this.updateButtons();
            UI.update();
        },

        triggerBoss() {
            this.state = "combat";
            this.bossCount++;
            const boss = DB.bosses[(this.bossCount - 1) % DB.bosses.length];
            const growth = 1 + (Player.depth * DIFFICULTY_MODIFIERS[gameDifficulty].monsterGrowth * 1.5);
            this.enemy = {
                ...boss,
                hp: Math.floor(boss.hp * growth),
                maxHp: Math.floor(boss.hp * growth),
                atk: Math.floor(boss.atk * growth),
                isBoss: true
            };
            document.getElementById('boss-warning').style.display = 'block';
            document.getElementById('boss-number').innerText = this.bossCount;
            UI.renderStage(this.enemy.icon, `${this.enemy.name} (BOSS)`, "強大的敵人出現！", true);
            this.updateButtons();
            UI.update();
        },

        triggerChest() {
            this.state = "idle";
            this.chestActive = true;
            isOpeningChest = false; // 重置寶箱開啟狀態
            document.getElementById('chest-icon').innerText = "🎁";
            document.getElementById('chest-message').innerText = "你發現了一個神秘寶箱！要打開它嗎？";
            document.getElementById('chest-message').style.color = "";
            
            // 啟用按鈕
            const buttons = document.querySelectorAll('#chest-content button');
            buttons.forEach(btn => btn.disabled = false);
            
            this.showPage("chest");
            UI.log("發現了一個神秘寶箱！");
        },

        triggerRandomEvent() {
            this.state = "idle";
            this.eventActive = true;
            isProcessingEvent = false; // 重置事件處理狀態
            
            const events = DB.randomEvents;
            const event = events[Math.floor(Math.random() * events.length)];
            
            document.getElementById('event-icon').innerText = event.icon;
            document.getElementById('event-name').innerText = event.name;
            document.getElementById('event-desc').innerText = event.desc;
            document.getElementById('event-result').innerHTML = "";
            
            // 啟用按鈕
            const buttons = document.querySelectorAll('#event-content button');
            buttons.forEach(btn => btn.disabled = false);
            
            this.showPage("event");
            UI.log(`遇到了隨機事件：${event.name}`);
        },

        addItem(name, count = 1) {
            if (count === 1) {
                Player.bag.push({ name, ...DB.items[name], enhanceLevel: 0 });
                UI.log(`獲得: ${name}`);
            } else {
                for (let i = 0; i < count; i++) {
                    Player.bag.push({ name, ...DB.items[name], enhanceLevel: 0 });
                }
                UI.log(`獲得: ${name} x${count}`);
            }
            UI.update();
        },

        addMaterial(name, amount = 1) {
            if (!Player.materials[name]) {
                Player.materials[name] = 0;
            }
            Player.materials[name] += amount;
            UI.log(`獲得素材: ${name} x${amount}`);
            UI.update();
        },

        removeMaterial(name, amount = 1) {
            if (Player.materials[name] && Player.materials[name] >= amount) {
                Player.materials[name] -= amount;
                if (Player.materials[name] <= 0) {
                    delete Player.materials[name];
                }
                return true;
            }
            return false;
        },

        getMaterialCount(name) {
            return Player.materials[name] || 0;
        },

        buyItem(name) {
            const item = DB.items[name];
            if (Player.gold >= item.price) {
                Player.gold -= item.price;
                if (item.category === 'material') {
                    this.addMaterial(name);
                } else {
                    this.addItem(name);
                }
                UI.log(`購買了 ${name}`);
            } else {
                UI.log("金幣不足！");
            }
        },

        craftItem(recipeId) {
            const recipe = DB.recipes.find(r => r.id === recipeId);
            if (!recipe) return false;
            
            // 檢查材料是否足夠
            for (const mat of recipe.materials) {
                if (mat.name === "銀製長劍" || mat.name === "鋼鐵長劍") {
                    // 檢查是否有這個武器
                    const weaponCount = Player.bag.filter(item => item.name === mat.name).length;
                    if (weaponCount < mat.amount) {
                        UI.log(`素材不足！需要 ${mat.name} x${mat.amount}`);
                        return false;
                    }
                } else if (this.getMaterialCount(mat.name) < mat.amount) {
                    UI.log(`素材不足！需要 ${mat.name} x${mat.amount}`);
                    return false;
                }
            }
            
            // 扣除材料
            for (const mat of recipe.materials) {
                if (mat.name === "銀製長劍" || mat.name === "鋼鐵長劍") {
                    // 從背包中移除武器
                    for (let i = 0; i < mat.amount; i++) {
                        const index = Player.bag.findIndex(item => item.name === mat.name);
                        if (index !== -1) {
                            Player.bag.splice(index, 1);
                        }
                    }
                } else {
                    this.removeMaterial(mat.name, mat.amount);
                }
            }
            
            // 檢查是否為特殊裝備
            if (recipe.result in DB.items) {
                this.addItem(recipe.result);
            } else {
                // 這是特殊裝備，直接添加到背包
                const specialItem = {
                    name: recipe.result,
                    type: recipe.type || "armor",
                    category: recipe.type || "armor",
                    icon: recipe.icon,
                    r: recipe.r || "rare",
                    desc: recipe.desc,
                    hp: recipe.hp || 0,
                    hpPercent: recipe.hpPercent || 0,
                    def: recipe.def || 0,
                    atk: recipe.atk || 0,
                    atkPercent: recipe.atkPercent || 0,
                    isSpecial: true,
                    enhanceLevel: 0
                };
                Player.bag.push(specialItem);
            }
            
            UI.log(`成功鍛造了 ${recipe.name}！`);
            UI.renderRecipes();
            return true;
        },

        enhanceItem(itemIndex) {
            const item = Player.bag[itemIndex];
            if (!item || (item.type !== 'weapon' && item.type !== 'armor')) {
                UI.log("無法強化此物品");
                return false;
            }
            
            // 檢查強化等級上限
            if (item.enhanceLevel >= 9) {
                UI.log("此物品已達到最大強化等級");
                return false;
            }
            
            const rules = DB.enhancementRules[item.type];
            const cost = rules.costMultiplier * (item.enhanceLevel + 1);
            const materialNeeded = rules.materialCost;
            const successRate = rules.successRate[item.enhanceLevel];
            
            // 檢查資源
            if (Player.gold < cost) {
                UI.log(`金幣不足！需要 ${cost} G`);
                return false;
            }
            
            if (this.getMaterialCount("強化寶石") < materialNeeded) {
                UI.log(`強化寶石不足！需要 ${materialNeeded} 個`);
                return false;
            }
            
            // 扣除資源
            Player.gold -= cost;
            this.removeMaterial("強化寶石", materialNeeded);
            
            // 計算成功率
            const success = Math.random() * 100 < successRate;
            
            if (success) {
                // 強化成功
                item.enhanceLevel++;
                
                // 增加屬性
                if (item.type === 'weapon') {
                    // 保存原始基礎值（如果是第一次強化）
                    if (!item.baseAtk) item.baseAtk = item.atk || 0;
                    if (!item.baseAtkPercent) item.baseAtkPercent = item.atkPercent || 0;
                    
                    // 計算強化後的屬性
                    item.atk = (item.baseAtk || 0) + (rules.atk * item.enhanceLevel);
                    item.atkPercent = (item.baseAtkPercent || 0) + (rules.atkPercent * item.enhanceLevel);
                } else if (item.type === 'armor') {
                    // 保存原始基礎值
                    if (!item.baseHp) item.baseHp = item.hp || 0;
                    if (!item.baseDef) item.baseDef = item.def || 0;
                    if (!item.baseHpPercent) item.baseHpPercent = item.hpPercent || 0;
                    
                    // 計算強化後的屬性
                    item.hp = (item.baseHp || 0) + (rules.hp * item.enhanceLevel);
                    item.def = (item.baseDef || 0) + (rules.def * item.enhanceLevel);
                    item.hpPercent = (item.baseHpPercent || 0) + (rules.hpPercent * item.enhanceLevel);
                }
                
                UI.log(`${item.name} 強化成功！現在是 +${item.enhanceLevel}`);
                
                // 更新裝備中的物品
                if (Player.weapon && Player.weapon.name === item.name) {
                    Player.weapon = {...item};
                    this.updatePlayerStats();
                }
                if (Player.armor && Player.armor.name === item.name) {
                    Player.armor = {...item};
                    this.updatePlayerStats();
                }
                
                // 顯示特效
                const itemSlot = document.querySelectorAll('.item-slot')[itemIndex];
                if (itemSlot) {
                    itemSlot.classList.add('enhance-success');
                    setTimeout(() => itemSlot.classList.remove('enhance-success'), 1000);
                }
            } else {
                UI.log(`${item.name} 強化失敗！`);
            }
            
            UI.renderUpgrade();
            UI.update();
            return success;
        },

        gainExp(amount) {
            const modifiedAmount = Math.floor(amount * DIFFICULTY_MODIFIERS[gameDifficulty].expMultiplier);
            Player.exp += modifiedAmount;
            UI.log(`+${modifiedAmount} EXP`);
            while (Player.exp >= Player.maxExp) {
                Player.exp -= Player.maxExp;
                Player.level++;
                Player.maxExp = Math.floor(Player.maxExp * 1.5);
                
                // 職業成長
                if(Player.class === "騎士") { 
                    Player.baseMaxHp += 25; 
                    Player.baseAtk += 4; 
                    Player.baseDef += 1; // 騎士每次升級增加1點基礎防禦
                    Player.crit += 0.5;
                }
                else if(Player.class === "盜賊") { 
                    Player.baseMaxHp += 15; 
                    Player.baseAtk += 6; 
                    Player.crit += 2.5; 
                    Player.baseDef += 0.2; // 盜賊增加少量防禦
                }
                else if(Player.class === "法師") { 
                    Player.baseMaxHp += 10; 
                    Player.maxMp += 40; 
                    Player.baseAtk += 4; 
                    Player.crit += 1;
                    Player.baseDef += 0.1; // 法師增加極少量防禦
                }
                else if(Player.class === "獵人") { 
                    Player.baseMaxHp += 18; 
                    Player.baseAtk += 5; 
                    Player.crit += 1.5; 
                    Player.baseDef += 0.5; // 獵人增加中等防禦
                }
                else if(Player.class === "上帝") { 
                    Player.baseMaxHp += 1000; 
                    Player.baseAtk += 100; 
                    Player.crit += 2; 
                    Player.baseDef += 5;
                    Player.maxMp += 1000;
                }
                
                // 重新計算最大生命值（包括裝備加成）
                this.updatePlayerStats();
                Player.hp = Player.maxHp;
                Player.mp = Player.maxMp;
                UI.log(`⭐ 升級到 Lv.${Player.level}！`);
            }
            UI.update();
        },
        
        // 更新玩家的屬性（考慮基礎值、裝備固定加成和百分比加成）
        updatePlayerStats() {
            // 計算生命值
            const baseHp = Player.baseMaxHp;
            const fixedHpBonus = Player.equipmentHpBonus;
            const percentHpBonus = Player.equipmentHpPercent / 100;
            Player.maxHp = Math.floor(baseHp * (1 + percentHpBonus)) + fixedHpBonus;
            
            // 計算攻擊力
            const baseAtk = Player.baseAtk;
            const fixedAtkBonus = Player.weapon ? Player.weapon.atk : 0;
            const percentAtkBonus = Player.equipmentAtkPercent / 100;
            Player.atk = Math.floor(baseAtk * (1 + percentAtkBonus)) + fixedAtkBonus;
            
            // 計算防禦力
            const baseDef = Player.baseDef;
            const fixedDefBonus = Player.equipmentDefBonus;
            Player.def = baseDef + fixedDefBonus;
            
            // 確保當前HP不超過最大HP
            if (Player.hp > Player.maxHp) {
                Player.hp = Player.maxHp;
            }
            
            // 確保當前MP不超過最大MP
            if (Player.mp > Player.maxMp) {
                Player.mp = Player.maxMp;
            }
            
            UI.update();
        },

        rest() {
            if (this.state !== 'idle' || this.currentPage !== 'adventure') return;
            Player.hp = Player.maxHp;
            Player.mp = Player.maxMp;
            UI.log("在此休息,恢復了精力");
            this.next();
        },
        
        showDeathScreen() {
            document.getElementById('dead-depth').innerText = Player.depth;
            document.getElementById('dead-bosses').innerText = Game.bossCount;
            document.getElementById('dead-level').innerText = Player.level;
            document.getElementById('dead-modal').style.display = 'flex';
        },
        
        restart() {
            document.getElementById('dead-modal').style.display = 'none';
            document.getElementById('start-modal').style.display = 'flex';
        }
    };

    // 寶箱系統
    const Chest = {
        open() {
            if (isOpeningChest) return; // 防止重複開啟
            isOpeningChest = true;
            
            // 禁用按鈕
            const buttons = document.querySelectorAll('#chest-content button');
            buttons.forEach(btn => btn.disabled = true);
            
            const chestIcon = document.getElementById('chest-icon');
            const chestMessage = document.getElementById('chest-message');
            
            // 播放開箱動畫
            chestIcon.classList.add('chest-opening');
            
            setTimeout(() => {
                chestIcon.classList.remove('chest-opening');
                
                // 50% 好寶箱, 50% 壞寶箱
                const isGood = Math.random() < 0.5;
                
                if (isGood) {
                    // 好寶箱
                    const rewards = DB.chestRewards.good;
                    const reward = rewards[Math.floor(Math.random() * rewards.length)];
                    chestIcon.innerText = reward.icon;
                    
                    this.applyGoodReward(reward);
                    
                    chestMessage.innerHTML = `<span class="chest-result-good">${reward.message}</span>`;
                } else {
                    // 壞寶箱
                    const punishments = DB.chestRewards.bad;
                    const punishment = punishments[Math.floor(Math.random() * punishments.length)];
                    chestIcon.innerText = punishment.icon;
                    
                    this.applyBadReward(punishment);
                    
                    chestMessage.innerHTML = `<span class="chest-result-bad">${punishment.message}</span>`;
                }
                
                // 3秒後返回冒險
                setTimeout(() => {
                    Game.chestActive = false;
                    isOpeningChest = false;
                    Game.next();
                }, 3000);
            }, 500);
        },
        
        applyGoodReward(reward) {
            switch(reward.type) {
                case "gold":
                    const goldAmount = Math.floor(reward.amount * DIFFICULTY_MODIFIERS[gameDifficulty].goldMultiplier);
                    Player.gold += goldAmount;
                    UI.log(`從寶箱獲得 ${goldAmount} 金幣！`);
                    break;
                case "exp":
                    Player.exp += reward.amount;
                    UI.log(`從寶箱獲得 ${reward.amount} 經驗值！`);
                    Game.gainExp(0); // 觸發升級檢查
                    break;
                case "item":
                    Game.addItem(reward.item);
                    break;
                case "material":
                    Game.addMaterial(reward.item, reward.amount);
                    break;
                case "buff":
                    if (reward.stat === "atk") {
                        Player.baseAtk += reward.val;
                        Player.equipmentAtkPercent = 0;
                        if (Player.weapon && Player.weapon.atkPercent) {
                            Player.equipmentAtkPercent = Player.weapon.atkPercent;
                        }
                    } else if (reward.stat === "maxHp") {
                        Player.baseMaxHp += reward.val;
                        Game.updatePlayerStats();
                        Player.hp += reward.val;
                    } else if (reward.stat === "def") {
                        Player.baseDef += reward.val;
                        Game.updatePlayerStats();
                    }
                    Game.updatePlayerStats();
                    break;
            }
            UI.update();
        },
        
        applyBadReward(punishment) {
            switch(punishment.type) {
                case "damage":
                    Player.hp -= punishment.amount;
                    if (Player.hp <= 0) {
                        Game.showDeathScreen();
                    }
                    UI.log(`寶箱造成 ${punishment.amount} 點傷害！`);
                    break;
                case "curse":
                    if (punishment.stat === "atk") {
                        Player.baseAtk += punishment.val;
                        Player.equipmentAtkPercent = 0;
                        if (Player.weapon && Player.weapon.atkPercent) {
                            Player.equipmentAtkPercent = Player.weapon.atkPercent;
                        }
                    } else if (punishment.stat === "def") {
                        Player.baseDef += punishment.val;
                        Game.updatePlayerStats();
                    }
                    Game.updatePlayerStats();
                    break;
                case "trap":
                    Player.hp -= punishment.damage;
                    if (Player.hp <= 0) {
                        Game.showDeathScreen();
                    }
                    UI.log(`陷阱造成 ${punishment.damage} 點傷害！`);
                    break;
                case "goldLoss":
                    Player.gold = Math.max(0, Player.gold - punishment.amount);
                    UI.log(`損失了 ${punishment.amount} 金幣！`);
                    break;
                case "poison":
                    // 簡單實現中毒效果
                    Player.hp -= punishment.damage;
                    if (Player.hp <= 0) {
                        Game.showDeathScreen();
                    }
                    UI.log(`中毒！受到 ${punishment.damage} 點傷害！`);
                    break;
                case "confusion":
                    UI.log("陷入混亂狀態！");
                    break;
            }
            UI.update();
        },
        
        skip() {
            if (isOpeningChest) return;
            Game.chestActive = false;
            isOpeningChest = false;
            Game.next();
            UI.log("你選擇了忽略寶箱");
        }
    };

    // 隨機事件系統
    const RandomEvent = {
        process() {
            if (isProcessingEvent) return; // 防止重複處理
            isProcessingEvent = true;
            
            // 禁用按鈕
            const buttons = document.querySelectorAll('#event-content button');
            buttons.forEach(btn => btn.disabled = true);
            
            const eventName = document.getElementById('event-name').innerText;
            const events = DB.randomEvents;
            const event = events.find(e => e.name === eventName);
            
            if (!event) {
                this.skip();
                return;
            }
            
            // 執行事件效果
            const result = event.effect();
            const resultElement = document.getElementById('event-result');
            
            // 根據事件類型設置顏色
            let resultClass = "";
            if (event.type === "good") {
                resultClass = "event-result-good";
            } else if (event.type === "bad") {
                resultClass = "event-result-bad";
            } else {
                resultClass = "event-result-neutral";
            }
            
            resultElement.innerHTML = `<div class="event-reward ${resultClass}">${result}</div>`;
            UI.update();
            
            // 3秒後返回冒險
            setTimeout(() => {
                Game.eventActive = false;
                isProcessingEvent = false;
                Game.next();
            }, 3000);
        },
        
        skip() {
            if (isProcessingEvent) return;
            Game.eventActive = false;
            isProcessingEvent = false;
            Game.next();
            UI.log("你選擇了跳過事件");
        }
    };

    // 戰鬥系統
    const Combat = {
        playerAttack() {
            if (Game.state !== 'combat' || isCombatAction || Game.currentPage !== 'adventure') return;
            
            isCombatAction = true;
            const base = Player.atk * DIFFICULTY_MODIFIERS[gameDifficulty].playerDamageMultiplier;
            const isCrit = Math.random() * 100 < Player.crit;
            const dmg = Math.floor(isCrit ? base * 2 : base);
            this.dealDamage(dmg, isCrit);
            
            setTimeout(() => {
                if (Game.state === 'combat' && Game.enemy && Game.enemy.hp > 0) {
                    isCombatAction = false;
                }
            }, 800);
        },

        useSkill(id) {
            if ((Game.state !== 'combat' && id !== 2) || isCombatAction || Game.currentPage !== 'adventure') return;
            
            isCombatAction = true;
            const base = Player.atk * DIFFICULTY_MODIFIERS[gameDifficulty].playerDamageMultiplier;
            
            if (id === 1 && Player.mp >= 20) {
                Player.mp -= 20;
                const dmg = Math.floor(base * 2.2);
                this.dealDamage(dmg, true);
            } else if (id === 2 && Player.mp >= 30) {
                Player.mp -= 30;
                const heal = Math.floor(Player.maxHp * 0.5);
                Player.hp = Math.min(Player.maxHp, Player.hp + heal);
                UI.float(`+${heal}`, "var(--success)");
                UI.log(`使用治癒術恢復了 ${heal} HP`);
                
                if(Game.state === 'combat' && Game.enemy && Game.enemy.hp > 0) {
                    setTimeout(() => {
                        this.enemyTurn();
                        isCombatAction = false;
                    }, 800);
                } else {
                    isCombatAction = false;
                }
                UI.update();
                return;
            } else if (id === 3 && Player.mp >= 60) {
                Player.mp -= 60;
                const dmg = Math.floor(base * 4.5);
                this.dealDamage(dmg, true);
            } else {
                isCombatAction = false;
                UI.log("魔力不足！");
                return;
            }
            
            setTimeout(() => {
                if (Game.state === 'combat' && Game.enemy && Game.enemy.hp > 0) {
                    isCombatAction = false;
                }
            }, 800);
        },

        dealDamage(dmg, isCrit) {
            Game.enemy.hp -= dmg;
            
            // 在事件描述區域顯示玩家攻擊傷害
            const originalDesc = document.getElementById('event-desc').innerText;
            document.getElementById('event-desc').innerText = `你對 ${Game.enemy.name} 造成 ${dmg}${isCrit ? ' (暴擊)' : ''} 傷害`;
            document.getElementById('event-desc').style.color = isCrit ? "#ffeb3b" : "#4caf50";
            
            UI.float(dmg + (isCrit ? "!" : ""), isCrit ? "#ffeb3b" : "white");
            UI.shake();
            UI.log(`你對 ${Game.enemy.name} 造成 ${dmg}${isCrit ? ' (暴擊)' : ''} 傷害`);
            
            if (Game.enemy.hp <= 0) {
                this.win();
                // 戰鬥勝利時掉落素材
                if (Math.random() < 0.7) {
                    const commonMats = ["木材", "鐵礦石", "獸皮", "尖牙", "爪子", "強化寶石"];
                    const randomMat = commonMats[Math.floor(Math.random() * commonMats.length)];
                    const amount = 1 + Math.floor(Math.random() * 3);
                    Game.addMaterial(randomMat, amount);
                }
                
                // BOSS戰有機率掉落稀有素材
                if (Game.enemy.isBoss && Math.random() < 0.5) {
                    const rareMats = ["龍鱗", "鳳凰之羽", "惡魔角", "天使之羽", "星辰碎片", "神之血"];
                    const randomMat = rareMats[Math.floor(Math.random() * rareMats.length)];
                    Game.addMaterial(randomMat, 1);
                    UI.log(`BOSS掉落稀有素材：${randomMat}！`);
                }
            } else {
                setTimeout(() => {
                    // 恢復原來的描述
                    document.getElementById('event-desc').innerText = originalDesc;
                    document.getElementById('event-desc').style.color = "#888";
                    this.enemyTurn();
                }, 600);
            }
            UI.update();
        },

        enemyTurn() {
            if (Game.state !== 'combat') return;
            
            // 怪物攻擊力考慮難度係數
            const enemyDamage = Game.enemy.atk * DIFFICULTY_MODIFIERS[gameDifficulty].monsterDamageMultiplier;
            // 傷害計算公式：怪物攻擊力 - 玩家防禦（防禦直接減傷）
            const finalDamage = Math.max(1, Math.floor(enemyDamage - Player.def));
            
            // 在事件描述區域顯示敵人攻擊傷害
            const originalDesc = document.getElementById('event-desc').innerText;
            document.getElementById('event-desc').innerText = `${Game.enemy.name} 對你造成 ${finalDamage} 傷害`;
            document.getElementById('event-desc').style.color = "#ff5252";
            
            Player.hp -= finalDamage;
            UI.float(`-${finalDamage}`, "var(--danger)");
            UI.log(`${Game.enemy.name} 對你造成 ${finalDamage} 傷害 (原始傷害: ${enemyDamage.toFixed(1)}, 防禦減免: ${Player.def})`);
            
            if (Player.hp <= 0) {
                Game.showDeathScreen();
            } else {
                // 延遲恢復原來的描述
                setTimeout(() => {
                    document.getElementById('event-desc').innerText = originalDesc;
                    document.getElementById('event-desc').style.color = "#888";
                }, 1000);
            }
            isCombatAction = false;
            UI.update();
        },

        win() {
            const baseLoot = Math.floor(Game.enemy.maxHp / 5) + 5;
            const lootMultiplier = DIFFICULTY_MODIFIERS[gameDifficulty].goldMultiplier;
            const loot = Math.floor((Game.enemy.isBoss ? baseLoot * 10 : baseLoot) * lootMultiplier);
            const expGain = Math.floor((Game.enemy.isBoss ? Math.floor(Game.enemy.maxHp / 2) : Math.floor(Game.enemy.maxHp / 6) + 15) * DIFFICULTY_MODIFIERS[gameDifficulty].expMultiplier);
            Player.gold += loot;
            Game.gainExp(expGain);
            UI.log(`擊敗了 ${Game.enemy.name}！ +${loot}G +${expGain}EXP`);
            
            // BOSS戰有機率掉落特殊裝備
            if (Game.enemy.isBoss && Math.random() < 0.3) {
                const bossItems = ["火焰劍", "冰霜之刃", "英雄之刃", "龍鱗甲", "聖騎士盔甲"];
                const randomItem = bossItems[Math.floor(Math.random() * bossItems.length)];
                Game.addItem(randomItem);
            }
            
            Game.state = "idle";
            isCombatAction = false;
            UI.renderStage("🏆", "戰鬥勝利", `獲得 ${loot} 金幣 & ${expGain} EXP`, false);
            
            // 延遲清空勝利訊息
            setTimeout(() => {
                document.getElementById('event-desc').innerText = "";
            }, 2000);
            
            document.getElementById('boss-warning').style.display = 'none';
            Game.updateButtons();
            UI.update();
        },

        flee() {
            if (Game.state !== 'combat' || isCombatAction || Game.currentPage !== 'adventure') return;
            
            isCombatAction = true;
            const fleeChance = 0.7; // 逃跑成功率設為70%
            
            if (Math.random() < fleeChance) {
                UI.log("逃跑成功");
                setTimeout(() => {
                    Game.next();
                    isCombatAction = false;
                }, 800);
            } else {
                UI.log("逃跑失敗！");
                // 逃跑失敗會被敵人攻擊
                setTimeout(() => {
                    // 在事件描述區域顯示逃跑失敗
                    const originalDesc = document.getElementById('event-desc').innerText;
                    document.getElementById('event-desc').innerText = "逃跑失敗！";
                    document.getElementById('event-desc').style.color = "#ff9800";
                    
                    // 延遲一下再顯示傷害
                    setTimeout(() => {
                        // 在事件描述區域顯示敵人攻擊傷害
                        const enemyDamage = Game.enemy.atk * DIFFICULTY_MODIFIERS[gameDifficulty].monsterDamageMultiplier;
                        // 傷害計算公式：怪物攻擊力 - 玩家防禦（防禦直接減傷）
                        const finalDamage = Math.max(1, Math.floor(enemyDamage - Player.def));
                        
                        document.getElementById('event-desc').innerText = `${Game.enemy.name} 趁你逃跑時攻擊，對你造成 ${finalDamage} 傷害`;
                        document.getElementById('event-desc').style.color = "#ff5252";
                        
                        // 直接執行敵人攻擊邏輯
                        Player.hp -= finalDamage;
                        UI.float(`-${finalDamage}`, "var(--danger)");
                        UI.log(`${Game.enemy.name} 趁你逃跑時攻擊，對你造成 ${finalDamage} 傷害`);
                        
                        // 恢復原來的描述
                        setTimeout(() => {
                            document.getElementById('event-desc').innerText = originalDesc;
                            document.getElementById('event-desc').style.color = "#888";
                        }, 1000);
                        
                        if (Player.hp <= 0) {
                            Game.showDeathScreen();
                        } else {
                            isCombatAction = false;
                        }
                        UI.update();
                    }, 600);
                }, 800);
            }
        }
    };

    // UI 系統
    const UI = {
        update() {
            document.getElementById('ui-level').innerText = Player.level;
            document.getElementById('ui-depth').innerText = Player.depth;
            document.getElementById('ui-gold').innerText = Player.gold.toLocaleString();
            document.getElementById('ui-class').innerText = Player.class;
            
            // 計算總攻擊力（基礎+武器）
            const totalAtk = Player.atk;
            document.getElementById('ui-atk').innerText = totalAtk.toLocaleString();
            
            // 計算總防禦力（基礎+盔甲）
            const totalDef = Player.def;
            document.getElementById('ui-def').innerText = totalDef.toLocaleString();
            
            document.getElementById('ui-crit').innerText = Player.crit.toFixed(1) + "%";
            
            // 更新武器顯示
            let weaponName = Player.weapon ? Player.weapon.name : "- 無 -";
            let weaponDesc = Player.weapon ? Player.weapon.desc : "無效果";
            if (Player.weapon) {
                if (Player.weapon.enhanceLevel > 0) {
                    weaponName += ` +${Player.weapon.enhanceLevel}`;
                    weaponDesc += ` (強化+${Player.weapon.enhanceLevel})`;
                }
                // 顯示實際數值
                const atkValue = Player.weapon.atk || 0;
                const atkPercentValue = Player.weapon.atkPercent || 0;
                if (atkPercentValue > 0) {
                    weaponDesc = `ATK +${atkValue} (${atkPercentValue}%加成)`;
                } else {
                    weaponDesc = `ATK +${atkValue}`;
                }
            }
            document.getElementById('ui-weapon').innerText = `武器: ${weaponName}`;
            document.getElementById('weapon-desc').innerText = weaponDesc;
            
            // 更新盔甲顯示
            let armorName = Player.armor ? Player.armor.name : "- 無 -";
            let armorDesc = Player.armor ? Player.armor.desc : "無效果";
            if (Player.armor) {
                if (Player.armor.enhanceLevel > 0) {
                    armorName += ` +${Player.armor.enhanceLevel}`;
                    armorDesc += ` (強化+${Player.armor.enhanceLevel})`;
                }
                // 顯示實際數值
                const hpValue = Player.armor.hp || 0;
                const defValue = Player.armor.def || 0;
                const hpPercentValue = Player.armor.hpPercent || 0;
                armorDesc = `HP +${hpValue}, DEF +${defValue}`;
                if (hpPercentValue > 0) {
                    armorDesc += `, HP +${hpPercentValue}%`;
                }
            }
            document.getElementById('ui-armor').innerText = `盔甲: ${armorName}`;
            document.getElementById('armor-desc').innerText = armorDesc;
            
            // 頭像更新
            if (Player.class === "騎士") document.getElementById('ui-avatar').innerText = "⚔️";
            else if (Player.class === "盜賊") document.getElementById('ui-avatar').innerText = "🗡️";
            else if (Player.class === "法師") document.getElementById('ui-avatar').innerText = "🧙";
            else if (Player.class === "獵人") document.getElementById('ui-avatar').innerText = "🏹";
            else if (Player.class === "上帝") document.getElementById('ui-avatar').innerText = "👑";

            this.setBar('exp', Player.exp, Player.maxExp);
            this.setBar('hp', Player.hp, Player.maxHp);
            this.setBar('mp', Player.mp, Player.maxMp);
            
            if (Game.enemy && Game.state === 'combat' && Game.currentPage === 'adventure') {
                this.setBar('enemy-hp', Game.enemy.hp, Game.enemy.maxHp);
                document.getElementById('enemy-atk').innerText = Game.enemy.atk;
                document.getElementById('enemy-hp-text').innerText = `${Game.enemy.hp}/${Game.enemy.maxHp}`;
            }

            const inCombat = Game.state === 'combat' && Game.currentPage === 'adventure';
            const isAdventure = Game.currentPage === 'adventure';
            
            const canUseSkills = isAdventure && !isCombatAction;
            document.getElementById('skill-1').disabled = (Player.mp < 20) || !canUseSkills;
            document.getElementById('skill-2').disabled = (Player.mp < 30) || !canUseSkills;
            document.getElementById('skill-3').disabled = (Player.mp < 60) || !canUseSkills;

            const base = Player.atk;
            document.getElementById('sk1-val').innerText = `${Math.floor(base * 2.2).toLocaleString()} (20MP)`;
            document.getElementById('sk2-val').innerText = `+${Math.floor(Player.maxHp * 0.5).toLocaleString()} (30MP)`;
            document.getElementById('sk3-val').innerText = `${Math.floor(base * 4.5).toLocaleString()} (60MP)`;

            this.renderBag();
            if (Game.currentPage === 'shop') {
                this.renderShop();
            }
            
            // 更新按鈕狀態
            Game.updateButtons();
        },

        setBar(id, v, m) {
            const p = Math.max(0, (v / m) * 100);
            document.getElementById(`${id}-bar`).style.width = p + "%";
            if (document.getElementById(`${id}-text`)) {
                document.getElementById(`${id}-text`).innerText = `${Math.floor(Math.max(0,v)).toLocaleString()} / ${Math.floor(m).toLocaleString()}`;
            }
        },

        renderStage(ico, name, desc, showEnemy) {
            document.getElementById('enemy-sprite').innerText = ico;
            document.getElementById('event-name').innerText = name;
            document.getElementById('event-desc').innerText = desc;
            document.getElementById('enemy-panel').style.display = showEnemy ? "block" : "none";
        },

        renderBag() {
            const bagDiv = document.getElementById('bag-grid');
            if (!bagDiv) return;
            
            bagDiv.innerHTML = "";
            
            let itemsToShow = [];
            
            if (currentBagCategory === 'all') {
                itemsToShow = [...Player.bag];
                // 添加材料
                Object.keys(Player.materials).forEach(name => {
                    const count = Player.materials[name];
                    const itemInfo = DB.items[name];
                    if (itemInfo && count > 0) {
                        itemsToShow.push({ 
                            name, 
                            ...itemInfo, 
                            isMaterial: true, 
                            count: count 
                        });
                    }
                });
            } else if (currentBagCategory === 'material') {
                Object.keys(Player.materials).forEach(name => {
                    const count = Player.materials[name];
                    const itemInfo = DB.items[name];
                    if (itemInfo && count > 0) {
                        itemsToShow.push({ 
                            name, 
                            ...itemInfo, 
                            isMaterial: true, 
                            count: count 
                        });
                    }
                });
            } else {
                itemsToShow = Player.bag.filter(item => item.category === currentBagCategory);
            }
            
            if (itemsToShow.length === 0) {
                let emptyMessage = "背包空空如也";
                if (currentBagCategory === 'potion') emptyMessage = "沒有藥水";
                else if (currentBagCategory === 'weapon') emptyMessage = "沒有武器";
                else if (currentBagCategory === 'armor') emptyMessage = "沒有盔甲";
                else if (currentBagCategory === 'material') emptyMessage = "沒有素材";
                
                bagDiv.innerHTML = `<div style='grid-column:1/-1; text-align:center; color:#666; padding:10px; font-size:0.8em;'>${emptyMessage}</div>`;
                return;
            }
            
            itemsToShow.forEach((item, i) => {
                const slot = document.createElement('div');
                
                // 根據物品品質設定邊框顏色
                let rarityClass = 'r-common';
                if (item.r) {
                    rarityClass = `r-${item.r}`;
                } else if (item.isSpecial) {
                    rarityClass = 'r-mythic';
                }
                
                slot.className = `item-slot ${rarityClass} category-${item.category || 'material'}`;
                
                // 如果有強化等級，添加強化標記
                if (item.enhanceLevel > 0) {
                    slot.classList.add('enhanced');
                    slot.setAttribute('data-enhance', `+${item.enhanceLevel}`);
                }
                
                // 顯示圖標
                slot.innerHTML = `${item.icon}`;
                
                // 如果是素材，顯示數量
                if (item.isMaterial && item.count > 1) {
                    const countBadge = document.createElement('div');
                    countBadge.style.position = 'absolute';
                    countBadge.style.bottom = '1px';
                    countBadge.style.right = '1px';
                    countBadge.style.background = 'var(--accent)';
                    countBadge.style.color = 'white';
                    countBadge.style.borderRadius = '50%';
                    countBadge.style.width = '14px';
                    countBadge.style.height = '14px';
                    countBadge.style.fontSize = '9px';
                    countBadge.style.display = 'flex';
                    countBadge.style.alignItems = 'center';
                    countBadge.style.justifyContent = 'center';
                    countBadge.innerText = item.count > 9 ? '9+' : (item.count > 999 ? '999+' : item.count);
                    slot.appendChild(countBadge);
                }
                
                // 為素材添加點擊事件
                if (item.isMaterial) {
                    // 素材點擊：顯示詳細信息
                    slot.onclick = () => {
                        this.openMaterialModal(item);
                    };
                } else {
                    // 普通物品點擊
                    slot.onclick = () => this.openItemModal(item, i);
                }
                
                bagDiv.appendChild(slot);
            });
        },
        
        // 新增：打開素材詳細信息
        openMaterialModal(item) {
            document.getElementById('m-icon').innerText = item.icon;
            document.getElementById('m-title').innerText = item.name;
            
            // 顯示稀有度
            let rarityText = "";
            let rarityColor = "";
            if (item.r === 'common') { rarityText = "普通"; rarityColor = "var(--r-common)"; }
            else if (item.r === 'rare') { rarityText = "稀有"; rarityColor = "var(--r-rare)"; }
            else if (item.r === 'epic') { rarityText = "史詩"; rarityColor = "var(--r-epic)"; }
            else if (item.r === 'legend') { rarityText = "傳說"; rarityColor = "var(--r-legend)"; }
            else if (item.r === 'mythic' || item.isSpecial) { rarityText = "神話"; rarityColor = "var(--r-mythic)"; }
            
            document.getElementById('m-rarity').innerText = rarityText;
            document.getElementById('m-rarity').style.color = rarityColor;
            
            document.getElementById('m-desc').innerText = item.desc;
            
            // 顯示素材數量
            document.getElementById('m-stats').innerHTML = `<div>數量: ${item.count.toLocaleString()}</div>`;
            
            // 隱藏動作按鈕，只顯示關閉按鈕
            document.getElementById('m-action').style.display = 'none';
            document.getElementById('item-modal').querySelectorAll('button')[0].style.flex = '1';
            document.getElementById('item-modal').querySelectorAll('button')[0].style.gridColumn = '1 / -1';
            document.getElementById('item-modal').querySelectorAll('button')[0].innerText = '關閉';
            document.getElementById('item-modal').querySelectorAll('button')[0].onclick = () => this.closeModal();
            
            document.getElementById('item-modal').style.display = 'flex';
        },

        renderShop() {
            ['potion', 'weapon', 'armor', 'material'].forEach(cat => {
                const div = document.getElementById('shop-' + cat);
                if (div) div.innerHTML = "";
            });
            
            Object.entries(DB.items).forEach(([name, item]) => {
                // 跳過只能鍛造的物品和上帝專屬裝備
                if (item.craftOnly || item.godOnly) return;
                
                const cat = item.category;
                const shopDiv = document.getElementById('shop-' + cat);
                if (!shopDiv) return;
                
                const card = document.createElement('div');
                card.className = `shop-card`;
                card.innerHTML = `
                    <div class="shop-card-icon">${item.icon}</div>
                    <div class="shop-card-name">${name}</div>
                    <div class="shop-card-desc">${item.desc}</div>
                    <div class="shop-card-footer">
                        <span class="shop-card-price">${item.price}G</span>
                        <button class="btn" style="padding:3px 6px; font-size:0.65em;" 
                            onclick="Game.buyItem('${name}')" ${Player.gold < item.price ? 'disabled' : ''}>購買</button>
                    </div>
                `;
                shopDiv.appendChild(card);
            });
            
            this.switchShopCategory(currentShopCategory);
        },

        renderRecipes() {
            const recipeList = document.getElementById('recipe-list');
            if (!recipeList) return;
            
            recipeList.innerHTML = "";
            
            DB.recipes.forEach(recipe => {
                const card = document.createElement('div');
                card.className = 'recipe-card';
                
                let hasAllMaterials = true;
                const materialsHtml = recipe.materials.map(mat => {
                    let hasEnough = false;
                    if (mat.name === "銀製長劍" || mat.name === "鋼鐵長劍") {
                        // 檢查背包中是否有這個武器
                        const weaponCount = Player.bag.filter(item => item.name === mat.name).length;
                        hasEnough = weaponCount >= mat.amount;
                    } else {
                        hasEnough = Game.getMaterialCount(mat.name) >= mat.amount;
                    }
                    
                    if (!hasEnough) hasAllMaterials = false;
                    
                    let countText = "";
                    if (mat.name === "銀製長劍" || mat.name === "鋼鐵長劍") {
                        const weaponCount = Player.bag.filter(item => item.name === mat.name).length;
                        countText = `(${weaponCount}/${mat.amount})`;
                    } else {
                        countText = `(${Game.getMaterialCount(mat.name)}/${mat.amount})`;
                    }
                    
                    return `
                        <div class="material-item ${hasEnough ? 'has-enough' : 'not-enough'}">
                            <span>${DB.items[mat.name]?.icon || '❓'}</span>
                            <span>${mat.name} x${mat.amount}</span>
                            <span>${countText}</span>
                        </div>
                    `;
                }).join('');
                
                if (hasAllMaterials) {
                    card.classList.add('available');
                }
                
                card.innerHTML = `
                    <div class="recipe-header">
                        <div style="display:flex; align-items:center; gap:6px;">
                            <div class="recipe-icon">${recipe.icon}</div>
                            <div class="recipe-name">${recipe.name}</div>
                        </div>
                        <button class="btn" style="padding:3px 6px; font-size:0.65em;" 
                            onclick="Game.craftItem(${recipe.id})" ${!hasAllMaterials ? 'disabled' : ''}>
                            鍛造
                        </button>
                    </div>
                    <div class="recipe-desc">${recipe.desc}</div>
                    <div class="recipe-materials">
                        ${materialsHtml}
                    </div>
                `;
                
                recipeList.appendChild(card);
            });
        },

        renderUpgrade() {
            const upgradeList = document.getElementById('upgrade-list');
            if (!upgradeList) return;
            
            upgradeList.innerHTML = "";
            
            // 找出所有可以強化的物品（武器和盔甲）
            const upgradableItems = Player.bag.filter(item => item.type === 'weapon' || item.type === 'armor');
            
            if (upgradableItems.length === 0) {
                upgradeList.innerHTML = `
                    <div style="grid-column:1/-1; text-align:center; color:#666; padding:20px; font-size:0.9em;">
                        <div style="font-size:3em; margin-bottom:10px;">🔧</div>
                        <div>沒有可以強化的裝備</div>
                        <div style="font-size:0.8em; color:#888; margin-top:10px;">請先獲得武器或盔甲</div>
                    </div>
                `;
                return;
            }
            
            upgradableItems.forEach((item, index) => {
                const originalIndex = Player.bag.indexOf(item);
                const rules = DB.enhancementRules[item.type];
                const nextLevel = item.enhanceLevel + 1;
                const cost = rules.costMultiplier * nextLevel;
                const materialNeeded = rules.materialCost;
                const successRate = rules.successRate[item.enhanceLevel];
                
                const card = document.createElement('div');
                card.className = 'upgrade-card';
                
                // 計算強化後的屬性
                let enhancedStats = "";
                if (item.type === 'weapon') {
                    const baseAtk = item.baseAtk || item.atk || 0;
                    const baseAtkPercent = item.baseAtkPercent || item.atkPercent || 0;
                    const newAtk = baseAtk + (rules.atk * nextLevel);
                    const newAtkPercent = baseAtkPercent + (rules.atkPercent * nextLevel);
                    enhancedStats = `攻擊力: ${item.atk || 0} → ${newAtk} (+${rules.atk})<br>攻擊力%: ${item.atkPercent || 0}% → ${newAtkPercent}% (+${rules.atkPercent}%)`;
                } else if (item.type === 'armor') {
                    const baseHp = item.baseHp || item.hp || 0;
                    const baseDef = item.baseDef || item.def || 0;
                    const baseHpPercent = item.baseHpPercent || item.hpPercent || 0;
                    const newHp = baseHp + (rules.hp * nextLevel);
                    const newDef = baseDef + (rules.def * nextLevel);
                    const newHpPercent = baseHpPercent + (rules.hpPercent * nextLevel);
                    enhancedStats = `生命值: ${item.hp || 0} → ${newHp} (+${rules.hp})<br>防禦力: ${item.def || 0} → ${newDef} (+${rules.def})`;
                    if (item.hpPercent || rules.hpPercent) {
                        enhancedStats += `<br>生命值%: ${item.hpPercent || 0}% → ${newHpPercent}% (+${rules.hpPercent}%)`;
                    }
                }
                
                card.innerHTML = `
                    <div class="upgrade-card-icon">${item.icon}</div>
                    <div class="upgrade-card-name">${item.name} ${item.enhanceLevel > 0 ? `+${item.enhanceLevel}` : ''}</div>
                    <div class="upgrade-card-desc">${item.desc}</div>
                    <div style="font-size:0.7em; color:#ccc; margin-bottom:8px;">
                        ${enhancedStats}
                    </div>
                    <div style="font-size:0.7em; color:#ff9800; margin-bottom:8px;">
                        成功率: ${successRate}% | 消耗: ${cost} G + 強化寶石 x${materialNeeded}
                    </div>
                    <div class="upgrade-card-footer">
                        <span class="upgrade-card-price">強化等級: ${item.enhanceLevel}/9</span>
                        <button class="btn" style="padding:3px 6px; font-size:0.65em;" 
                            onclick="Game.enhanceItem(${originalIndex})" 
                            ${Player.gold < cost || Game.getMaterialCount("強化寶石") < materialNeeded || item.enhanceLevel >= 9 ? 'disabled' : ''}>
                            強化
                        </button>
                    </div>
                `;
                
                upgradeList.appendChild(card);
            });
        },

        openItemModal(item, index) {
            document.getElementById('m-icon').innerText = item.icon;
            
            // 顯示物品名稱（含強化等級）
            let itemName = item.name;
            if (item.enhanceLevel > 0) {
                itemName += ` +${item.enhanceLevel}`;
            }
            document.getElementById('m-title').innerText = itemName;
            
            // 顯示稀有度
            let rarityText = "";
            let rarityColor = "";
            if (item.r === 'common') { rarityText = "普通"; rarityColor = "var(--r-common)"; }
            else if (item.r === 'rare') { rarityText = "稀有"; rarityColor = "var(--r-rare)"; }
            else if (item.r === 'epic') { rarityText = "史詩"; rarityColor = "var(--r-epic)"; }
            else if (item.r === 'legend') { rarityText = "傳說"; rarityColor = "var(--r-legend)"; }
            else if (item.r === 'mythic' || item.isSpecial) { rarityText = "神話"; rarityColor = "var(--r-mythic)"; }
            
            document.getElementById('m-rarity').innerText = rarityText;
            document.getElementById('m-rarity').style.color = rarityColor;
            
            document.getElementById('m-desc').innerText = item.desc;
            
            // 顯示物品統計數據
            const statsDiv = document.getElementById('m-stats');
            let statsHTML = "";
            
            if (item.isMaterial) {
                statsHTML = `<div>數量: ${item.count.toLocaleString()}</div>`;
                // 如果是素材，只顯示一個關閉按鈕
                document.getElementById('m-action').style.display = 'none';
                document.getElementById('item-modal').querySelectorAll('button')[0].style.flex = '1';
                document.getElementById('item-modal').querySelectorAll('button')[0].style.gridColumn = '1 / -1';
                document.getElementById('item-modal').querySelectorAll('button')[0].innerText = '關閉';
                document.getElementById('item-modal').querySelectorAll('button')[0].onclick = () => this.closeModal();
            } else {
                // 恢復兩個按鈕的佈局
                document.getElementById('m-action').style.display = 'flex';
                document.getElementById('item-modal').querySelectorAll('button')[0].style.flex = '1';
                document.getElementById('item-modal').querySelectorAll('button')[0].style.gridColumn = '';
                document.getElementById('item-modal').querySelectorAll('button')[0].innerText = '關閉';
                document.getElementById('item-modal').querySelectorAll('button')[0].onclick = () => this.closeModal();
                
                if (item.type === 'weapon') {
                    statsHTML = `<div>攻擊力: +${(item.atk || 0).toLocaleString()}</div>`;
                    if (item.atkPercent) {
                        statsHTML += `<div>攻擊力加成: +${item.atkPercent}%</div>`;
                    }
                    if (item.enhanceLevel > 0) {
                        statsHTML += `<div class="enhance-level">強化等級: +${item.enhanceLevel}</div>`;
                    }
                } else if (item.type === 'armor') {
                    statsHTML = `<div>生命值: +${(item.hp || 0).toLocaleString()}</div>`;
                    if (item.hpPercent) {
                        statsHTML += `<div>生命值加成: +${item.hpPercent}%</div>`;
                    }
                    statsHTML += `<div>防禦力: +${(item.def || 0).toLocaleString()}</div>`;
                    if (item.mp) {
                        statsHTML += `<div>魔力值: +${item.mp}</div>`;
                    }
                    if (item.enhanceLevel > 0) {
                        statsHTML += `<div class="enhance-level">強化等級: +${item.enhanceLevel}</div>`;
                    }
                } else if (item.type === 'potion') {
                    if (item.effect === 'hp') {
                        statsHTML = `<div>恢復生命值: ${item.val}</div>`;
                    } else if (item.effect === 'mp') {
                        statsHTML = `<div>恢復魔力值: ${item.val}</div>`;
                    } else if (item.effect === 'both') {
                        statsHTML = `<div>恢復全部HP和MP</div>`;
                    }
                } else if (item.type === 'buff') {
                    statsHTML = `<div>效果: ${item.desc}</div>`;
                }
            }
            
            statsDiv.innerHTML = statsHTML;
            
            const act = document.getElementById('m-action');
            
            if (item.isMaterial) {
                // 素材只有一個關閉按鈕，上面已經處理了
                return;
            } else {
                // 檢查是否已裝備
                const isEquippedWeapon = Player.weapon && Player.weapon.name === item.name && Player.weapon.enhanceLevel === item.enhanceLevel;
                const isEquippedArmor = Player.armor && Player.armor.name === item.name && Player.armor.enhanceLevel === item.enhanceLevel;
                const isEquipped = isEquippedWeapon || isEquippedArmor;
                
                // 檢查是否在戰鬥中（某些物品不能在戰鬥中使用）
                const inCombat = Game.state === 'combat' && Game.currentPage === 'adventure';
                
                if (item.type === 'weapon') {
                    if (inCombat) {
                        act.innerText = "戰鬥中無法使用";
                        act.disabled = true;
                        act.style.background = '#666';
                        act.onclick = null;
                    } else if (isEquipped) {
                        act.innerText = "卸下";
                        act.onclick = () => {
                            Player.bag.push(Player.weapon);
                            Player.weapon = null;
                            Player.equipmentAtkPercent = 0;
                            Game.updatePlayerStats();
                            this.closeModal();
                            UI.log(`卸下了 ${item.name}！`);
                            UI.update();
                        };
                    } else {
                        act.innerText = "裝備";
                        act.onclick = () => {
                            if(Player.weapon) {
                                Player.bag.push(Player.weapon);
                                Player.equipmentAtkPercent = 0;
                            }
                            
                            Player.weapon = item;
                            Player.bag.splice(index, 1);
                            
                            // 添加武器百分比加成
                            if (item.atkPercent) {
                                Player.equipmentAtkPercent = item.atkPercent;
                            }
                            
                            Game.updatePlayerStats();
                            
                            this.closeModal();
                            UI.log(`裝備了 ${item.name}！`);
                            UI.update();
                        };
                    }
                } else if (item.type === 'armor') {
                    if (inCombat) {
                        act.innerText = "戰鬥中無法使用";
                        act.disabled = true;
                        act.style.background = '#666';
                        act.onclick = null;
                    } else if (isEquipped) {
                        act.innerText = "卸下";
                        act.onclick = () => {
                            Player.bag.push(Player.armor);
                            Player.armor = null;
                            
                            // 移除盔甲加成
                            if (item.hp) Player.equipmentHpBonus -= item.hp;
                            if (item.hpPercent) Player.equipmentHpPercent -= item.hpPercent;
                            if (item.def) Player.equipmentDefBonus -= item.def;
                            
                            Game.updatePlayerStats();
                            
                            this.closeModal();
                            UI.log(`卸下了 ${item.name}！`);
                            UI.update();
                        };
                    } else {
                        act.innerText = "裝備";
                        act.onclick = () => {
                            if(Player.armor) {
                                // 移除舊盔甲加成
                                if (Player.armor.hp) Player.equipmentHpBonus -= Player.armor.hp;
                                if (Player.armor.hpPercent) Player.equipmentHpPercent -= Player.armor.hpPercent;
                                if (Player.armor.def) Player.equipmentDefBonus -= Player.armor.def;
                                
                                Player.bag.push(Player.armor);
                            }
                            
                            Player.armor = item;
                            Player.bag.splice(index, 1);
                            
                            // 添加新盔甲加成
                            if (item.hp) Player.equipmentHpBonus += item.hp;
                            if (item.hpPercent) Player.equipmentHpPercent += item.hpPercent;
                            if (item.def) Player.equipmentDefBonus += item.def;
                            
                            Game.updatePlayerStats();
                            
                            this.closeModal();
                            UI.log(`裝備了 ${item.name}！`);
                            UI.update();
                        };
                    }
                } else if (item.type === 'buff') {
                    act.innerText = "使用";
                    act.onclick = () => {
                        if (item.stat === 'atk') {
                            Player.baseAtk += item.val;
                            Player.equipmentAtkPercent = 0; // 重置百分比加成
                            if (Player.weapon && Player.weapon.atkPercent) {
                                Player.equipmentAtkPercent = Player.weapon.atkPercent;
                            }
                        }
                        else if (item.stat === 'def') Player.baseDef += item.val;
                        else if (item.stat === 'crit') Player.crit += item.val;
                        else if (item.stat === 'maxHp') { 
                            Player.baseMaxHp += item.val;
                            Game.updatePlayerStats();
                            Player.hp += item.val;
                        }
                        else if (item.stat === 'maxMp') { 
                            Player.maxMp += item.val; 
                            Player.mp += item.val;
                        }
                        Player.bag.splice(index, 1);
                        this.closeModal();
                        UI.log(`使用了 ${item.name}！`);
                        Game.updatePlayerStats();
                        UI.update();
                    };
                } else {
                    // 藥水類可以在戰鬥中使用
                    act.innerText = "使用";
                    act.onclick = () => {
                        if(item.effect === 'hp') Player.hp = Math.min(Player.maxHp, Player.hp + item.val);
                        else if(item.effect === 'mp') Player.mp = Math.min(Player.maxMp, Player.mp + item.val);
                        else if(item.effect === 'both') {
                            Player.hp = Player.maxHp;
                            Player.mp = Player.maxMp;
                        }
                        Player.bag.splice(index, 1);
                        this.closeModal();
                        UI.log(`使用了 ${item.name}！`);
                        UI.update();
                    };
                }
            }
            
            document.getElementById('item-modal').style.display = 'flex';
        },

        closeModal() { 
            document.getElementById('item-modal').style.display = 'none'; 
        },

        switchTab(tab, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tabs-container button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${tab}-tab`).classList.add('active');
            btn.classList.add('active');
            
            if (tab === 'bag') {
                this.renderBag();
            }
        },

        switchBagCategory(cat) {
            currentBagCategory = cat;
            document.querySelectorAll('.bag-category-tabs button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            this.renderBag();
        },

        switchShopCategory(cat) {
            currentShopCategory = cat;
            document.querySelectorAll('.shop-category').forEach(div => div.classList.remove('active'));
            document.querySelectorAll('.shop-category-tabs button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('shop-' + cat).classList.add('active');
            event.target.classList.add('active');
        },

        log(msg) {
            const log = document.getElementById('log-tab');
            if (!log) return;
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `&gt; ${msg}`;
            log.appendChild(logEntry);
            
            while (log.children.length > 50) {
                log.removeChild(log.firstChild);
            }
            
            log.scrollTop = log.scrollHeight;
        },

        float(txt, color) {
            const f = document.createElement('div');
            f.className = 'floating-text';
            f.innerText = txt; 
            f.style.color = color;
            f.style.left = "50%"; 
            f.style.top = "40%";
            f.style.transform = "translateX(-50%)";
            document.getElementById('stage').appendChild(f);
            setTimeout(() => f.remove(), 1000);
        },

        shake() {
            const s = document.getElementById('stage');
            s.classList.add('shake');
            setTimeout(() => s.classList.remove('shake'), 300);
        }
    };

    // 密碼相關函數
    function showPasswordModal() {
        document.getElementById('password-modal').style.display = 'flex';
        document.getElementById('password-input').value = '';
        document.getElementById('password-error').textContent = '';
        document.getElementById('password-input').focus();
    }

    function hidePasswordModal() {
        document.getElementById('password-modal').style.display = 'none';
        passwordAttempts = 0;
    }

    function checkPassword() {
        const input = document.getElementById('password-input').value;
        const errorElement = document.getElementById('password-error');
        
        passwordAttempts++;
        
        if (GOD_PASSWORDS.includes(input)) {
            hidePasswordModal();
            startGame('god');
        } else {
            if (passwordAttempts >= MAX_PASSWORD_ATTEMPTS) {
                errorElement.textContent = `密碼錯誤！已嘗試 ${passwordAttempts} 次，請稍後再試。`;
                setTimeout(hidePasswordModal, 2000);
            } else {
                const remaining = MAX_PASSWORD_ATTEMPTS - passwordAttempts;
                errorElement.textContent = `密碼錯誤！還剩 ${remaining} 次嘗試機會。`;
            }
        }
    }

    // 遊戲開始函數
    function startGame(cls) {
        Game.init(cls);
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 確保CSS類正確應用
        const statLabels = document.querySelectorAll('.stat-label');
        statLabels.forEach(label => {
            label.classList.add('stat-label');
        });
        
        UI.switchShopCategory('potion');
        Game.updateButtons();
        
        // 密碼輸入框回車鍵支持
        document.getElementById('password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        
        // 手機觸控優化
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // 防止手機雙擊放大
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // 修復背包分類按鈕點擊事件
        document.querySelectorAll('.bag-category-tabs button').forEach(button => {
            button.addEventListener('click', function() {
                const cat = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                UI.switchBagCategory(cat);
            });
        });
        
        // 修復商店分類按鈕點擊事件
        document.querySelectorAll('.shop-category-tabs button').forEach(button => {
            button.addEventListener('click', function() {
                const cat = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                UI.switchShopCategory(cat);
            });
        });
    });
</script>
</body>
</html>
