<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¹»æƒ³å†’éšª V6.0</title>
    <style>
        :root {
            --bg-dark: #0a0a0e;
            --panel-bg: #16161d;
            --panel-border: #333;
            --accent: #ff9800;
            --text-main: #e0e0e0;
            --danger: #ff5252;
            --mana: #448aff;
            --success: #4caf50;
            --r-common: #9e9e9e;
            --r-rare: #2196f3;
            --r-epic: #9c27b0;
            --r-legend: #ffab00;
            --r-mythic: #ff4081;
            --category-potion: #e91e63;
            --category-weapon: #4caf50;
            --category-armor: #795548;
            --category-material: #ff9800;
        }

        * { box-sizing: border-box; user-select: none; }
        body {
            margin: 0; background: var(--bg-dark); color: var(--text-main);
            font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            padding: 10px;
        }

        #game-container {
            width: 100%; height: 100%; max-width: 1600px; display: grid;
            grid-template-columns: minmax(250px, 280px) 1fr minmax(300px, 380px); 
            grid-template-rows: 60px 1fr 180px;
            gap: 8px; padding: 8px; overflow: hidden;
        }

        @media (max-width: 1024px) {
            #game-container {
                grid-template-columns: 1fr; grid-template-rows: auto auto auto auto auto;
            }
            .header { grid-column: 1; }
            aside:first-of-type { grid-column: 1; grid-row: 2; }
            .main-stage { grid-column: 1; grid-row: 3; }
            .control-area { grid-column: 1; grid-row: 4; }
            aside:last-of-type { grid-column: 1; grid-row: 5; }
            
            .control-area {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .grid-list {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)) !important;
                gap: 3px !important;
            }
            
            .item-slot {
                font-size: 0.9em !important;
                min-height: 35px !important;
            }
        }

        @media (max-width: 768px) {
            #game-container {
                padding: 5px;
                gap: 5px;
            }
            
            .panel {
                padding: 8px !important;
            }
            
            .enemy-sprite {
                font-size: 4em !important;
            }
            
            .tabs-container button {
                font-size: 0.7em !important;
                padding: 4px !important;
            }
            
            .btn {
                padding: 8px !important;
                font-size: 0.8em !important;
            }
        }

        .panel {
            background: var(--panel-bg); border: 1px solid var(--panel-border);
            border-radius: 8px; padding: 10px; display: flex; flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .header { grid-column: 1 / -1; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); padding: 0 10px; }
        .main-stage { grid-column: 2 / 3; grid-row: 2 / 3; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background: radial-gradient(circle, #222 0%, #111 100%); overflow: hidden; }
        
        .control-area { 
            grid-column: 2 / 3; grid-row: 3 / 4; 
            display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 6px; 
            min-height: 150px;
        }

        @media (max-width: 480px) {
            .control-area {
                grid-template-columns: 1fr !important;
            }
        }

        .enemy-sprite { font-size: 6em; transition: 0.2s; }
        
        .enemy-ui { 
            width: 90%; background: rgba(0,0,0,0.7); padding: 10px; 
            border-radius: 6px; border: 1px solid #444; margin-bottom: 10px; 
        }
        .enemy-stats {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 6px; font-weight: bold; color: var(--danger);
            font-size: 0.9em; white-space: nowrap;
        }
        .enemy-stats span:first-child {
            display: flex; align-items: center; gap: 5px;
        }
        .bar-container { height: 14px; background: #222; border-radius: 7px; overflow: hidden; position: relative; border: 1px solid #444; }
        .bar-fill { height: 100%; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hp-fill { background: var(--danger); box-shadow: 0 0 6px var(--danger); }
        .mp-fill { background: var(--mana); box-shadow: 0 0 6px var(--mana); }
        .bar-text { position: absolute; width: 100%; text-align: center; top:0; font-size: 9px; font-weight: bold; line-height: 14px; text-shadow: 1px 1px black; }

        .btn { 
            border: 1px solid #444; background: #2a2a35; color: white; padding: 9px; 
            border-radius: 5px; cursor: pointer; transition: all 0.3s ease; 
            font-weight: bold; font-size: 0.85em; 
        }
        .btn:hover:not(:disabled) { background: #3a3a45; transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            filter: grayscale(70%);
            transition: all 0.3s ease;
        }
        
        .btn.combat-disabled {
            opacity: 0.4;
            filter: grayscale(80%);
            background: #1a1a24;
            border-color: #555;
        }
        
        .btn-exp { background: #2e7d32; border-color: #4caf50; }
        .btn-atk { background: #c62828; border-color: #ff5252; }
        .btn-shop { background: #4a148c; border-color: #9c27b0; }
        .btn-craft { background: #5d4037; border-color: #8d6e63; }

        .grid-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 4px;
            align-items: stretch;
        }
        .item-slot { 
            aspect-ratio: 1; 
            border: 2px solid var(--panel-border); 
            background: #1a1a24;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            border-radius: 5px; 
            cursor: pointer; 
            position: relative; 
            font-size: 1em;
            min-height: 40px;
            max-height: 50px;
            width: 100%;
            padding: 2px;
            transition: all 0.2s ease;
        }
        .item-slot:hover {
            transform: scale(1.05);
            border-color: var(--accent);
        }
        .item-slot.r-common { border-color: var(--r-common); }
        .item-slot.r-rare { border-color: var(--r-rare); box-shadow: inset 0 0 4px rgba(33,150,243,0.3); }
        .item-slot.r-epic { border-color: var(--r-epic); box-shadow: inset 0 0 4px rgba(156,39,176,0.3); }
        .item-slot.r-legend { border-color: var(--r-legend); box-shadow: 0 0 6px rgba(255,171,0,0.4); }
        .item-slot.r-mythic { border-color: var(--r-mythic); box-shadow: 0 0 8px rgba(255,64,129,0.6); }
        
        .category-potion { border-left: 3px solid var(--category-potion); }
        .category-weapon { border-left: 3px solid var(--category-weapon); }
        .category-armor { border-left: 3px solid var(--category-armor); }
        .category-material { border-left: 3px solid var(--category-material); }

        .shop-page, .forge-page { 
            display: none; flex-direction: column; height: 100%; 
            width: 100%; overflow: hidden;
        }
        .shop-page.active, .forge-page.active { display: flex; }
        
        .stage-page { display: none; }
        .stage-page.active { display: flex; flex-direction: column; min-height: 0; }
        
        .shop-category-tabs, .bag-category-tabs { 
            display: flex; gap: 4px; margin-bottom: 10px; 
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        .shop-category-tabs button, .bag-category-tabs button { 
            flex: 1; padding: 6px; font-size: 0.8em; 
            min-width: 60px;
        }
        
        .shop-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; 
            overflow-y: auto; 
            flex: 1;
            padding-right: 4px;
            padding-bottom: 15px;
            margin-bottom: 10px;
        }
        .shop-category {
            display: none;
        }
        .shop-category.active {
            display: grid;
        }
        .shop-card { 
            background: #252530; border: 1px solid #444; padding: 8px; 
            border-radius: 5px; cursor: pointer; transition: 0.2s; 
            display: flex; flex-direction: column;
        }
        .shop-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .shop-card-icon { font-size: 1.8em; margin-bottom: 5px; text-align: center; }
        .shop-card-name { font-weight: bold; font-size: 0.8em; margin-bottom: 3px; }
        .shop-card-desc { font-size: 0.65em; color: #999; margin-bottom: 6px; flex-grow: 1; }
        .shop-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .shop-card-price { color: #ffd700; font-weight: bold; font-size: 0.85em; }

        .forge-page { display: none; flex-direction: column; height: 100%; }
        .forge-page.active { display: flex; }
        .recipe-list { 
            overflow-y: auto; 
            flex: 1;
            padding-right: 4px;
            padding-bottom: 15px;
            margin-bottom: 10px;
        }
        .recipe-card { background: #252530; border: 1px solid #444; padding: 10px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .recipe-card:hover { border-color: var(--accent); }
        .recipe-card.available { background: rgba(76, 175, 80, 0.1); border-color: var(--success); }
        .recipe-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .recipe-icon { font-size: 1.6em; }
        .recipe-name { font-weight: bold; font-size: 0.9em; }
        .recipe-desc { color: #aaa; font-size: 0.75em; margin-bottom: 8px; }
        .recipe-materials { display: flex; flex-wrap: wrap; gap: 6px; }
        .material-item { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.3); padding: 3px 6px; border-radius: 4px; font-size: 0.8em; }
        .material-item.has-enough { color: var(--success); }
        .material-item.not-enough { opacity: 0.5; }

        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-60px); } }
        .floating-text { position: absolute; font-size: 2em; font-weight: bold; animation: floatUp 1s forwards; z-index: 100; pointer-events: none; }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:1000; }
        .modal-box { background: var(--panel-bg); padding: 15px; border-radius: 10px; border: 2px solid #555; width: 90%; max-width: 400px; text-align: center; max-height: 80vh; overflow-y: auto; }

        .tabs-container { 
            display: flex; gap: 4px; margin-bottom: 8px; 
            flex-shrink: 0;
        }
        .tabs-container button { 
            flex: 1; padding: 5px; font-size: 0.75em; 
            height: 30px;
        }
        
        .tab-content { 
            display: none; 
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .tab-content.active { 
            display: flex;
        }

        #bag-tab {
            flex: 1;
            overflow: hidden;
            display: none;
            flex-direction: column;
            min-height: 0;
        }
        
        #bag-tab.active {
            display: flex;
        }
        
        #bag-tab .grid-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 3px;
            padding-bottom: 5px;
        }
        
        #log-tab {
            flex: 1;
            overflow-y: auto;
            font-size: 0.7em;
            color: #aaa;
            line-height: 1.4;
            padding-right: 3px;
            display: none;
            padding-bottom: 10px;
        }
        
        #log-tab.active {
            display: block;
        }

        .boss-warning { background: linear-gradient(135deg, rgba(255,171,0,0.2), rgba(255,107,0,0.2)); border: 2px solid #ffab00; padding: 8px; border-radius: 6px; margin-bottom: 8px; text-align: center; }
        .boss-warning-title { color: #ffab00; font-weight: bold; font-size: 0.9em; }

        .class-card { padding:12px; text-align:left; height:auto; display:flex; gap:10px; align-items:flex-start; cursor:pointer; }

        ::-webkit-scrollbar {
            width: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #ffb74d;
        }
        
        #combat-warning {
            grid-column: 1 / -1;
            color: #ff9800;
            font-size: 0.75em;
            text-align: center;
            margin-top: 5px;
            display: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6;
            }
        }
        
        .equipment-info {
            margin-top: 8px;
            font-size: 0.75em;
            background: rgba(0,0,0,0.3);
            padding: 6px;
            border-radius: 5px;
        }
        
        .equipment-item {
            margin-bottom: 4px;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        
        .equipment-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>

<div id="game-container">
    <header class="panel header">
        <div style="font-size:1.2em; font-weight:bold; color:var(--accent);">âš”ï¸ å¹»æƒ³å†’éšª <span style="font-size:0.6em;">V6.0</span></div>
        <div style="font-size:0.9em;">Lv.<span id="ui-level">1</span> | æ·±åº¦: <span id="ui-depth">0</span> å±¤ | é‡‘å¹£: <span id="ui-gold" style="color:#ffd700">50</span> G</div>
    </header>

    <aside class="panel">
        <div style="text-align:center; font-size:3em; margin-bottom:8px;" id="ui-avatar">ğŸ‘¤</div>
        <h2 id="ui-class" style="text-align:center; margin:0 0 8px 0; color:var(--accent); font-size:1em;">è«‹é¸æ“‡è·æ¥­</h2>
        
        <div style="font-size:0.7em; color:#888;">ç¶“é©—å€¼ EXP</div>
        <div class="bar-container"><div id="exp-bar" class="bar-fill" style="background:var(--accent);"></div><div id="exp-text" class="bar-text">0/100</div></div>
        
        <div style="font-size:0.7em; color:#888; margin-top:6px;">ç”Ÿå‘½å€¼ HP</div>
        <div class="bar-container"><div id="hp-bar" class="bar-fill hp-fill"></div><div id="hp-text" class="bar-text">0/0</div></div>
        
        <div style="font-size:0.7em; color:#888; margin-top:6px;">é­”åŠ›å€¼ MP</div>
        <div class="bar-container"><div id="mp-bar" class="bar-fill mp-fill"></div><div id="mp-text" class="bar-text">0/0</div></div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin-top:10px;">
            <div style="text-align:center; background:#222; padding:6px; border-radius:5px;">
                <div style="font-size:0.6em; color:#666;">æ”»æ“ŠåŠ›</div>
                <div id="ui-atk" style="font-size:1em; font-weight:bold;">0</div>
            </div>
            <div style="text-align:center; background:#222; padding:6px; border-radius:5px;">
                <div style="font-size:0.6em; color:#666;">é˜²ç¦¦åŠ›</div>
                <div id="ui-def" style="font-size:1em; font-weight:bold;">0</div>
            </div>
            <div style="text-align:center; background:#222; padding:6px; border-radius:5px; grid-column: 1 / -1;">
                <div style="font-size:0.6em; color:#666;">æš´æ“Šç‡</div>
                <div id="ui-crit" style="font-size:1em; font-weight:bold;">0%</div>
            </div>
        </div>
        <div class="equipment-info">
            <div style="color:#666; margin-bottom:4px;">ç›®å‰è£å‚™</div>
            <div class="equipment-item">
                <div id="ui-weapon" style="color:var(--r-rare); font-size:0.8em;">æ­¦å™¨: - ç„¡ -</div>
                <div id="weapon-desc" style="font-size:0.6em; color:#888;">ç„¡æ•ˆæœ</div>
            </div>
            <div class="equipment-item">
                <div id="ui-armor" style="color:var(--r-rare); font-size:0.8em;">ç›”ç”²: - ç„¡ -</div>
                <div id="armor-desc" style="font-size:0.6em; color:#888;">ç„¡æ•ˆæœ</div>
            </div>
        </div>
    </aside>

    <main class="panel main-stage" id="stage">
        <div id="adventure-page" class="stage-page active">
            <div id="enemy-sprite" class="enemy-sprite">ğŸŒ²</div>
            
            <div id="event-name" style="font-size:1.5em; font-weight:bold; text-align:center;">å†’éšªè€…,æ­¡è¿</div>
            <div id="event-desc" style="color:#888; margin-top:6px; text-align:center; max-width:90%; font-size:0.85em;">åœ¨å³å´é¸æ“‡ä½ çš„å‡ºèº«,é–‹å§‹é€™æ®µå‚³å¥‡...</div>
        </div>

        <div id="boss-warning" class="boss-warning" style="display:none; width:90%; position: absolute; top: 15px; left: 50%; transform: translateX(-50%);">
            <div class="boss-warning-title">âš¡ BOSS ä¾†è‡¨ âš¡</div>
            <div style="color:#ffab00; font-size:0.8em;">é€™æ˜¯ç¬¬ <span id="boss-number">0</span> å°Š Bossï¼</div>
        </div>
        
        <div id="enemy-panel" class="enemy-ui" style="display:none; position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);">
            <div class="enemy-stats">
                <span>âš”ï¸ ATK: <span id="enemy-atk">0</span></span>
                <span id="enemy-hp-text">0/0</span>
            </div>
            <div class="bar-container" style="height:10px;"><div id="enemy-hp-bar" class="bar-fill hp-fill"></div></div>
        </div>

        <div id="shop-page" class="shop-page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">ğŸª å•†åº—</h2>
                <button class="btn" onclick="Game.closeShop()" style="padding:5px 10px; font-size:0.75em;">â† è¿”å›</button>
            </div>
            <div class="shop-category-tabs">
                <button class="btn active" onclick="UI.switchShopCategory('potion')">ğŸ§ª è—¥æ°´</button>
                <button class="btn" onclick="UI.switchShopCategory('weapon')">âš”ï¸ æ­¦å™¨</button>
                <button class="btn" onclick="UI.switchShopCategory('armor')">ğŸ›¡ï¸ ç›”ç”²</button>
                <button class="btn" onclick="UI.switchShopCategory('material')">ğŸ“¦ ç´ æ</button>
            </div>
            <div id="shop-potion" class="shop-grid shop-category active"></div>
            <div id="shop-weapon" class="shop-grid shop-category"></div>
            <div id="shop-armor" class="shop-grid shop-category"></div>
            <div id="shop-material" class="shop-grid shop-category"></div>
        </div>

        <div id="forge-page" class="forge-page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">âš’ï¸ é›é€ å ´</h2>
                <button class="btn" onclick="Game.closeForge()" style="padding:5px 10px; font-size:0.75em;">â† è¿”å›</button>
            </div>
            <div id="recipe-list" class="recipe-list"></div>
        </div>
    </main>

    <section class="control-area">
        <div class="panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; padding:5px;">
            <button class="btn" id="skill-1" onclick="Combat.useSkill(1)">å¼·åŠ›æ“Š<br><small id="sk1-val" style="color:var(--accent); font-size:0.7em">0</small></button>
            <button class="btn" id="skill-2" onclick="Combat.useSkill(2)">æ²»ç™’è¡“<br><small id="sk2-val" style="color:var(--success); font-size:0.7em">0</small></button>
            <button class="btn" id="skill-3" onclick="Combat.useSkill(3)">é›·é³´æ–¬<br><small id="sk3-val" style="color:var(--mana); font-size:0.7em">0</small></button>
        </div>
        <div class="panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; padding:5px;">
            <button id="btn-explore" class="btn btn-exp" onclick="Game.explore()">ğŸ¾ å†’éšª</button>
            <button id="btn-attack" class="btn btn-atk" onclick="Combat.playerAttack()" disabled>âš”ï¸ æ”»æ“Š</button>
            <button id="btn-flee" class="btn" onclick="Combat.flee()" disabled>ğŸƒ é€ƒè·‘</button>
        </div>
        <div class="panel" style="display:grid; grid-template-columns:1fr 1fr; gap:5px; padding:5px;">
            <button id="btn-shop" class="btn btn-shop" onclick="Game.openShop()">ğŸª å•†åº—</button>
            <button id="btn-craft" class="btn btn-craft" onclick="Game.openForge()">âš’ï¸ é›é€ </button>
        </div>
        <div id="combat-warning" style="display: none; color: #ff9800; font-size: 0.75em; text-align: center; margin-top: 5px;">æˆ°é¬¥ä¸­ç„¡æ³•é€²å…¥å•†åº—æˆ–é›é€ </div>
    </section>

    <aside class="panel" style="min-height: 0; overflow: hidden; display: flex; flex-direction: column;">
        <div class="tabs-container">
            <button class="btn active" onclick="UI.switchTab('bag', this)">ğŸ’ èƒŒåŒ…</button>
            <button class="btn" onclick="UI.switchTab('log', this)">ğŸ“œ æ—¥èªŒ</button>
        </div>
        
        <div id="bag-tab" class="tab-content active">
            <div class="bag-category-tabs">
                <button class="btn active" onclick="UI.switchBagCategory('all')">ğŸ“¦ å…¨éƒ¨</button>
                <button class="btn" onclick="UI.switchBagCategory('potion')">ğŸ§ª è—¥æ°´</button>
                <button class="btn" onclick="UI.switchBagCategory('weapon')">âš”ï¸ æ­¦å™¨</button>
                <button class="btn" onclick="UI.switchBagCategory('armor')">ğŸ›¡ï¸ ç›”ç”²</button>
                <button class="btn" onclick="UI.switchBagCategory('material')">ğŸ”§ ç´ æ</button>
            </div>
            <div class="grid-list" id="bag-grid"></div>
        </div>
        <div id="log-tab" class="tab-content"></div>
    </aside>
</div>

<div id="item-modal" class="modal-overlay">
    <div class="modal-box">
        <div id="m-icon" style="font-size:3em;"></div>
        <h2 id="m-title" style="font-size:1.1em; margin: 5px 0;"></h2>
        <div id="m-rarity" style="margin-bottom:6px; font-weight:bold; font-size:0.8em;"></div>
        <p id="m-desc" style="color:#aaa; margin-bottom:10px; font-size:0.8em;"></p>
        <div id="m-stats" style="margin-bottom:10px; font-size:0.8em; color:#ccc;"></div>
        <div style="display:flex; gap:6px;">
            <button class="btn" style="flex:1" onclick="UI.closeModal()">é—œé–‰</button>
            <button id="m-action" class="btn btn-exp" style="flex:1">åŸ·è¡Œ</button>
        </div>
    </div>
</div>

<div id="dead-modal" class="modal-overlay">
    <div class="modal-box">
        <div style="font-size:3.5em; margin-bottom:12px;">ğŸ’€</div>
        <h2 style="color:var(--danger); margin-bottom:6px; font-size:1.3em;">å†’éšªè€…æˆ°æ­»</h2>
        <p style="color:#aaa; margin-bottom:15px; line-height:1.5; font-size:0.85em;">
            ä½ çš„å‚³å¥‡æ­¢æ­¥æ–¼ç¬¬ <span id="dead-depth">0</span> å±¤<br>
            æ“Šæ•—äº† <span id="dead-bosses">0</span> å€‹BOSS<br>
            æœ€çµ‚ç­‰ç´š: Lv.<span id="dead-level">1</span>
        </p>
        <div>
            <button class="restart-btn" onclick="Game.restart()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
        <p style="color:#666; font-size:0.8em; margin-top:12px;">ä½ çš„å‹‡æ°£å°‡è¢«å¾Œä¸–å‚³é Œ...</p>
    </div>
</div>

<div id="start-modal" class="modal-overlay" style="display:flex;">
    <div class="modal-box" style="width:90%; max-width:650px; max-height:85vh;">
        <h2 style="color:var(--accent); margin-bottom:6px; font-size:1.3em;">âš”ï¸ é¸æ“‡ä½ çš„å‚³å¥‡èµ·é»</h2>
        <p style="color:#888; margin-bottom:15px; font-size:0.85em;">æ¯å€‹è·æ¥­éƒ½æœ‰ç¨ç‰¹çš„æˆé•·å„ªå‹¢ã€‚</p>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">
            <div class="btn class-card" onclick="startGame('knight')">
                <div style="font-size:2.2em;">âš”ï¸</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">é¨å£«</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>â¤ï¸ HP: 180</div>
                        <div>âš¡ MP: 80</div>
                        <div>âš”ï¸ ATK: 12 | ğŸ›¡ï¸ DEF: 3</div>
                        <div style="color:#888; margin-top:5px;">é˜²ç¦¦åŠ›å¼·,ç”Ÿå­˜èƒ½åŠ›æœ€é«˜</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="startGame('thief')">
                <div style="font-size:2.2em;">ğŸ—¡ï¸</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">ç›œè³Š</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>â¤ï¸ HP: 110</div>
                        <div>âš¡ MP: 100</div>
                        <div>âš”ï¸ ATK: 18 | æš´æ“Š: 15%</div>
                        <div style="color:#888; margin-top:5px;">é«˜å‚·å®³èˆ‡æš´æ“Š,æ”»é€Ÿè¿…æ·</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="startGame('mage')">
                <div style="font-size:2.2em;">ğŸ§™</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">æ³•å¸«</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>â¤ï¸ HP: 90</div>
                        <div>âš¡ MP: 200</div>
                        <div>âš”ï¸ ATK: 10</div>
                        <div style="color:#888; margin-top:5px;">é­”æ³•è±æ²›,æŠ€èƒ½ç„¡é™æ–½æ”¾</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="startGame('ranger')">
                <div style="font-size:2.2em;">ğŸ¹</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">çµäºº</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>â¤ï¸ HP: 130</div>
                        <div>âš¡ MP: 120</div>
                        <div>âš”ï¸ ATK: 16 | æš´æ“Š: 12%</div>
                        <div style="color:#888; margin-top:5px;">å‡è¡¡ç™¼å±•,ç©©å®šè¼¸å‡º</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// æˆ°é¬¥é–å®šç‹€æ…‹
let isCombatAction = false;
let currentBagCategory = 'all';
let currentShopCategory = 'potion';

function startGame(cls) {
    Game.init(cls);
}

// æ“´å±•çš„éŠæˆ²æ•¸æ“šåº«
const DB = {
    monsters: [
        // åˆç´šæ€ªç‰©
        { name: "å²èŠå§†", hp: 30, atk: 4, icon: "ğŸŸ¢", rarity: 1 },
        { name: "å°è™è ", hp: 25, atk: 5, icon: "ğŸ¦‡", rarity: 1 },
        { name: "å“¥å¸ƒæ—", hp: 45, atk: 7, icon: "ğŸ‘¹", rarity: 1 },
        { name: "éª·é«å…µ", hp: 55, atk: 9, icon: "ğŸ’€", rarity: 1 },
        { name: "æ³¥æ²¼æ€ª", hp: 65, atk: 8, icon: "ğŸŸ¤", rarity: 1 },
        
        // ä¸­ç´šæ€ªç‰©
        { name: "é‡ç‹¼", hp: 80, atk: 12, icon: "ğŸº", rarity: 2 },
        { name: "çŸ³åƒé¬¼", hp: 100, atk: 15, icon: "ğŸ—¿", rarity: 2 },
        { name: "æ¯’èœ˜è››", hp: 70, atk: 18, icon: "ğŸ•·ï¸", rarity: 2 },
        { name: "å¹½éˆ", hp: 90, atk: 14, icon: "ğŸ‘»", rarity: 2 },
        { name: "å·¨èŸ»", hp: 85, atk: 16, icon: "ğŸœ", rarity: 2 },
        
        // é«˜ç´šæ€ªç‰©
        { name: "ç«ç„°å…ƒç´ ", hp: 150, atk: 25, icon: "ğŸ”¥", rarity: 3 },
        { name: "å†°éœœç²¾éˆ", hp: 140, atk: 22, icon: "â„ï¸", rarity: 3 },
        { name: "é›·é›»ç¸", hp: 160, atk: 28, icon: "âš¡", rarity: 3 },
        { name: "å²©æ¼¿æ€ª", hp: 180, atk: 32, icon: "ğŸŒ‹", rarity: 3 },
        { name: "æš—å½±è±¹", hp: 130, atk: 30, icon: "ğŸ†", rarity: 3 },
        
        // ç¨€æœ‰æ€ªç‰©
        { name: "ç¨çœ¼å·¨äºº", hp: 250, atk: 40, icon: "ğŸ‘ï¸", rarity: 4 },
        { name: "é›™é ­çŠ¬", hp: 220, atk: 35, icon: "ğŸ•â€ğŸ¦º", rarity: 4 },
        { name: "é£›é¾", hp: 300, atk: 45, icon: "ğŸ²", rarity: 4 },
        { name: "æµ·æ€ª", hp: 280, atk: 38, icon: "ğŸ™", rarity: 4 },
        { name: "æ¨¹ç²¾", hp: 240, atk: 33, icon: "ğŸŒ³", rarity: 4 }
    ],
    
    bosses: [
        { name: "ç«ç„°ä¹‹ç‹", hp: 800, atk: 100, icon: "ğŸ”¥ğŸ‘‘", rarity: 5 },
        { name: "å†°éœœå¥³çš‡", hp: 900, atk: 110, icon: "â„ï¸ğŸ‘‘", rarity: 5 },
        { name: "é›·éœ†æ³°å¦", hp: 1000, atk: 120, icon: "âš¡ğŸ‘‘", rarity: 5 },
        { name: "æ·±æ·µé ˜ä¸»", hp: 1200, atk: 140, icon: "ğŸ‘¿ğŸ‘‘", rarity: 5 },
        { name: "è–å…‰å¤©ä½¿", hp: 1100, atk: 130, icon: "ğŸ‘¼ğŸ‘‘", rarity: 5 }
    ],
    
    // ç‰©å“æ•¸æ“šåº«
    items: {
        // è—¥æ°´é¡
        "å°å‹ç´…è—¥æ°´": { type: "potion", category: "potion", effect: "hp", val: 80, price: 15, icon: "ğŸ§ª", r: "common", desc: "æ¢å¾© 80 HP" },
        "ä¸­å‹ç´…è—¥æ°´": { type: "potion", category: "potion", effect: "hp", val: 200, price: 45, icon: "ğŸ§ª", r: "rare", desc: "æ¢å¾© 200 HP" },
        "å¤§å‹ç´…è—¥æ°´": { type: "potion", category: "potion", effect: "hp", val: 500, price: 100, icon: "ğŸ§ª", r: "epic", desc: "æ¢å¾© 500 HP" },
        "å°å‹è—è—¥æ°´": { type: "potion", category: "potion", effect: "mp", val: 60, price: 15, icon: "ğŸ’§", r: "common", desc: "æ¢å¾© 60 MP" },
        "ä¸­å‹è—è—¥æ°´": { type: "potion", category: "potion", effect: "mp", val: 150, price: 40, icon: "ğŸ’§", r: "rare", desc: "æ¢å¾© 150 MP" },
        "å¤§å‹è—è—¥æ°´": { type: "potion", category: "potion", effect: "mp", val: 300, price: 80, icon: "ğŸ’§", r: "epic", desc: "æ¢å¾© 300 MP" },
        "å…¨æ¢å¾©è—¥æ°´": { type: "potion", category: "potion", effect: "both", val: 999, price: 200, icon: "ğŸŒŸ", r: "epic", desc: "æ¢å¾©å…¨éƒ¨HPå’ŒMP" },
        
        // æ­¦å™¨é¡
        "æœ¨åŠ": { type: "weapon", category: "weapon", atk: 10, price: 30, icon: "ğŸªµ", r: "common", desc: "ATK +10" },
        "éµåŠ": { type: "weapon", category: "weapon", atk: 25, price: 80, icon: "ğŸ—¡ï¸", r: "common", desc: "ATK +25" },
        "é‹¼éµé•·åŠ": { type: "weapon", category: "weapon", atk: 45, price: 150, icon: "âš”ï¸", r: "rare", desc: "ATK +45" },
        "éŠ€è£½é•·åŠ": { type: "weapon", category: "weapon", atk: 65, price: 250, icon: "ğŸ”ª", r: "rare", desc: "ATK +65" },
        "é­”åŠ›æ³•æ–": { type: "weapon", category: "weapon", atk: 40, price: 180, icon: "ğŸª„", r: "rare", desc: "ATK +40 (é­”æ³•åŠ æˆ)" },
        "ç«ç„°åŠ": { type: "weapon", category: "weapon", atk: 85, price: 400, icon: "ğŸ”¥ğŸ—¡ï¸", r: "epic", desc: "ATK +85 (ç«ç„°å±¬æ€§)" },
        "å†°éœœä¹‹åˆƒ": { type: "weapon", category: "weapon", atk: 90, price: 450, icon: "â„ï¸ğŸ—¡ï¸", r: "epic", desc: "ATK +90 (å†°éœœå±¬æ€§)" },
        "è‹±é›„ä¹‹åˆƒ": { type: "weapon", category: "weapon", atk: 120, price: 800, icon: "âœ¨", r: "epic", desc: "ATK +120" },
        "è–åŠè‰¾å…‹æ–¯": { type: "weapon", category: "weapon", atk: 200, price: 2000, icon: "ğŸ”±", r: "legend", desc: "ATK +200 (ç¥è–å±¬æ€§)" },
        "é¾ç‰™åŠ": { type: "weapon", category: "weapon", atk: 180, price: 1500, icon: "ğŸ‰ğŸ—¡ï¸", r: "legend", desc: "ATK +180 (é¾æ—ä¹‹åŠ›)" },
        
        // ç›”ç”²é¡ (æ–°å¢)
        "å¸ƒè¡£": { type: "armor", category: "armor", hp: 20, def: 1, price: 40, icon: "ğŸ‘•", r: "common", desc: "HP +20, DEF +1" },
        "çš®ç”²": { type: "armor", category: "armor", hp: 50, def: 3, price: 100, icon: "ğŸ§¥", r: "common", desc: "HP +50, DEF +3" },
        "é–å­ç”²": { type: "armor", category: "armor", hp: 100, def: 5, price: 250, icon: "ğŸ¥¼", r: "rare", desc: "HP +100, DEF +5" },
        "é‹¼éµç›”ç”²": { type: "armor", category: "armor", hp: 200, def: 8, price: 500, icon: "ğŸ¤–", r: "rare", desc: "HP +200, DEF +8" },
        "é­”æ³•è¢": { type: "armor", category: "armor", hp: 150, def: 4, mp: 50, price: 400, icon: "ğŸ§™â€â™‚ï¸", r: "rare", desc: "HP +150, DEF +4, MP +50" },
        "é¾é±—ç”²": { type: "armor", category: "armor", hp: 300, def: 12, price: 1000, icon: "ğŸ‰ğŸ›¡ï¸", r: "epic", desc: "HP +300, DEF +12" },
        "è–é¨å£«ç›”ç”²": { type: "armor", category: "armor", hp: 400, def: 15, price: 1500, icon: "âšœï¸", r: "epic", desc: "HP +400, DEF +15" },
        "ç¥è–æˆ°ç”²": { type: "armor", category: "armor", hp: 500, def: 20, price: 2500, icon: "âœ¨ğŸ›¡ï¸", r: "legend", desc: "HP +500, DEF +20" },
        
        // ç´ æé¡
        "æœ¨æ": { type: "material", category: "material", price: 5, icon: "ğŸªµ", r: "common", desc: "åŸºç¤æœ¨æ" },
        "éµç¤¦çŸ³": { type: "material", category: "material", price: 10, icon: "ğŸª¨", r: "common", desc: "éµè£½å“çš„åŸæ–™" },
        "éŠ…ç¤¦çŸ³": { type: "material", category: "material", price: 15, icon: "ğŸ¥‰", r: "common", desc: "éŠ…è£½å“çš„åŸæ–™" },
        "éŠ€ç¤¦çŸ³": { type: "material", category: "material", price: 30, icon: "ğŸ¥ˆ", r: "common", desc: "éŠ€è£½å“çš„åŸæ–™" },
        "é‡‘ç¤¦çŸ³": { type: "material", category: "material", price: 50, icon: "ğŸ¥‡", r: "rare", desc: "é‡‘è£½å“çš„åŸæ–™" },
        "ç¸çš®": { type: "material", category: "material", price: 8, icon: "ğŸº", r: "common", desc: "é‡ç¸çš„çš®æ¯›" },
        "å°–ç‰™": { type: "material", category: "material", price: 12, icon: "ğŸ¦·", r: "common", desc: "æ€ªç‰©çš„å°–ç‰™" },
        "çˆªå­": { type: "material", category: "material", price: 15, icon: "ğŸ¾", r: "common", desc: "æ€ªç‰©çš„åˆ©çˆª" },
        "ç¾½æ¯›": { type: "material", category: "material", price: 10, icon: "ğŸª¶", r: "common", desc: "é³¥é¡çš„ç¾½æ¯›" },
        "é­”æ³•çµæ™¶": { type: "material", category: "material", price: 40, icon: "ğŸ’", r: "rare", desc: "è˜Šå«é­”åŠ›çš„æ™¶é«”" },
        "éˆé­‚ç¢ç‰‡": { type: "material", category: "material", price: 60, icon: "ğŸ‘»", r: "rare", desc: "æ€ªç‰©éˆé­‚çš„ç¢ç‰‡" },
        "ç«ç„°ä¹‹å¿ƒ": { type: "material", category: "material", price: 80, icon: "â¤ï¸â€ğŸ”¥", r: "rare", desc: "ç«ç„°å…ƒç´ çš„ç²¾è¯" },
        "å†°éœœæ ¸å¿ƒ": { type: "material", category: "material", price: 80, icon: "â„ï¸", r: "rare", desc: "å†°éœœå…ƒç´ çš„ç²¾è¯" },
        "é›·é›»ä¹‹æ ¸": { type: "material", category: "material", price: 80, icon: "âš¡", r: "rare", desc: "é›·é›»å…ƒç´ çš„ç²¾è¯" },
        "é¾é±—": { type: "material", category: "material", price: 150, icon: "ğŸ‰", r: "epic", desc: "å‚³èªªç”Ÿç‰©çš„é±—ç‰‡" },
        "é³³å‡°ä¹‹ç¾½": { type: "material", category: "material", price: 200, icon: "ğŸ¦š", r: "epic", desc: "é³³å‡°çš„ç¥è–ç¾½æ¯›" },
        "æƒ¡é­”è§’": { type: "material", category: "material", price: 180, icon: "ğŸ‘¿", r: "epic", desc: "æƒ¡é­”çš„è§’" },
        "å¤©ä½¿ä¹‹ç¾½": { type: "material", category: "material", price: 250, icon: "ğŸ‘¼", r: "legend", desc: "å¤©ä½¿çš„ç´”ç™½ç¾½æ¯›" },
        "æ˜Ÿè¾°ç¢ç‰‡": { type: "material", category: "material", price: 300, icon: "â­", r: "legend", desc: "å¢œè½æ˜Ÿè¾°çš„ç¢ç‰‡" },
        "ç¥ä¹‹è¡€": { type: "material", category: "material", price: 500, icon: "ğŸ©¸", r: "mythic", desc: "ç¥æ˜çš„è¡€æ¶²" },
        
        // è­·ç¬¦é¡
        "åŠ›é‡è­·ç¬¦": { type: "buff", category: "material", stat: "atk", val: 10, price: 200, icon: "ğŸ’", r: "rare", desc: "æ°¸ä¹… ATK +10" },
        "é˜²ç¦¦è­·ç¬¦": { type: "buff", category: "material", stat: "def", val: 5, price: 150, icon: "ğŸ›¡ï¸", r: "rare", desc: "æ°¸ä¹… DEF +5" },
        "ç”Ÿå‘½è­·ç¬¦": { type: "buff", category: "material", stat: "maxHp", val: 50, price: 180, icon: "â¤ï¸", r: "rare", desc: "æ°¸ä¹… MaxHP +50" },
        "é­”åŠ›è­·ç¬¦": { type: "buff", category: "material", stat: "maxMp", val: 30, price: 160, icon: "ğŸŒ€", r: "rare", desc: "æ°¸ä¹… MaxMP +30" },
        "æš´æ“Šå¯¶ç ": { type: "buff", category: "material", stat: "crit", val: 8, price: 250, icon: "âœ¨", r: "epic", desc: "æš´æ“Šç‡ +8%" }
    },
    
    // åˆæˆé…æ–¹ (æ–°å¢ç™¾åˆ†æ¯”è£å‚™)
    recipes: [
        {
            id: 1,
            name: "éµåŠ",
            icon: "ğŸ—¡ï¸",
            result: "éµåŠ",
            desc: "åŸºç¤æ­¦å™¨ï¼Œå¢åŠ 25é»æ”»æ“ŠåŠ›",
            materials: [
                { name: "éµç¤¦çŸ³", amount: 5 },
                { name: "æœ¨æ", amount: 3 }
            ]
        },
        {
            id: 2,
            name: "é‹¼éµé•·åŠ",
            icon: "âš”ï¸",
            result: "é‹¼éµé•·åŠ",
            desc: "å …å›ºçš„é‹¼åŠï¼Œå¢åŠ 45é»æ”»æ“ŠåŠ›",
            materials: [
                { name: "éµç¤¦çŸ³", amount: 8 },
                { name: "éŠ…ç¤¦çŸ³", amount: 3 },
                { name: "ç¸çš®", amount: 2 }
            ]
        },
        {
            id: 3,
            name: "é–å­ç”²",
            icon: "ğŸ¥¼",
            result: "é–å­ç”²",
            desc: "é˜²è­·ç›”ç”²ï¼Œå¢åŠ 100HPå’Œ5é»é˜²ç¦¦",
            materials: [
                { name: "éµç¤¦çŸ³", amount: 10 },
                { name: "éŠ…ç¤¦çŸ³", amount: 5 },
                { name: "ç¸çš®", amount: 3 }
            ]
        },
        {
            id: 4,
            name: "é¾é±—ç”²",
            icon: "ğŸ‰ğŸ›¡ï¸",
            result: "é¾é±—ç”²",
            desc: "å‚³èªªé¾é±—è£½æˆçš„ç›”ç”²ï¼Œå¢åŠ 300HPå’Œ12é»é˜²ç¦¦",
            materials: [
                { name: "é¾é±—", amount: 5 },
                { name: "é‡‘ç¤¦çŸ³", amount: 10 },
                { name: "é­”æ³•çµæ™¶", amount: 8 }
            ]
        },
        {
            id: 5,
            name: "ç«ç„°åŠ",
            icon: "ğŸ”¥ğŸ—¡ï¸",
            result: "ç«ç„°åŠ",
            desc: "é™„é­”ç«ç„°ä¹‹åŠï¼Œå¢åŠ 85é»æ”»æ“ŠåŠ›",
            materials: [
                { name: "éµç¤¦çŸ³", amount: 10 },
                { name: "ç«ç„°ä¹‹å¿ƒ", amount: 3 },
                { name: "é­”æ³•çµæ™¶", amount: 2 }
            ]
        },
        {
            id: 6,
            name: "ç”Ÿå‘½ä¹‹æºè­·ç”²",
            icon: "ğŸŒ¿ğŸ›¡ï¸",
            result: "ç”Ÿå‘½ä¹‹æºè­·ç”²",
            type: "armor",
            hpPercent: 15, // å¢åŠ 15%æœ€å¤§ç”Ÿå‘½å€¼
            def: 8,
            price: 0,
            r: "mythic",
            desc: "ç¥ç§˜è­·ç”²ï¼Œå¢åŠ 15%æœ€å¤§ç”Ÿå‘½å€¼å’Œ8é»é˜²ç¦¦",
            materials: [
                { name: "å¤©ä½¿ä¹‹ç¾½", amount: 2 },
                { name: "æ˜Ÿè¾°ç¢ç‰‡", amount: 3 },
                { name: "é­”æ³•çµæ™¶", amount: 10 },
                { name: "ç¥ä¹‹è¡€", amount: 1 }
            ]
        },
        {
            id: 7,
            name: "ä¸æœ½æˆ°ç”²",
            icon: "â™¾ï¸ğŸ›¡ï¸",
            result: "ä¸æœ½æˆ°ç”²",
            type: "armor",
            hpPercent: 25, // å¢åŠ 25%æœ€å¤§ç”Ÿå‘½å€¼
            def: 15,
            price: 0,
            r: "mythic",
            desc: "ç¥ç´šæˆ°ç”²ï¼Œå¢åŠ 25%æœ€å¤§ç”Ÿå‘½å€¼å’Œ15é»é˜²ç¦¦",
            materials: [
                { name: "ç¥ä¹‹è¡€", amount: 3 },
                { name: "æ˜Ÿè¾°ç¢ç‰‡", amount: 5 },
                { name: "é¾é±—", amount: 10 },
                { name: "é³³å‡°ä¹‹ç¾½", amount: 5 }
            ]
        },
        {
            id: 8,
            name: "è–åŠè‰¾å…‹æ–¯",
            icon: "ğŸ”±",
            result: "è–åŠè‰¾å…‹æ–¯",
            desc: "ç¥è–å‚³èªªä¹‹åŠï¼Œå¢åŠ 200é»æ”»æ“ŠåŠ›",
            materials: [
                { name: "å¤©ä½¿ä¹‹ç¾½", amount: 2 },
                { name: "æ˜Ÿè¾°ç¢ç‰‡", amount: 3 },
                { name: "é‡‘ç¤¦çŸ³", amount: 8 },
                { name: "é­”æ³•çµæ™¶", amount: 5 }
            ]
        }
    ]
};

// ç©å®¶ç‹€æ…‹
const Player = {
    hp: 100, maxHp: 100, mp: 100, maxMp: 100,
    atk: 10, crit: 5, def: 0, gold: 50,
    depth: 0, level: 1, exp: 0, maxExp: 100,
    bag: [], weapon: null, armor: null, class: "",
    materials: {},
    baseMaxHp: 100, // ç”¨æ–¼è¨ˆç®—ç™¾åˆ†æ¯”åŠ æˆçš„åŸºç¤ç”Ÿå‘½å€¼
    equipmentHpBonus: 0, // è£å‚™æä¾›çš„å›ºå®šHPåŠ æˆ
    equipmentHpPercent: 0 // è£å‚™æä¾›çš„ç™¾åˆ†æ¯”HPåŠ æˆ
};

// éŠæˆ²ä¸»é‚è¼¯
const Game = {
    state: "idle",
    enemy: null,
    bossCount: 0,
    currentPage: "adventure",

    init(clsId) {
        // è·æ¥­åˆå§‹åŒ–
        if(clsId === 'knight'){ 
            Player.class = "é¨å£«"; 
            Player.maxHp = 180; Player.hp = 180; 
            Player.baseMaxHp = 180;
            Player.atk = 12; Player.def = 3; 
            Player.maxMp = 80; Player.mp = 80; 
        }
        else if(clsId === 'thief'){ 
            Player.class = "ç›œè³Š"; 
            Player.maxHp = 110; Player.hp = 110;
            Player.baseMaxHp = 110;
            Player.atk = 18; Player.crit = 15; 
            Player.maxMp = 100; Player.mp = 100; 
        }
        else if(clsId === 'mage'){ 
            Player.class = "æ³•å¸«"; 
            Player.maxHp = 90; Player.hp = 90;
            Player.baseMaxHp = 90;
            Player.atk = 10; 
            Player.maxMp = 200; Player.mp = 200; 
        }
        else if(clsId === 'ranger'){ 
            Player.class = "çµäºº"; 
            Player.maxHp = 130; Player.hp = 130;
            Player.baseMaxHp = 130;
            Player.atk = 16; Player.crit = 12; 
            Player.maxMp = 120; Player.mp = 120; 
        }
        
        // é‡ç½®æ‰€æœ‰ç‹€æ…‹
        Player.depth = 0;
        Player.level = 1;
        Player.exp = 0;
        Player.maxExp = 100;
        Player.gold = 50;
        Player.bag = [];
        Player.weapon = null;
        Player.armor = null;
        Player.materials = {};
        Player.equipmentHpBonus = 0;
        Player.equipmentHpPercent = 0;
        Game.bossCount = 0;
        Game.currentPage = "adventure";
        isCombatAction = false;
        currentBagCategory = 'all';
        currentShopCategory = 'potion';
        
        document.getElementById('start-modal').style.display = 'none';
        this.addItem("å°å‹ç´…è—¥æ°´");
        this.next();
    },

    next() {
        this.state = "idle";
        isCombatAction = false;
        this.showPage("adventure");
        UI.renderStage("ğŸŒ²", "æ£®æ—å°å¾‘", "é¸æ“‡å†’éšªæˆ–é›é€ ...", false);
        UI.update();
        this.updateButtons();
    },

    showPage(page) {
        this.currentPage = page;
        document.getElementById('adventure-page').classList.remove('active');
        document.getElementById('shop-page').classList.remove('active');
        document.getElementById('forge-page').classList.remove('active');
        
        document.getElementById(page + '-page').classList.add('active');
        
        this.updateButtons();
    },

    updateButtons() {
        const inCombat = this.state === 'combat';
        const isAdventure = this.currentPage === 'adventure';
        
        document.getElementById('btn-explore').disabled = inCombat || !isAdventure;
        document.getElementById('btn-attack').disabled = !inCombat || !isAdventure;
        document.getElementById('btn-flee').disabled = !inCombat || !isAdventure;
        
        // æˆ°é¬¥ä¸­ç‰¹æ®Šè™•ç†å•†åº—å’Œé›é€ æŒ‰éˆ•
        const shopBtn = document.getElementById('btn-shop');
        const craftBtn = document.getElementById('btn-craft');
        
        shopBtn.disabled = inCombat;
        craftBtn.disabled = inCombat;
        
        if (inCombat) {
            shopBtn.classList.add('combat-disabled');
            craftBtn.classList.add('combat-disabled');
            document.getElementById('combat-warning').style.display = 'block';
        } else {
            shopBtn.classList.remove('combat-disabled');
            craftBtn.classList.remove('combat-disabled');
            document.getElementById('combat-warning').style.display = 'none';
        }
        
        shopBtn.innerHTML = inCombat ? 'ğŸª å•†åº—<br><small style="font-size:0.6em">æˆ°é¬¥ä¸­</small>' : 'ğŸª å•†åº—';
        craftBtn.innerHTML = inCombat ? 'âš’ï¸ é›é€ <br><small style="font-size:0.6em">æˆ°é¬¥ä¸­</small>' : 'âš’ï¸ é›é€ ';
    },

    openShop() {
        if (this.state === 'combat') return;
        this.showPage("shop");
        UI.renderShop();
        UI.log("é€²å…¥äº†å•†åº—");
    },

    closeShop() {
        this.showPage("adventure");
    },

    openForge() {
        if (this.state === 'combat') return;
        this.showPage("forge");
        UI.renderRecipes();
        UI.log("é€²å…¥äº†é›é€ å ´");
    },

    closeForge() {
        this.showPage("adventure");
    },

    explore() {
        if (this.currentPage !== 'adventure') return;
        
        Player.depth++;
        UI.log(`æ·±å…¥åˆ°ç¬¬ ${Player.depth} å±¤`);
        if (Player.depth > 0 && Player.depth % 100 === 0) {
            this.triggerBoss();
        } else {
            this.triggerCombat();
        }
    },

    triggerCombat() {
        this.state = "combat";
        const lvl = Math.max(0, Math.floor((Player.depth - 1) / 5));
        const idx = Math.min(DB.monsters.length - 1, lvl);
        const m = DB.monsters[idx];
        const growth = 1 + (Player.depth * 0.08);
        this.enemy = { 
            ...m, 
            hp: Math.floor(m.hp * growth), 
            maxHp: Math.floor(m.hp * growth),
            atk: Math.floor(m.atk * growth)
        };
        UI.renderStage(this.enemy.icon, this.enemy.name, "æº–å‚™æˆ°é¬¥ï¼", true);
        this.updateButtons();
        UI.update();
    },

    triggerBoss() {
        this.state = "combat";
        this.bossCount++;
        const boss = DB.bosses[(this.bossCount - 1) % DB.bosses.length];
        const growth = 1 + (Player.depth * 0.15);
        this.enemy = {
            ...boss,
            hp: Math.floor(boss.hp * growth),
            maxHp: Math.floor(boss.hp * growth),
            atk: Math.floor(boss.atk * growth),
            isBoss: true
        };
        document.getElementById('boss-warning').style.display = 'block';
        document.getElementById('boss-number').innerText = this.bossCount;
        UI.renderStage(this.enemy.icon, `${this.enemy.name} (BOSS)`, "å¼·å¤§çš„æ•µäººå‡ºç¾ï¼", true);
        this.updateButtons();
        UI.update();
    },

    addItem(name) {
        Player.bag.push({ name, ...DB.items[name] });
        UI.log(`ç²å¾—: ${name}`);
        UI.update();
    },

    addMaterial(name, amount = 1) {
        if (!Player.materials[name]) {
            Player.materials[name] = 0;
        }
        Player.materials[name] += amount;
        UI.log(`ç²å¾—ç´ æ: ${name} x${amount}`);
        UI.update();
    },

    removeMaterial(name, amount = 1) {
        if (Player.materials[name] && Player.materials[name] >= amount) {
            Player.materials[name] -= amount;
            if (Player.materials[name] <= 0) {
                delete Player.materials[name];
            }
            return true;
        }
        return false;
    },

    getMaterialCount(name) {
        return Player.materials[name] || 0;
    },

    buyItem(name) {
        const item = DB.items[name];
        if (Player.gold >= item.price) {
            Player.gold -= item.price;
            if (item.category === 'material') {
                this.addMaterial(name);
            } else {
                this.addItem(name);
            }
            UI.log(`è³¼è²·äº† ${name}`);
        } else {
            UI.log("é‡‘å¹£ä¸è¶³ï¼");
        }
    },

    craftItem(recipeId) {
        const recipe = DB.recipes.find(r => r.id === recipeId);
        if (!recipe) return false;
        
        for (const mat of recipe.materials) {
            if (this.getMaterialCount(mat.name) < mat.amount) {
                UI.log(`ç´ æä¸è¶³ï¼éœ€è¦ ${mat.name} x${mat.amount}`);
                return false;
            }
        }
        
        for (const mat of recipe.materials) {
            this.removeMaterial(mat.name, mat.amount);
        }
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ®Šè£å‚™ï¼ˆç™¾åˆ†æ¯”è£å‚™ï¼‰
        if (recipe.result in DB.items) {
            this.addItem(recipe.result);
        } else {
            // é€™æ˜¯ç‰¹æ®Šè£å‚™ï¼Œç›´æ¥æ·»åŠ åˆ°èƒŒåŒ…
            const specialItem = {
                name: recipe.result,
                type: recipe.type || "armor",
                category: recipe.type || "armor",
                icon: recipe.icon,
                r: recipe.r || "rare",
                desc: recipe.desc,
                hp: recipe.hp || 0,
                hpPercent: recipe.hpPercent || 0,
                def: recipe.def || 0,
                atk: recipe.atk || 0,
                isSpecial: true
            };
            Player.bag.push(specialItem);
        }
        
        UI.log(`æˆåŠŸé›é€ äº† ${recipe.name}ï¼`);
        UI.renderRecipes();
        return true;
    },

    gainExp(amount) {
        Player.exp += amount;
        UI.log(`+${amount} EXP`);
        while (Player.exp >= Player.maxExp) {
            Player.exp -= Player.maxExp;
            Player.level++;
            Player.maxExp = Math.floor(Player.maxExp * 1.5);
            
            // è·æ¥­æˆé•·
            if(Player.class === "é¨å£«") { 
                Player.baseMaxHp += 25; Player.atk += 4; Player.def += 2; 
                Player.crit += 0.5;
            }
            else if(Player.class === "ç›œè³Š") { 
                Player.baseMaxHp += 15; Player.atk += 6; Player.crit += 2.5; 
                Player.def += 1;
            }
            else if(Player.class === "æ³•å¸«") { 
                Player.baseMaxHp += 10; Player.maxMp += 40; Player.atk += 4; 
                Player.crit += 1;
            }
            else if(Player.class === "çµäºº") { 
                Player.baseMaxHp += 18; Player.atk += 5; Player.crit += 1.5; 
                Player.def += 1.5;
            }
            
            // é‡æ–°è¨ˆç®—æœ€å¤§ç”Ÿå‘½å€¼ï¼ˆåŒ…æ‹¬è£å‚™åŠ æˆï¼‰
            this.updatePlayerMaxHp();
            Player.hp = Player.maxHp;
            Player.mp = Player.maxMp;
            UI.log(`â­ å‡ç´šåˆ° Lv.${Player.level}ï¼`);
        }
        UI.update();
    },
    
    // æ›´æ–°ç©å®¶çš„æœ€å¤§ç”Ÿå‘½å€¼ï¼ˆè€ƒæ…®åŸºç¤å€¼ã€è£å‚™å›ºå®šåŠ æˆå’Œç™¾åˆ†æ¯”åŠ æˆï¼‰
    updatePlayerMaxHp() {
        const baseHp = Player.baseMaxHp;
        const fixedBonus = Player.equipmentHpBonus;
        const percentBonus = Player.equipmentHpPercent / 100;
        
        Player.maxHp = Math.floor(baseHp * (1 + percentBonus)) + fixedBonus;
        
        // ç¢ºä¿ç•¶å‰HPä¸è¶…éæœ€å¤§HP
        if (Player.hp > Player.maxHp) {
            Player.hp = Player.maxHp;
        }
    },

    rest() {
        if (this.state !== 'idle' || this.currentPage !== 'adventure') return;
        Player.hp = Player.maxHp;
        Player.mp = Player.maxMp;
        UI.log("åœ¨æ­¤ä¼‘æ¯,æ¢å¾©äº†ç²¾åŠ›");
        this.next();
    },
    
    showDeathScreen() {
        document.getElementById('dead-depth').innerText = Player.depth;
        document.getElementById('dead-bosses').innerText = Game.bossCount;
        document.getElementById('dead-level').innerText = Player.level;
        document.getElementById('dead-modal').style.display = 'flex';
    },
    
    restart() {
        document.getElementById('dead-modal').style.display = 'none';
        document.getElementById('start-modal').style.display = 'flex';
    }
};

// æˆ°é¬¥ç³»çµ±
const Combat = {
    playerAttack() {
        if (Game.state !== 'combat' || isCombatAction || Game.currentPage !== 'adventure') return;
        
        isCombatAction = true;
        const base = Player.atk + (Player.weapon ? Player.weapon.atk : 0);
        const isCrit = Math.random() * 100 < Player.crit;
        const dmg = Math.floor(isCrit ? base * 2 : base);
        this.dealDamage(dmg, isCrit);
        
        setTimeout(() => {
            if (Game.state === 'combat' && Game.enemy && Game.enemy.hp > 0) {
                isCombatAction = false;
            }
        }, 800);
    },

    useSkill(id) {
        if ((Game.state !== 'combat' && id !== 2) || isCombatAction || Game.currentPage !== 'adventure') return;
        
        isCombatAction = true;
        const base = Player.atk + (Player.weapon ? Player.weapon.atk : 0);
        
        if (id === 1 && Player.mp >= 20) {
            Player.mp -= 20;
            const dmg = Math.floor(base * 2.2);
            this.dealDamage(dmg, true);
        } else if (id === 2 && Player.mp >= 30) {
            Player.mp -= 30;
            const heal = Math.floor(Player.maxHp * 0.5);
            Player.hp = Math.min(Player.maxHp, Player.hp + heal);
            UI.float(`+${heal}`, "var(--success)");
            UI.log(`ä½¿ç”¨æ²»ç™’è¡“æ¢å¾©äº† ${heal} HP`);
            
            if(Game.state === 'combat' && Game.enemy && Game.enemy.hp > 0) {
                setTimeout(() => {
                    this.enemyTurn();
                    isCombatAction = false;
                }, 800);
            } else {
                isCombatAction = false;
            }
            UI.update();
            return;
        } else if (id === 3 && Player.mp >= 60) {
            Player.mp -= 60;
            const dmg = Math.floor(base * 4.5);
            this.dealDamage(dmg, true);
        } else {
            isCombatAction = false;
            return;
        }
        
        setTimeout(() => {
            if (Game.state === 'combat' && Game.enemy && Game.enemy.hp > 0) {
                isCombatAction = false;
            }
        }, 800);
    },

    dealDamage(dmg, isCrit) {
        Game.enemy.hp -= dmg;
        UI.float(dmg + (isCrit ? "!" : ""), isCrit ? "#ffeb3b" : "white");
        UI.shake();
        UI.log(`ä½ å° ${Game.enemy.name} é€ æˆ ${dmg}${isCrit ? ' (æš´æ“Š)' : ''} å‚·å®³`);
        
        if (Game.enemy.hp <= 0) {
            this.win();
            // æˆ°é¬¥å‹åˆ©æ™‚æ‰è½ç´ æ
            if (Math.random() < 0.7) {
                const commonMats = ["æœ¨æ", "éµç¤¦çŸ³", "ç¸çš®", "å°–ç‰™", "çˆªå­"];
                const randomMat = commonMats[Math.floor(Math.random() * commonMats.length)];
                const amount = 1 + Math.floor(Math.random() * 3);
                Game.addMaterial(randomMat, amount);
            }
        } else {
            setTimeout(() => this.enemyTurn(), 600);
        }
        UI.update();
    },

    enemyTurn() {
        if (Game.state !== 'combat') return;
        
        // ä¿®å¾©ï¼šæ€ªç‰©æ”»æ“ŠåŠ›å°±æ˜¯é¡¯ç¤ºçš„æ•¸å€¼ï¼Œä¸æ¸›é˜²ç¦¦
        const rawDamage = Game.enemy.atk;
        let finalDamage = rawDamage;
        
        // æ·»åŠ éš¨æ©Ÿæ€§ï¼šÂ±10%
        const variance = 0.1;
        const randomFactor = 1 - variance + Math.random() * (variance * 2);
        finalDamage = Math.floor(finalDamage * randomFactor);
        
        // ç¢ºä¿å‚·å®³è‡³å°‘ç‚º1
        finalDamage = Math.max(1, finalDamage);
        
        Player.hp -= finalDamage;
        UI.float(`-${finalDamage}`, "var(--danger)");
        UI.log(`${Game.enemy.name} å°ä½ é€ æˆ ${finalDamage} å‚·å®³`);
        
        if (Player.hp <= 0) {
            Game.showDeathScreen();
        }
        isCombatAction = false;
        UI.update();
    },

    win() {
        const baseLoot = Math.floor(Game.enemy.maxHp / 5) + 5;
        const loot = Game.enemy.isBoss ? baseLoot * 10 : baseLoot;
        const expGain = Game.enemy.isBoss ? Math.floor(Game.enemy.maxHp / 2) : Math.floor(Game.enemy.maxHp / 6) + 15;
        Player.gold += loot;
        Game.gainExp(expGain);
        UI.log(`æ“Šæ•—äº† ${Game.enemy.name}ï¼ +${loot}G +${expGain}EXP`);
        
        // BOSSæˆ°æ‰è½ç¨€æœ‰ç´ æ
        if (Game.enemy.isBoss) {
            const rareMats = ["é¾é±—", "é³³å‡°ä¹‹ç¾½", "æ˜Ÿè¾°ç¢ç‰‡", "å¤©ä½¿ä¹‹ç¾½", "ç¥ä¹‹è¡€"];
            const randomMat = rareMats[Math.floor(Math.random() * rareMats.length)];
            Game.addMaterial(randomMat, 1 + Math.floor(Math.random() * 2));
            
            // BOSSæœ‰æ©Ÿç‡æ‰è½ç‰¹æ®Šè£å‚™
            if (Math.random() < 0.3) {
                const bossItems = ["ç«ç„°åŠ", "å†°éœœä¹‹åˆƒ", "è‹±é›„ä¹‹åˆƒ"];
                const randomItem = bossItems[Math.floor(Math.random() * bossItems.length)];
                Game.addItem(randomItem);
            }
        }
        
        Game.state = "idle";
        isCombatAction = false;
        UI.renderStage("ğŸ†", "æˆ°é¬¥å‹åˆ©", `ç²å¾— ${loot} é‡‘å¹£ & ${expGain} EXP`, false);
        document.getElementById('boss-warning').style.display = 'none';
        Game.updateButtons();
        UI.update();
    },

    flee() {
        if (Game.state !== 'combat' || isCombatAction || Game.currentPage !== 'adventure') return;
        
        isCombatAction = true;
        if (Math.random() > 0.4) {
            UI.log("é€ƒè·‘æˆåŠŸ");
            setTimeout(() => {
                Game.next();
                isCombatAction = false;
            }, 800);
        } else {
            UI.log("é€ƒè·‘å¤±æ•—ï¼");
            setTimeout(() => {
                this.enemyTurn();
                isCombatAction = false;
            }, 800);
        }
    }
};

// UI ç³»çµ±
const UI = {
    update() {
        document.getElementById('ui-level').innerText = Player.level;
        document.getElementById('ui-depth').innerText = Player.depth;
        document.getElementById('ui-gold').innerText = Player.gold;
        document.getElementById('ui-class').innerText = Player.class;
        
        // è¨ˆç®—ç¸½æ”»æ“ŠåŠ›ï¼ˆåŸºç¤+æ­¦å™¨ï¼‰
        const totalAtk = Player.atk + (Player.weapon ? Player.weapon.atk : 0);
        document.getElementById('ui-atk').innerText = totalAtk;
        
        // è¨ˆç®—ç¸½é˜²ç¦¦åŠ›ï¼ˆåŸºç¤+ç›”ç”²ï¼‰
        const totalDef = Player.def + (Player.armor ? Player.armor.def : 0);
        document.getElementById('ui-def').innerText = totalDef;
        
        document.getElementById('ui-crit').innerText = Player.crit.toFixed(1) + "%";
        
        // æ›´æ–°æ­¦å™¨é¡¯ç¤º
        document.getElementById('ui-weapon').innerText = Player.weapon ? `æ­¦å™¨: ${Player.weapon.name}` : "æ­¦å™¨: - ç„¡ -";
        document.getElementById('weapon-desc').innerText = Player.weapon ? Player.weapon.desc : "ç„¡æ•ˆæœ";
        
        // æ›´æ–°ç›”ç”²é¡¯ç¤º
        document.getElementById('ui-armor').innerText = Player.armor ? `ç›”ç”²: ${Player.armor.name}` : "ç›”ç”²: - ç„¡ -";
        document.getElementById('armor-desc').innerText = Player.armor ? Player.armor.desc : "ç„¡æ•ˆæœ";
        
        // é ­åƒæ›´æ–°
        if (Player.class === "é¨å£«") document.getElementById('ui-avatar').innerText = "âš”ï¸";
        else if (Player.class === "ç›œè³Š") document.getElementById('ui-avatar').innerText = "ğŸ—¡ï¸";
        else if (Player.class === "æ³•å¸«") document.getElementById('ui-avatar').innerText = "ğŸ§™";
        else if (Player.class === "çµäºº") document.getElementById('ui-avatar').innerText = "ğŸ¹";

        this.setBar('exp', Player.exp, Player.maxExp);
        this.setBar('hp', Player.hp, Player.maxHp);
        this.setBar('mp', Player.mp, Player.maxMp);
        
        if (Game.enemy && Game.state === 'combat' && Game.currentPage === 'adventure') {
            this.setBar('enemy-hp', Game.enemy.hp, Game.enemy.maxHp);
            document.getElementById('enemy-atk').innerText = Game.enemy.atk;
            document.getElementById('enemy-hp-text').innerText = `${Game.enemy.hp}/${Game.enemy.maxHp}`;
        }

        const inCombat = Game.state === 'combat' && Game.currentPage === 'adventure';
        const isAdventure = Game.currentPage === 'adventure';
        
        const canUseSkills = isAdventure && !isCombatAction;
        document.getElementById('skill-1').disabled = (Player.mp < 20) || !canUseSkills;
        document.getElementById('skill-2').disabled = (Player.mp < 30) || !canUseSkills;
        document.getElementById('skill-3').disabled = (Player.mp < 60) || !canUseSkills;

        const base = Player.atk + (Player.weapon ? Player.weapon.atk : 0);
        document.getElementById('sk1-val').innerText = `${Math.floor(base * 2.2)} (20MP)`;
        document.getElementById('sk2-val').innerText = `+${Math.floor(Player.maxHp * 0.5)} (30MP)`;
        document.getElementById('sk3-val').innerText = `${Math.floor(base * 4.5)} (60MP)`;

        this.renderBag();
        if (Game.currentPage === 'shop') {
            this.renderShop();
        }
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        Game.updateButtons();
    },

    setBar(id, v, m) {
        const p = Math.max(0, (v / m) * 100);
        document.getElementById(`${id}-bar`).style.width = p + "%";
        if (document.getElementById(`${id}-text`)) {
            document.getElementById(`${id}-text`).innerText = `${Math.floor(Math.max(0,v))} / ${Math.floor(m)}`;
        }
    },

    renderStage(ico, name, desc, showEnemy) {
        document.getElementById('enemy-sprite').innerText = ico;
        document.getElementById('event-name').innerText = name;
        document.getElementById('event-desc').innerText = desc;
        document.getElementById('enemy-panel').style.display = showEnemy ? "block" : "none";
    },

    renderBag() {
        const bagDiv = document.getElementById('bag-grid');
        if (!bagDiv) return;
        
        bagDiv.innerHTML = "";
        
        let itemsToShow = [];
        
        if (currentBagCategory === 'all') {
            itemsToShow = [...Player.bag];
            // æ·»åŠ ææ–™
            Object.keys(Player.materials).forEach(name => {
                const count = Player.materials[name];
                const itemInfo = DB.items[name];
                if (itemInfo && count > 0) {
                    itemsToShow.push({ 
                        name, 
                        ...itemInfo, 
                        isMaterial: true, 
                        count: count 
                    });
                }
            });
        } else if (currentBagCategory === 'material') {
            Object.keys(Player.materials).forEach(name => {
                const count = Player.materials[name];
                const itemInfo = DB.items[name];
                if (itemInfo && count > 0) {
                    itemsToShow.push({ 
                        name, 
                        ...itemInfo, 
                        isMaterial: true, 
                        count: count 
                    });
                }
            });
        } else {
            itemsToShow = Player.bag.filter(item => item.category === currentBagCategory);
        }
        
        if (itemsToShow.length === 0) {
            let emptyMessage = "èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ";
            if (currentBagCategory === 'potion') emptyMessage = "æ²’æœ‰è—¥æ°´";
            else if (currentBagCategory === 'weapon') emptyMessage = "æ²’æœ‰æ­¦å™¨";
            else if (currentBagCategory === 'armor') emptyMessage = "æ²’æœ‰ç›”ç”²";
            else if (currentBagCategory === 'material') emptyMessage = "æ²’æœ‰ç´ æ";
            
            bagDiv.innerHTML = `<div style='grid-column:1/-1; text-align:center; color:#666; padding:10px; font-size:0.8em;'>${emptyMessage}</div>`;
            return;
        }
        
        itemsToShow.forEach((item, i) => {
            const slot = document.createElement('div');
            
            // æ ¹æ“šç‰©å“å“è³ªè¨­å®šé‚Šæ¡†é¡è‰²
            let rarityClass = 'r-common';
            if (item.r) {
                rarityClass = `r-${item.r}`;
            } else if (item.isSpecial) {
                rarityClass = 'r-mythic';
            }
            
            slot.className = `item-slot ${rarityClass} category-${item.category || 'material'}`;
            
            // é¡¯ç¤ºåœ–æ¨™
            slot.innerHTML = `${item.icon}`;
            
            // å¦‚æœæ˜¯ç´ æï¼Œé¡¯ç¤ºæ•¸é‡
            if (item.isMaterial && item.count > 1) {
                const countBadge = document.createElement('div');
                countBadge.style.position = 'absolute';
                countBadge.style.bottom = '1px';
                countBadge.style.right = '1px';
                countBadge.style.background = 'var(--accent)';
                countBadge.style.color = 'white';
                countBadge.style.borderRadius = '50%';
                countBadge.style.width = '14px';
                countBadge.style.height = '14px';
                countBadge.style.fontSize = '9px';
                countBadge.style.display = 'flex';
                countBadge.style.alignItems = 'center';
                countBadge.style.justifyContent = 'center';
                countBadge.innerText = item.count > 9 ? '9+' : item.count;
                slot.appendChild(countBadge);
            }
            
            slot.onclick = () => this.openItemModal(item, i);
            bagDiv.appendChild(slot);
        });
    },

    renderShop() {
        ['potion', 'weapon', 'armor', 'material'].forEach(cat => {
            const div = document.getElementById('shop-' + cat);
            if (div) div.innerHTML = "";
        });
        
        Object.entries(DB.items).forEach(([name, item]) => {
            const cat = item.category;
            const shopDiv = document.getElementById('shop-' + cat);
            if (!shopDiv) return;
            
            const card = document.createElement('div');
            card.className = `shop-card`;
            card.innerHTML = `
                <div class="shop-card-icon">${item.icon}</div>
                <div class="shop-card-name">${name}</div>
                <div class="shop-card-desc">${item.desc}</div>
                <div class="shop-card-footer">
                    <span class="shop-card-price">${item.price}G</span>
                    <button class="btn" style="padding:3px 6px; font-size:0.65em;" 
                        onclick="Game.buyItem('${name}')" ${Player.gold < item.price ? 'disabled' : ''}>è³¼è²·</button>
                </div>
            `;
            shopDiv.appendChild(card);
        });
        
        this.switchShopCategory(currentShopCategory);
    },

    renderRecipes() {
        const recipeList = document.getElementById('recipe-list');
        if (!recipeList) return;
        
        recipeList.innerHTML = "";
        
        DB.recipes.forEach(recipe => {
            const card = document.createElement('div');
            card.className = 'recipe-card';
            
            let hasAllMaterials = true;
            const materialsHtml = recipe.materials.map(mat => {
                const hasEnough = Game.getMaterialCount(mat.name) >= mat.amount;
                if (!hasEnough) hasAllMaterials = false;
                return `
                    <div class="material-item ${hasEnough ? 'has-enough' : 'not-enough'}">
                        <span>${DB.items[mat.name]?.icon || 'â“'}</span>
                        <span>${mat.name} x${mat.amount}</span>
                        <span>(${Game.getMaterialCount(mat.name)}/${mat.amount})</span>
                    </div>
                `;
            }).join('');
            
            if (hasAllMaterials) {
                card.classList.add('available');
            }
            
            card.innerHTML = `
                <div class="recipe-header">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div class="recipe-icon">${recipe.icon}</div>
                        <div class="recipe-name">${recipe.name}</div>
                    </div>
                    <button class="btn" style="padding:3px 6px; font-size:0.65em;" 
                        onclick="Game.craftItem(${recipe.id})" ${!hasAllMaterials ? 'disabled' : ''}>
                        é›é€ 
                    </button>
                </div>
                <div class="recipe-desc">${recipe.desc}</div>
                <div class="recipe-materials">
                    ${materialsHtml}
                </div>
            `;
            
            recipeList.appendChild(card);
        });
    },

    openItemModal(item, index) {
        document.getElementById('m-icon').innerText = item.icon;
        document.getElementById('m-title').innerText = item.name;
        
        // é¡¯ç¤ºç¨€æœ‰åº¦
        let rarityText = "";
        let rarityColor = "";
        if (item.r === 'common') { rarityText = "æ™®é€š"; rarityColor = "var(--r-common)"; }
        else if (item.r === 'rare') { rarityText = "ç¨€æœ‰"; rarityColor = "var(--r-rare)"; }
        else if (item.r === 'epic') { rarityText = "å²è©©"; rarityColor = "var(--r-epic)"; }
        else if (item.r === 'legend') { rarityText = "å‚³èªª"; rarityColor = "var(--r-legend)"; }
        else if (item.r === 'mythic' || item.isSpecial) { rarityText = "ç¥è©±"; rarityColor = "var(--r-mythic)"; }
        
        document.getElementById('m-rarity').innerText = rarityText;
        document.getElementById('m-rarity').style.color = rarityColor;
        
        document.getElementById('m-desc').innerText = item.desc;
        
        // é¡¯ç¤ºç‰©å“çµ±è¨ˆæ•¸æ“š
        const statsDiv = document.getElementById('m-stats');
        let statsHTML = "";
        
        if (item.isMaterial) {
            statsHTML = `<div>æ•¸é‡: ${item.count}</div>`;
        } else if (item.type === 'weapon') {
            statsHTML = `<div>æ”»æ“ŠåŠ›: +${item.atk}</div>`;
        } else if (item.type === 'armor') {
            statsHTML = `<div>ç”Ÿå‘½å€¼: +${item.hp || 0}</div>`;
            if (item.hpPercent) {
                statsHTML += `<div>ç”Ÿå‘½å€¼åŠ æˆ: +${item.hpPercent}%</div>`;
            }
            statsHTML += `<div>é˜²ç¦¦åŠ›: +${item.def || 0}</div>`;
            if (item.mp) {
                statsHTML += `<div>é­”åŠ›å€¼: +${item.mp}</div>`;
            }
        } else if (item.type === 'potion') {
            if (item.effect === 'hp') {
                statsHTML = `<div>æ¢å¾©ç”Ÿå‘½å€¼: ${item.val}</div>`;
            } else if (item.effect === 'mp') {
                statsHTML = `<div>æ¢å¾©é­”åŠ›å€¼: ${item.val}</div>`;
            } else if (item.effect === 'both') {
                statsHTML = `<div>æ¢å¾©å…¨éƒ¨HPå’ŒMP</div>`;
            }
        } else if (item.type === 'buff') {
            statsHTML = `<div>æ•ˆæœ: ${item.desc}</div>`;
        }
        
        statsDiv.innerHTML = statsHTML;
        
        const act = document.getElementById('m-action');
        
        if (item.isMaterial) {
            act.innerText = "é—œé–‰";
            act.onclick = () => this.closeModal();
        } else {
            // æª¢æŸ¥æ˜¯å¦å·²è£å‚™
            const isEquippedWeapon = Player.weapon && Player.weapon.name === item.name;
            const isEquippedArmor = Player.armor && Player.armor.name === item.name;
            const isEquipped = isEquippedWeapon || isEquippedArmor;
            
            if (item.type === 'weapon') {
                if (isEquipped) {
                    act.innerText = "å¸ä¸‹";
                    act.onclick = () => {
                        Player.bag.push(Player.weapon);
                        Player.weapon = null;
                        this.closeModal();
                        UI.log(`å¸ä¸‹äº† ${item.name}ï¼`);
                        UI.update();
                    };
                } else {
                    act.innerText = "è£å‚™";
                    act.onclick = () => {
                        if(Player.weapon) Player.bag.push(Player.weapon);
                        Player.weapon = item;
                        Player.bag.splice(index, 1);
                        this.closeModal();
                        UI.log(`è£å‚™äº† ${item.name}ï¼`);
                        UI.update();
                    };
                }
            } else if (item.type === 'armor') {
                if (isEquipped) {
                    act.innerText = "å¸ä¸‹";
                    act.onclick = () => {
                        Player.bag.push(Player.armor);
                        Player.armor = null;
                        
                        // ç§»é™¤ç›”ç”²åŠ æˆ
                        if (item.hp) Player.equipmentHpBonus -= item.hp;
                        if (item.hpPercent) Player.equipmentHpPercent -= item.hpPercent;
                        if (item.def) Player.def -= item.def;
                        
                        Game.updatePlayerMaxHp();
                        
                        this.closeModal();
                        UI.log(`å¸ä¸‹äº† ${item.name}ï¼`);
                        UI.update();
                    };
                } else {
                    act.innerText = "è£å‚™";
                    act.onclick = () => {
                        if(Player.armor) {
                            // ç§»é™¤èˆŠç›”ç”²åŠ æˆ
                            if (Player.armor.hp) Player.equipmentHpBonus -= Player.armor.hp;
                            if (Player.armor.hpPercent) Player.equipmentHpPercent -= Player.armor.hpPercent;
                            if (Player.armor.def) Player.def -= Player.armor.def;
                            
                            Player.bag.push(Player.armor);
                        }
                        
                        Player.armor = item;
                        Player.bag.splice(index, 1);
                        
                        // æ·»åŠ æ–°ç›”ç”²åŠ æˆ
                        if (item.hp) Player.equipmentHpBonus += item.hp;
                        if (item.hpPercent) Player.equipmentHpPercent += item.hpPercent;
                        if (item.def) Player.def += item.def;
                        
                        Game.updatePlayerMaxHp();
                        
                        this.closeModal();
                        UI.log(`è£å‚™äº† ${item.name}ï¼`);
                        UI.update();
                    };
                }
            } else if (item.type === 'buff') {
                act.innerText = "ä½¿ç”¨";
                act.onclick = () => {
                    if (item.stat === 'atk') Player.atk += item.val;
                    else if (item.stat === 'def') Player.def += item.val;
                    else if (item.stat === 'crit') Player.crit += item.val;
                    else if (item.stat === 'maxHp') { 
                        Player.baseMaxHp += item.val;
                        Game.updatePlayerMaxHp();
                        Player.hp += item.val;
                    }
                    else if (item.stat === 'maxMp') { 
                        Player.maxMp += item.val; 
                        Player.mp += item.val;
                    }
                    Player.bag.splice(index, 1);
                    this.closeModal();
                    UI.log(`ä½¿ç”¨äº† ${item.name}ï¼`);
                    UI.update();
                };
            } else {
                act.innerText = "ä½¿ç”¨";
                act.onclick = () => {
                    if(item.effect === 'hp') Player.hp = Math.min(Player.maxHp, Player.hp + item.val);
                    else if(item.effect === 'mp') Player.mp = Math.min(Player.maxMp, Player.mp + item.val);
                    else if(item.effect === 'both') {
                        Player.hp = Player.maxHp;
                        Player.mp = Player.maxMp;
                    }
                    Player.bag.splice(index, 1);
                    this.closeModal();
                    UI.log(`ä½¿ç”¨äº† ${item.name}ï¼`);
                    UI.update();
                };
            }
        }
        
        document.getElementById('item-modal').style.display = 'flex';
    },

    closeModal() { 
        document.getElementById('item-modal').style.display = 'none'; 
    },

    switchTab(tab, btn) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tabs-container button').forEach(b => b.classList.remove('active'));
        
        document.getElementById(`${tab}-tab`).classList.add('active');
        btn.classList.add('active');
        
        if (tab === 'bag') {
            this.renderBag();
        }
    },

    switchBagCategory(cat) {
        currentBagCategory = cat;
        document.querySelectorAll('.bag-category-tabs button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        this.renderBag();
    },

    switchShopCategory(cat) {
        currentShopCategory = cat;
        document.querySelectorAll('.shop-category').forEach(div => div.classList.remove('active'));
        document.querySelectorAll('.shop-category-tabs button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('shop-' + cat).classList.add('active');
        event.target.classList.add('active');
    },

    log(msg) {
        const log = document.getElementById('log-tab');
        if (!log) return;
        
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `&gt; ${msg}`;
        log.appendChild(logEntry);
        
        while (log.children.length > 50) {
            log.removeChild(log.firstChild);
        }
        
        log.scrollTop = log.scrollHeight;
    },

    float(txt, color) {
        const f = document.createElement('div');
        f.className = 'floating-text';
        f.innerText = txt; 
        f.style.color = color;
        f.style.left = "50%"; 
        f.style.top = "40%";
        f.style.transform = "translateX(-50%)";
        document.getElementById('stage').appendChild(f);
        setTimeout(() => f.remove(), 1000);
    },

    shake() {
        const s = document.getElementById('stage');
        s.classList.add('shake');
        setTimeout(() => s.classList.remove('shake'), 300);
    }
};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    UI.switchShopCategory('potion');
    Game.updateButtons();
});
</script>
</body>
</html>
