<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¹»æƒ³å†’éšª V7.4</title>
    <style>
        :root {
            --bg-dark: #0a0a0e;
            --panel-bg: #16161d;
            --panel-border: #333;
            --accent: #ff9800;
            --text-main: #e0e0e0;
            --danger: #ff5252;
            --mana: #448aff;
            --success: #4caf50;
            --r-common: #9e9e9e;
            --r-rare: #2196f3;
            --r-epic: #9c27b0;
            --r-legend: #ffab00;
            --r-mythic: #ff4081;
            --category-potion: #e91e63;
            --category-weapon: #4caf50;
            --category-armor: #795548;
            --category-material: #ff9800;
            --chest-good: #4caf50;
            --chest-bad: #f44336;
            --event-good: #4caf50;
            --event-bad: #f44336;
            --event-neutral: #ff9800;
        }

        * { 
            box-sizing: border-box; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0; 
            background: var(--bg-dark); 
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, sans-serif; 
            height: 100vh;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden;
            padding: 5px;
            touch-action: manipulation;
        }

        #game-container {
            width: 100%; 
            height: 100%; 
            max-width: 1600px; 
            display: grid;
            grid-template-columns: minmax(250px, 1fr) 2fr minmax(250px, 1fr); 
            grid-template-rows: auto 1fr auto;
            gap: 8px; 
            padding: 5px; 
            overflow: hidden;
        }

        .panel {
            background: var(--panel-bg); 
            border: 1px solid var(--panel-border);
            border-radius: 8px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .header { 
            grid-column: 1 / -1; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--accent); 
            padding: 0 15px; 
            font-size: 1em;
        }

        .main-stage { 
            grid-column: 2 / 3; 
            grid-row: 2 / 3; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            background: radial-gradient(circle, #222 0%, #111 100%); 
            overflow: hidden; 
        }

        .control-area { 
            grid-column: 2 / 3; 
            grid-row: 3 / 4; 
            display: grid; 
            grid-template-columns: 1fr 1fr 1.2fr; 
            gap: 8px; 
            min-height: 180px;
        }

        .enemy-sprite { 
            font-size: 5.5em; 
            transition: 0.2s; 
            text-align: center;
        }

        .enemy-ui { 
            width: 95%; 
            background: rgba(0,0,0,0.7); 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid #444; 
            margin-bottom: 12px; 
        }

        .enemy-stats {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 8px; 
            font-weight: bold; 
            color: var(--danger);
            font-size: 1em; 
            white-space: nowrap;
        }

        .enemy-stats span:first-child {
            display: flex; 
            align-items: center; 
            gap: 6px;
        }

        .bar-container { 
            height: 16px; 
            background: #222; 
            border-radius: 8px; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid #444; 
        }

        .bar-fill { 
            height: 100%; 
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .hp-fill { 
            background: var(--danger); 
            box-shadow: 0 0 8px var(--danger); 
        }

        .mp-fill { 
            background: var(--mana); 
            box-shadow: 0 0 8px var(--mana); 
        }

        .bar-text { 
            position: absolute; 
            width: 100%; 
            text-align: center; 
            top:0; 
            font-size: 10px; 
            font-weight: bold; 
            line-height: 16px; 
            text-shadow: 1px 1px black; 
            color: white;
            z-index: 2;
        }

        .btn { 
            border: 1px solid #444; 
            background: #2a2a35; 
            color: white; 
            padding: 14px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-weight: bold; 
            font-size: 0.9em; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px;
        }

        .btn:hover:not(:disabled) { 
            background: #3a3a45; 
            transform: translateY(-2px); 
        }

        .btn:active { 
            transform: translateY(0); 
        }

        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            filter: grayscale(70%);
        }

        .btn.combat-disabled {
            opacity: 0.4;
            filter: grayscale(80%);
            background: #1a1a24;
            border-color: #555;
        }

        .btn-exp { background: #2e7d32; border-color: #4caf50; }
        .btn-atk { background: #c62828; border-color: #ff5252; }
        .btn-shop { background: #4a148c; border-color: #9c27b0; }
        .btn-craft { background: #5d4037; border-color: #8d6e63; }
        .btn-upgrade { background: #006064; border-color: #00bcd4; }

        .grid-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 6px;
            align-items: stretch;
        }

        .item-slot { 
            aspect-ratio: 1; 
            border: 2px solid var(--panel-border); 
            background: #1a1a24;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            border-radius: 6px; 
            cursor: pointer; 
            position: relative; 
            font-size: 1.1em;
            min-height: 50px;
            max-height: 60px;
            width: 100%;
            padding: 4px;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .item-slot:hover {
            transform: scale(1.05);
            border-color: var(--accent);
        }

        .item-slot.r-common { border-color: var(--r-common); }
        .item-slot.r-rare { border-color: var(--r-rare); box-shadow: inset 0 0 4px rgba(33,150,243,0.3); }
        .item-slot.r-epic { border-color: var(--r-epic); box-shadow: inset 0 0 4px rgba(156,39,176,0.3); }
        .item-slot.r-legend { border-color: var(--r-legend); box-shadow: 0 0 6px rgba(255,171,0,0.4); }
        .item-slot.r-mythic { border-color: var(--r-mythic); box-shadow: 0 0 8px rgba(255,64,129,0.6); }

        .item-slot.enhanced::after {
            content: attr(data-enhance);
            position: absolute;
            top: 2px;
            right: 2px;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 4px;
            min-width: 18px;
            text-align: center;
        }

        .category-potion { border-left: 4px solid var(--category-potion); }
        .category-weapon { border-left: 4px solid var(--category-weapon); }
        .category-armor { border-left: 4px solid var(--category-armor); }
        .category-material { border-left: 4px solid var(--category-material); }

        .shop-page, .forge-page, .upgrade-page, .chest-page, .event-page { 
            display: none; 
            flex-direction: column; 
            height: 100%; 
            width: 100%; 
            overflow: hidden;
        }

        .shop-page.active, .forge-page.active, .upgrade-page.active, .chest-page.active, .event-page.active { 
            display: flex; 
        }

        .stage-page { display: none; }
        .stage-page.active { display: flex; flex-direction: column; min-height: 0; }

        .shop-category-tabs, .bag-category-tabs { 
            display: flex; 
            gap: 6px; 
            margin-bottom: 12px; 
            flex-shrink: 0;
        }

        .shop-category-tabs button, .bag-category-tabs button { 
            flex: 1; 
            padding: 8px; 
            font-size: 0.9em; 
            min-width: 80px;
        }

        .shop-grid, .upgrade-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); 
            gap: 10px; 
            overflow-y: auto; 
            flex: 1;
            padding-right: 6px;
            padding-bottom: 20px;
            margin-bottom: 12px;
        }

        .shop-category {
            display: none;
        }

        .shop-category.active {
            display: grid;
        }

        .shop-card, .upgrade-card { 
            background: #252530; 
            border: 1px solid #444; 
            padding: 10px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: 0.2s; 
            display: flex; 
            flex-direction: column;
        }

        .shop-card:hover, .upgrade-card:hover { 
            transform: translateY(-2px); 
            border-color: var(--accent); 
        }

        .shop-card-icon, .upgrade-card-icon { 
            font-size: 2em; 
            margin-bottom: 6px; 
            text-align: center; 
        }

        .shop-card-name, .upgrade-card-name { 
            font-weight: bold; 
            font-size: 0.9em; 
            margin-bottom: 4px; 
        }

        .shop-card-desc, .upgrade-card-desc { 
            font-size: 0.75em; 
            color: #999; 
            margin-bottom: 8px; 
            flex-grow: 1; 
        }

        .shop-card-footer, .upgrade-card-footer { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: auto; 
        }

        .shop-card-price, .upgrade-card-price { 
            color: #ffd700; 
            font-weight: bold; 
            font-size: 0.9em; 
        }

        .forge-page { 
            display: none; 
            flex-direction: column; 
            height: 100%; 
        }

        .forge-page.active { 
            display: flex; 
        }

        .recipe-list { 
            overflow-y: auto; 
            flex: 1;
            padding-right: 6px;
            padding-bottom: 20px;
            margin-bottom: 12px;
        }

        .recipe-card { 
            background: #252530; 
            border: 1px solid #444; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            transition: 0.2s; 
        }

        .recipe-card:hover { 
            border-color: var(--accent); 
        }

        .recipe-card.available { 
            background: rgba(76, 175, 80, 0.1); 
            border-color: var(--success); 
        }

        .recipe-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
        }

        .recipe-icon { 
            font-size: 1.8em; 
        }

        .recipe-name { 
            font-weight: bold; 
            font-size: 1em; 
        }

        .recipe-desc { 
            color: #aaa; 
            font-size: 0.8em; 
            margin-bottom: 10px; 
        }

        .recipe-materials { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
        }

        .material-item { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            background: rgba(0,0,0,0.3); 
            padding: 4px 8px; 
            border-radius: 5px; 
            font-size: 0.9em; 
        }

        .material-item.has-enough { color: var(--success); }
        .material-item.not-enough { opacity: 0.5; }

        @keyframes floatUp { 
            0% { opacity: 1; transform: translateY(0); } 
            100% { opacity: 0; transform: translateY(-60px); } 
        }

        .floating-text { 
            position: absolute; 
            font-size: 2.2em; 
            font-weight: bold; 
            animation: floatUp 1s forwards; 
            z-index: 100; 
            pointer-events: none; 
        }

        .shake { animation: shake 0.3s; }

        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-8px); } 
            75% { transform: translateX(8px); } 
        }

        .modal-overlay { 
            position: fixed; 
            top:0; left:0; 
            width:100%; 
            height:100%; 
            background:rgba(0,0,0,0.9); 
            display:none; 
            align-items:center; 
            justify-content:center; 
            z-index:1000; 
        }

        .modal-box { 
            background: var(--panel-bg); 
            padding: 24px; 
            border-radius: 12px; 
            border: 2px solid #555; 
            width: 90%; 
            max-width: 450px; 
            text-align: center; 
            max-height: 80vh; 
            overflow-y: auto; 
        }

        .tabs-container { 
            display: flex; 
            gap: 6px; 
            margin-bottom: 10px; 
            flex-shrink: 0;
        }

        .tabs-container button { 
            flex: 1; 
            padding: 8px; 
            font-size: 0.85em; 
            height: 40px;
        }

        .tab-content { 
            display: none; 
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .tab-content.active { 
            display: flex;
        }

        #bag-tab {
            flex: 1;
            overflow: hidden;
            display: none;
            flex-direction: column;
            min-height: 0;
        }

        #bag-tab.active {
            display: flex;
        }

        #bag-tab .grid-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
            padding-bottom: 8px;
        }

        #log-tab {
            flex: 1;
            overflow-y: auto;
            font-size: 0.8em;
            color: #aaa;
            line-height: 1.5;
            padding-right: 4px;
            display: none;
            padding-bottom: 15px;
        }

        #log-tab.active {
            display: block;
        }

        .boss-warning { 
            background: linear-gradient(135deg, rgba(255,171,0,0.2), rgba(255,107,0,0.2)); 
            border: 2px solid #ffab00; 
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            text-align: center; 
        }

        .boss-warning-title { 
            color: #ffab00; 
            font-weight: bold; 
            font-size: 1em; 
        }

        .class-card { 
            padding:15px; 
            text-align:left; 
            height:auto; 
            display:flex; 
            gap:12px; 
            align-items:flex-start; 
            cursor:pointer; 
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ffb74d;
        }

        #combat-warning {
            grid-column: 1 / -1;
            color: #ff9800;
            font-size: 0.85em;
            text-align: center;
            margin-top: 8px;
            display: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .equipment-info {
            margin-top: 10px;
            font-size: 0.8em;
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 6px;
            overflow-y: visible;
            max-height: none;
            min-height: 120px;
        }

        .equipment-item {
            margin-bottom: 6px;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .equipment-item:last-child {
            border-bottom: none;
        }

        @keyframes enhanceGlow {
            0% { box-shadow: 0 0 5px #ff9800; }
            50% { box-shadow: 0 0 25px #ff9800; }
            100% { box-shadow: 0 0 5px #ff9800; }
        }

        .enhance-success {
            animation: enhanceGlow 1s ease-in-out;
        }

        .enhance-level {
            color: #ff9800;
            font-weight: bold;
            font-size: 1em;
        }

        @media (hover: none) {
            .btn:hover:not(:disabled) {
                transform: none;
            }
            
            .item-slot:hover {
                transform: none;
            }
            
            .shop-card:hover, .upgrade-card:hover, .recipe-card:hover {
                transform: none;
            }
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin: 12px 0;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            font-size: 1.1em;
            text-align: center;
        }

        .password-error {
            color: #ff5252;
            font-size: 0.9em;
            margin-top: 8px;
            min-height: 24px;
        }

        .skill-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            width: 100%;
        }

        .chest-result-good {
            color: var(--chest-good);
            font-weight: bold;
            font-size: 1.2em;
        }

        .chest-result-bad {
            color: var(--chest-bad);
            font-weight: bold;
            font-size: 1.2em;
        }

        .chest-reward {
            font-size: 1.1em;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
        }

        @keyframes chestOpen {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .chest-opening {
            animation: chestOpen 0.5s ease-in-out;
        }

        #difficulty-easy.active, #difficulty-normal.active, #difficulty-hard.active {
            box-shadow: 0 0 10px currentColor;
            transform: translateY(-2px);
        }

        .event-result-good {
            color: var(--event-good);
            font-weight: bold;
            font-size: 1.2em;
        }

        .event-result-bad {
            color: var(--event-bad);
            font-weight: bold;
            font-size: 1.2em;
        }

        .event-result-neutral {
            color: var(--event-neutral);
            font-weight: bold;
            font-size: 1.2em;
        }

        .event-reward {
            font-size: 1.1em;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
        }

        /* å·²è£å‚™æ¨™è¨˜ */
        .item-equipped::before {
            content: "âœ”";
            position: absolute;
            top: 2px;
            left: 2px;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 4px;
            min-width: 18px;
            text-align: center;
            z-index: 1;
        }

        /* ç‰©å“å †ç–Šæ•¸é‡é¡¯ç¤º */
        .item-count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 1px 3px;
            border-radius: 3px;
            min-width: 16px;
            text-align: center;
            line-height: 1.2;
        }

        /* é›»è…¦ç‰ˆèƒŒåŒ…æ¨™ç±¤å„ªåŒ– */
        @media (min-width: 1025px) {
            .bag-category-tabs {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 6px;
                overflow-x: visible;
            }
            
            .bag-category-tabs button {
                min-width: auto;
                font-size: 0.8em !important;
            }
        }

        /* å·¦å´é¢æ¿é–“è·ä¿®æ­£ */
        aside.panel:first-of-type {
            padding: 12px !important;
        }

        @media (max-width: 768px) {
            aside.panel:first-of-type {
                padding: 10px !important;
            }   
        }

        @media (max-height: 700px) {
            aside.panel:first-of-type {
                padding: 10px !important;
            }
        }

        /* ä¿®æ­£ç¶“é©—ã€ç”Ÿå‘½ã€é­”åŠ›æ¢çš„é–“è· */
        aside.panel:first-of-type .stat-label {
            font-size: 0.65em; 
            color: #888; 
            margin-top: 4px; 
            margin-bottom: 2px;
        }

        /* å·¦å´é¢æ¿ä¸­çš„bar-container - ä½¿ç”¨ç›¸å°é–“è· */
        aside.panel:first-of-type .bar-container {
            margin-bottom: 6px;
            height: 14px; /* ç¨å¾®æ¸›å°é«˜åº¦ */
        }

        /* é›»è…¦ç‰ˆå„ªåŒ– - ç¢ºä¿åœ¨è¼ƒå°å±å¹•ä¸Šä¹Ÿèƒ½é¡¯ç¤º */
        @media (min-width: 769px) {
            aside.panel:first-of-type .stat-label {
                font-size: 0.6em;
                margin-top: 3px;
                margin-bottom: 2px;
            }
    
            aside.panel:first-of-type .bar-container {
                margin-bottom: 5px;
                height: 12px;
            }
        }

        /* æ‰‹æ©Ÿç‰ˆä¿æŒåŸæ¨£ */
        @media (max-width: 768px) {
            aside.panel:first-of-type .stat-label {
                font-size: 0.6em;
                margin-top: 3px;
                margin-bottom: 2px;
            }
    
            aside.panel:first-of-type .bar-container {
                margin-bottom: 5px;
                height: 12px;
            }
        }

        /* è¶…å°å±å¹•å„ªåŒ– */
        @media (max-width: 480px) {
            aside.panel:first-of-type .stat-label {
                font-size: 0.55em;
                margin-top: 2px;
                margin-bottom: 1px;
            }
    
            aside.panel:first-of-type .bar-container {
                margin-bottom: 4px;
                height: 10px;
            }
        }

        /* ä½é«˜åº¦å±å¹•å„ªåŒ– */
        @media (max-height: 700px) {
            aside.panel:first-of-type .stat-label {
                font-size: 0.6em;
                margin-top: 2px;
                margin-bottom: 1px;
            }       
    
            aside.panel:first-of-type .bar-container {
                margin-bottom: 4px;
                height: 10px;
            }
        }

        /* æ‰‹æ©Ÿç‰ˆä½ˆå±€ */
        @media (max-width: 768px) {
            body {
                padding: 3px;
                height: 100vh;
                overflow: hidden;
                align-items: flex-start;
            }
            
            #game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto auto;
                gap: 5px;
                height: 100%;
                padding: 3px;
            }
            
            .header { 
                grid-column: 1; 
                grid-row: 1;
                padding: 5px 10px;
                font-size: 0.9em;
            }
            
            aside:first-of-type { 
                grid-column: 1; 
                grid-row: 2; 
                max-height: 220px;
                overflow: hidden;
            }
            
            .main-stage { 
                grid-column: 1; 
                grid-row: 3; 
                min-height: 180px;
                max-height: 220px;
                justify-content: flex-start;
                padding-top: 10px;
            }
            
            .control-area { 
                grid-column: 1; 
                grid-row: 4; 
                grid-template-columns: 1fr;
                min-height: auto;
                gap: 5px;
                max-height: 200px;
                overflow: hidden;
            }
            
            aside:last-of-type { 
                grid-column: 1; 
                grid-row: 5; 
                flex: 1;
                overflow: hidden;
            }
            
            .grid-list {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 4px !important;
            }
            
            .item-slot {
                min-height: 45px !important;
                max-height: 55px !important;
                font-size: 0.9em !important;
                padding: 6px !important;
            }
            
            .btn {
                padding: 10px 8px !important;
                font-size: 0.85em !important;
                min-height: 60px;
                line-height: 1.3;
            }
            
            .enemy-sprite {
                font-size: 3em !important;
                margin-bottom: 5px;
            }
            
            .modal-box {
                width: 95% !important;
                padding: 20px !important;
                margin: 10px;
                max-height: 80vh !important;
            }
            
            .panel {
                padding: 10px !important;
            }
            
            .shop-grid, .recipe-list, .upgrade-list {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
            }
            
            /* æŠ€èƒ½æŒ‰éˆ•èª¿æ•´ */
            #skill-1, #skill-2, #skill-3 {
                padding: 6px 3px !important;
                font-size: 0.75em !important;
                min-height: 60px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            
            #skill-1 small, #skill-2 small, #skill-3 small {
                font-size: 0.65em !important;
                margin-top: 3px;
            }
            
            /* æ§åˆ¶å€åŸŸæŒ‰éˆ•èª¿æ•´ */
            .control-area > .panel {
                padding: 6px !important;
                gap: 4px !important;
            }
            
            .control-area > .panel > div {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }
            
            /* èƒŒåŒ…æ¨™ç±¤èª¿æ•´ */
            .bag-category-tabs {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 6px;
                gap: 3px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .bag-category-tabs::-webkit-scrollbar {
                display: none;
            }
            
            .bag-category-tabs button {
                min-width: 60px;
                padding: 6px 3px !important;
                font-size: 0.7em !important;
                flex-shrink: 0;
                white-space: nowrap;
            }
            
            /* å•†åº—æ¨™ç±¤èª¿æ•´ */
            .shop-category-tabs {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 6px;
                gap: 3px;
            }
            
            .shop-category-tabs button {
                min-width: 60px;
                padding: 6px 3px !important;
                font-size: 0.7em !important;
                flex-shrink: 0;
            }
            
            .equipment-info {
                min-height: 100px !important;
                padding: 6px !important;
                font-size: 0.75em;
            }
            
            #enemy-panel {
                position: relative;
                bottom: 0;
                left: 0;
                transform: none;
                width: 100%;
                margin-bottom: 5px;
                padding: 8px;
            }
            
            .boss-warning {
                position: relative;
                top: 0;
                left: 0;
                transform: none;
                width: 100%;
                margin: 5px 0;
                padding: 8px;
                font-size: 0.9em;
            }
            
            #event-name {
                font-size: 1.2em;
                margin: 5px 0;
            }
            
            #event-desc {
                font-size: 0.75em;
                margin: 3px 0;
            }
        }

        @media (max-width: 480px) {
            .grid-list {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            
            .item-slot {
                min-height: 40px !important;
                max-height: 50px !important;
                font-size: 0.8em !important;
                padding: 5px !important;
            }
            
            .btn {
                padding: 8px 4px !important;
                font-size: 0.8em !important;
                min-height: 55px;
            }
            
            .enemy-sprite {
                font-size: 2.5em !important;
            }
            
            .shop-grid, .recipe-list, .upgrade-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important;
            }
            
            #skill-1, #skill-2, #skill-3 {
                font-size: 0.7em !important;
                min-height: 55px;
                padding: 5px 2px !important;
            }
            
            .bag-category-tabs button {
                min-width: 55px;
                font-size: 0.65em !important;
            }
            
            .main-stage {
                min-height: 160px;
                max-height: 200px;
            }
        }

        /* å¹³æ¿ç‰ˆä½ˆå±€ */
        @media (min-width: 769px) and (max-width: 1024px) {
            #game-container {
                grid-template-columns: 1fr 1.5fr;
                grid-template-rows: auto 1fr auto auto;
            }
            
            aside:first-of-type { 
                grid-column: 1; 
                grid-row: 2; 
            }
            
            .main-stage { 
                grid-column: 2; 
                grid-row: 2; 
                min-height: 300px;
                max-height: 350px;
            }
            
            .control-area { 
                grid-column: 1 / span 2; 
                grid-row: 3; 
            }
            
            aside:last-of-type { 
                grid-column: 1 / span 2; 
                grid-row: 4; 
            }
            
            .control-area > .panel {
                padding: 8px !important;
            }
            
            #skill-1, #skill-2, #skill-3 {
                padding: 8px 4px !important;
                font-size: 0.8em !important;
            }
            
            .bag-category-tabs {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 8px;
                gap: 4px;
            }
            
            .bag-category-tabs button {
                min-width: 70px;
                padding: 6px 3px !important;
                font-size: 0.75em !important;
                flex-shrink: 0;
            }
        }

        /* é©æ‡‰ä¸åŒé«˜åº¦çš„è¢å¹• */
        @media (max-height: 700px) {
            .main-stage {
                min-height: 150px !important;
                max-height: 180px !important;
            }
            
            .enemy-sprite {
                font-size: 3.5em !important;
            }
            
            .control-area {
                min-height: 150px !important;
            }
            
            .btn {
                min-height: 50px !important;
                padding: 8px !important;
                font-size: 0.8em !important;
            }
        }

        @media (max-height: 600px) {
            .main-stage {
                min-height: 130px !important;
                max-height: 150px !important;
            }
            
            .enemy-sprite {
                font-size: 3em !important;
            }
            
            .control-area {
                min-height: 130px !important;
            }
            
            .btn {
                min-height: 45px !important;
                padding: 6px !important;
                font-size: 0.75em !important;
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <header class="panel header">
        <div style="font-size:1.2em; font-weight:bold; color:var(--accent);">âš”ï¸ å¹»æƒ³å†’éšª <span style="font-size:0.6em;">V7.4</span></div>
        <div style="font-size:0.9em;">Lv.<span id="ui-level">1</span> | æ·±åº¦: <span id="ui-depth">0</span> å±¤ | é‡‘å¹£: <span id="ui-gold" style="color:#ffd700">50</span> G</div>
    </header>

    <aside class="panel">
        <div style="text-align:center; font-size:3em; margin-bottom:8px;" id="ui-avatar">ğŸ‘¤</div>
        <h2 id="ui-class" style="text-align:center; margin:0 0 8px 0; color:var(--accent); font-size:1em;">è«‹é¸æ“‡è·æ¥­</h2>
        
        <div class="stat-label">ç¶“é©—å€¼ EXP</div>
        <div class="bar-container"><div id="exp-bar" class="bar-fill" style="background:var(--accent);"></div><div id="exp-text" class="bar-text">0/100</div></div>
        
        <div class="stat-label">ç”Ÿå‘½å€¼ HP</div>
        <div class="bar-container"><div id="hp-bar" class="bar-fill hp-fill"></div><div id="hp-text" class="bar-text">100/100</div></div>
        
        <div class="stat-label">é­”åŠ›å€¼ MP</div>
        <div class="bar-container"><div id="mp-bar" class="bar-fill mp-fill"></div><div id="mp-text" class="bar-text">100/100</div></div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin-top:15px;">
            <div style="text-align:center; background:#222; padding:6px; border-radius:5px;">
                <div style="font-size:0.6em; color:#666;">æ”»æ“ŠåŠ›</div>
                <div id="ui-atk" style="font-size:1em; font-weight:bold;">10</div>
            </div>
            <div style="text-align:center; background:#222; padding:6px; border-radius:5px;">
                <div style="font-size:0.6em; color:#666;">é˜²ç¦¦åŠ›</div>
                <div id="ui-def" style="font-size:1em; font-weight:bold;">0</div>
            </div>
            <div style="text-align:center; background:#222; padding:6px; border-radius:5px; grid-column: 1 / -1;">
                <div style="font-size:0.6em; color:#666;">æš´æ“Šç‡</div>
                <div id="ui-crit" style="font-size:1em; font-weight:bold;">5%</div>
            </div>
        </div>
        <div class="equipment-info">
            <div style="color:#666; margin-bottom:4px;">ç›®å‰è£å‚™</div>
            <div class="equipment-item">
                <div id="ui-weapon" style="color:var(--r-rare); font-size:0.8em;">æ­¦å™¨: - ç„¡ -</div>
                <div id="weapon-desc" style="font-size:0.6em; color:#888;">ç„¡æ•ˆæœ</div>
            </div>
            <div class="equipment-item">
                <div id="ui-armor" style="color:var(--r-rare); font-size:0.8em;">ç›”ç”²: - ç„¡ -</div>
                <div id="armor-desc" style="font-size:0.6em; color:#888;">ç„¡æ•ˆæœ</div>
            </div>
        </div>
    </aside>

    <main class="panel main-stage" id="stage">
        <div id="adventure-page" class="stage-page active">
            <div id="enemy-sprite" class="enemy-sprite">ğŸŒ²</div>
            
            <div id="event-name" style="font-size:1.5em; font-weight:bold; text-align:center;">å†’éšªè€…,æ­¡è¿</div>
            <div id="event-desc" style="color:#888; margin-top:6px; text-align:center; max-width:90%; font-size:0.85em;">åœ¨å³å´é¸æ“‡ä½ çš„å‡ºèº«,é–‹å§‹é€™æ®µå‚³å¥‡...</div>
        </div>

        <div id="boss-warning" class="boss-warning" style="display:none; width:90%; position: absolute; top: 15px; left: 50%; transform: translateX(-50%);">
            <div class="boss-warning-title">âš¡ BOSS ä¾†è‡¨ âš¡</div>
            <div style="color:#ffab00; font-size:0.8em;">é€™æ˜¯ç¬¬ <span id="boss-number">0</span> å°Š Bossï¼</div>
        </div>
        
        <div id="enemy-panel" class="enemy-ui" style="display:none; position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);">
            <div class="enemy-stats">
                <span>âš”ï¸ ATK: <span id="enemy-atk">0</span></span>
                <span id="enemy-hp-text">0/0</span>
            </div>
            <div class="bar-container" style="height:10px;"><div id="enemy-hp-bar" class="bar-fill hp-fill"></div></div>
        </div>

        <div id="shop-page" class="shop-page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">ğŸª å•†åº—</h2>
                <button class="btn" onclick="Game.closeShop()" style="padding:5px 10px; font-size:0.75em;">â† è¿”å›</button>
            </div>
            <div class="shop-category-tabs">
                <button class="btn active" onclick="UI.switchShopCategory('potion')">ğŸ§ª è—¥æ°´</button>
                <button class="btn" onclick="UI.switchShopCategory('weapon')">âš”ï¸ æ­¦å™¨</button>
                <button class="btn" onclick="UI.switchShopCategory('armor')">ğŸ›¡ï¸ ç›”ç”²</button>
                <button class="btn" onclick="UI.switchShopCategory('material')">ğŸ“¦ ç´ æ</button>
            </div>
            <div id="shop-potion" class="shop-grid shop-category active"></div>
            <div id="shop-weapon" class="shop-grid shop-category"></div>
            <div id="shop-armor" class="shop-grid shop-category"></div>
            <div id="shop-material" class="shop-grid shop-category"></div>
        </div>

        <div id="forge-page" class="forge-page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">âš’ï¸ é›é€ å ´</h2>
                <button class="btn" onclick="Game.closeForge()" style="padding:5px 10px; font-size:0.75em;">â† è¿”å›</button>
            </div>
            <div id="recipe-list" class="recipe-list"></div>
        </div>

        <div id="upgrade-page" class="upgrade-page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">ğŸ”§ é€²åŒ–å°</h2>
                <button class="btn" onclick="Game.closeUpgrade()" style="padding:5px 10px; font-size:0.75em;">â† è¿”å›</button>
            </div>
            <div id="upgrade-list" class="upgrade-list"></div>
        </div>
        
        <!-- æ–°å¢å¯¶ç®±ç•Œé¢ -->
        <div id="chest-page" class="chest-page" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">ğŸ ç¥ç§˜å¯¶ç®±</h2>
            </div>
            <div id="chest-content" style="text-align:center;">
                <div id="chest-icon" style="font-size:5em; margin:20px 0;">ğŸ</div>
                <div id="chest-message" style="font-size:1.1em; margin-bottom:20px;">ä½ ç™¼ç¾äº†ä¸€å€‹ç¥ç§˜å¯¶ç®±ï¼è¦æ‰“é–‹å®ƒå—ï¼Ÿ</div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-exp" onclick="Chest.open()" style="flex:1; padding:12px;">æ‰“é–‹å¯¶ç®±</button>
                    <button class="btn" onclick="Chest.skip()" style="flex:1; padding:12px;">å¿½ç•¥å¯¶ç®±</button>
                </div>
            </div>
        </div>
        
        <!-- æ–°å¢éš¨æ©Ÿäº‹ä»¶é é¢ -->
        <div id="event-page" class="event-page" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:var(--accent); margin:0; font-size:1.1em;">ğŸ² éš¨æ©Ÿäº‹ä»¶</h2>
            </div>
            <div id="event-content" style="text-align:center;">
                <div id="event-icon" style="font-size:5em; margin:20px 0;">ğŸ²</div>
                <div id="event-name" style="font-size:1.5em; font-weight:bold; margin-bottom:10px;">éš¨æ©Ÿäº‹ä»¶</div>
                <div id="event-desc" style="font-size:1.1em; margin-bottom:20px;">ä½ é‡åˆ°äº†ä¸€å€‹éš¨æ©Ÿäº‹ä»¶</div>
                <div id="event-result" style="margin-bottom:20px;"></div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-exp" onclick="RandomEvent.process()" style="flex:1; padding:12px;">ç¹¼çºŒ</button>
                    <button class="btn" onclick="RandomEvent.skip()" style="flex:1; padding:12px;">è·³é</button>
                </div>
            </div>
        </div>
    </main>

    <section class="control-area">
        <div class="panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; padding:5px;">
            <button class="btn skill-btn" id="skill-1" onclick="Combat.useSkill(1)">
                <div>å¼·åŠ›æ“Š</div>
                <small id="sk1-val" style="color:var(--accent); font-size:0.7em">0</small>
            </button>
            <button class="btn skill-btn" id="skill-2" onclick="Combat.useSkill(2)">
                <div>æ²»ç™’è¡“</div>
                <small id="sk2-val" style="color:var(--success); font-size:0.7em">0</small>
            </button>
            <button class="btn skill-btn" id="skill-3" onclick="Combat.useSkill(3)">
                <div>é›·é³´æ–¬</div>
                <small id="sk3-val" style="color:var(--mana); font-size:0.7em">0</small>
            </button>
        </div>
        <div class="panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; padding:5px;">
            <button id="btn-explore" class="btn btn-exp" onclick="Game.explore()">ğŸ¾ å†’éšª</button>
            <button id="btn-attack" class="btn btn-atk" onclick="Combat.playerAttack()" disabled>âš”ï¸ æ”»æ“Š</button>
            <button id="btn-flee" class="btn" onclick="Combat.flee()" disabled>ğŸƒ é€ƒè·‘</button>
        </div>
        <div class="panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; padding:5px;">
            <button id="btn-shop" class="btn btn-shop" onclick="Game.openShop()">ğŸª å•†åº—</button>
            <button id="btn-craft" class="btn btn-craft" onclick="Game.openForge()">âš’ï¸ é›é€ </button>
            <button id="btn-upgrade" class="btn btn-upgrade" onclick="Game.openUpgrade()">ğŸ”§ é€²åŒ–</button>
        </div>
        <div id="combat-warning" style="display: none; color: #ff9800; font-size: 0.75em; text-align: center; margin-top: 5px;">æˆ°é¬¥ä¸­ç„¡æ³•é€²å…¥å•†åº—ã€é›é€ æˆ–é€²åŒ–</div>
    </section>

    <aside class="panel" style="min-height: 0; overflow: hidden; display: flex; flex-direction: column;">
        <div class="tabs-container">
            <button class="btn active" onclick="UI.switchTab('bag', this)">ğŸ’ èƒŒåŒ…</button>
            <button class="btn" onclick="UI.switchTab('log', this)">ğŸ“œ æ—¥èªŒ</button>
        </div>
        
        <div id="bag-tab" class="tab-content active">
            <div class="bag-category-tabs">
                <button class="btn active" onclick="UI.switchBagCategory('all')">ğŸ“¦ å…¨éƒ¨</button>
                <button class="btn" onclick="UI.switchBagCategory('potion')">ğŸ§ª è—¥æ°´</button>
                <button class="btn" onclick="UI.switchBagCategory('weapon')">âš”ï¸ æ­¦å™¨</button>
                <button class="btn" onclick="UI.switchBagCategory('armor')">ğŸ›¡ï¸ ç›”ç”²</button>
                <button class="btn" onclick="UI.switchBagCategory('material')">ğŸ”§ ç´ æ</button>
            </div>
            <div class="grid-list" id="bag-grid"></div>
        </div>
        <div id="log-tab" class="tab-content"></div>
    </aside>
</div>

<div id="item-modal" class="modal-overlay">
    <div class="modal-box">
        <div id="m-icon" style="font-size:3em;"></div>
        <h2 id="m-title" style="font-size:1.1em; margin: 5px 0;"></h2>
        <div id="m-rarity" style="margin-bottom:6px; font-weight:bold; font-size:0.8em;"></div>
        <p id="m-desc" style="color:#aaa; margin-bottom:10px; font-size:0.8em;"></p>
        <div id="m-stats" style="margin-bottom:10px; font-size:0.8em; color:#ccc;"></div>
        <div style="display:flex; gap:6px;">
            <button class="btn" style="flex:1" onclick="UI.closeModal()">é—œé–‰</button>
            <button id="m-action" class="btn btn-exp" style="flex:1">åŸ·è¡Œ</button>
        </div>
    </div>
</div>

<div id="dead-modal" class="modal-overlay">
    <div class="modal-box">
        <div style="font-size:3.5em; margin-bottom:12px;">ğŸ’€</div>
        <h2 style="color:var(--danger); margin-bottom:6px; font-size:1.3em;">å†’éšªè€…æˆ°æ­»</h2>
        <p style="color:#aaa; margin-bottom:15px; line-height:1.5; font-size:0.85em;">
            ä½ çš„å‚³å¥‡æ­¢æ­¥æ–¼ç¬¬ <span id="dead-depth">0</span> å±¤<br>
            æ“Šæ•—äº† <span id="dead-bosses">0</span> å€‹BOSS<br>
            æœ€çµ‚ç­‰ç´š: Lv.<span id="dead-level">1</span>
        </p>
        <div>
            <button class="restart-btn" onclick="Game.restart()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
        <p style="color:#666; font-size:0.8em; margin-top:12px;">ä½ çš„å‹‡æ°£å°‡è¢«å¾Œä¸–å‚³é Œ...</p>
    </div>
</div>

<div id="start-modal" class="modal-overlay" style="display:flex;">
    <div class="modal-box" style="width:90%; max-width:650px; max-height:85vh;">
        <h2 style="color:var(--accent); margin-bottom:6px; font-size:1.3em;">âš”ï¸ é¸æ“‡ä½ çš„å‚³å¥‡èµ·é»</h2>
        <p style="color:#888; margin-bottom:15px; font-size:0.85em;">æ¯å€‹è·æ¥­éƒ½æœ‰ç¨ç‰¹çš„æˆé•·å„ªå‹¢ã€‚</p>
        
        <!-- é›£åº¦é¸æ“‡ -->
        <div style="margin-bottom:15px; text-align:center;">
            <div style="color:#aaa; margin-bottom:5px; font-size:0.9em;">é¸æ“‡é›£åº¦ï¼š</div>
            <div style="display:flex; gap:8px; justify-content:center;">
                <button id="difficulty-easy" class="btn" onclick="Game.setDifficulty('easy')" style="padding:6px 12px; font-size:0.8em; background:#2e7d32;">ç°¡å–®</button>
                <button id="difficulty-normal" class="btn active" onclick="Game.setDifficulty('normal')" style="padding:6px 12px; font-size:0.8em; background:#006064;">æ™®é€š</button>
                <button id="difficulty-hard" class="btn" onclick="Game.setDifficulty('hard')" style="padding:6px 12px; font-size:0.8em; background:#c62828;">å›°é›£</button>
            </div>
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">
            <div class="btn class-card" onclick="startGame('knight')">
                <div style="font-size:2.2em;">âš”ï¸</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">é¨å£«</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>â¤ï¸ HP: 180</div>
                        <div>âš¡ MP: 80</div>
                        <div>âš”ï¸ ATK: 12 | ğŸ›¡ï¸ DEF: 2</div>
                        <div style="color:#888; margin-top:5px;">é˜²ç¦¦åŠ›å¼·,ç”Ÿå­˜èƒ½åŠ›æœ€é«˜</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="startGame('thief')">
                <div style="font-size:2.2em;">ğŸ—¡ï¸</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">ç›œè³Š</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>â¤ï¸ HP: 110</div>
                        <div>âš¡ MP: 100</div>
                        <div>âš”ï¸ ATK: 18 | æš´æ“Š: 15%</div>
                        <div style="color:#888; margin-top:5px;">é«˜å‚·å®³èˆ‡æš´æ“Š,æ”»é€Ÿè¿…æ·</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="startGame('mage')">
                <div style="font-size:2.2em;">ğŸ§™</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">æ³•å¸«</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>â¤ï¸ HP: 90</div>
                        <div>âš¡ MP: 200</div>
                        <div>âš”ï¸ ATK: 10</div>
                        <div style="color:#888; margin-top:5px;">é­”æ³•è±æ²›,æŠ€èƒ½ç„¡é™æ–½æ”¾</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="startGame('ranger')">
                <div style="font-size:2.2em;">ğŸ¹</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">çµäºº</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>â¤ï¸ HP: 130</div>
                        <div>âš¡ MP: 120</div>
                        <div>âš”ï¸ ATK: 16 | æš´æ“Š: 12%</div>
                        <div style="color:#888; margin-top:5px;">å‡è¡¡ç™¼å±•,ç©©å®šè¼¸å‡º</div>
                    </div>
                </div>
            </div>
            <div class="btn class-card" onclick="showPasswordModal()">
                <div style="font-size:2.2em;">ğŸ‘‘</div>
                <div style="flex:1;">
                    <div style="font-size:1em; font-weight:bold; color:var(--accent); margin-bottom:5px;">ä¸Šå¸</div>
                    <div style="font-size:0.75em; line-height:1.4; color:#ccc;">
                        <div>â¤ï¸ HP: 10000</div>
                        <div>âš¡ MP: 10000</div>
                        <div>âš”ï¸ ATK: 1000 | ğŸ›¡ï¸ DEF: 100</div>
                        <div style="color:#888; margin-top:5px;">å…¨èƒ½çš„ç¥æ˜ï¼Œæ“æœ‰ç„¡é™çš„åŠ›é‡</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="password-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <div style="font-size:3em; margin-bottom:10px;">ğŸ”’</div>
        <h2 style="color:var(--accent); margin-bottom:10px;">è¼¸å…¥å¯†ç¢¼è§£é–ä¸Šå¸æ¨¡å¼</h2>
        <input type="password" id="password-input" class="password-input" placeholder="è¼¸å…¥å¯†ç¢¼">
        <div class="password-error" id="password-error"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn" style="flex:1" onclick="checkPassword()">ç¢ºèª</button>
            <button class="btn" style="flex:1" onclick="hidePasswordModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    // éŠæˆ²å…¨å±€è®Šé‡
    let isCombatAction = false;
    let currentBagCategory = 'all';
    let currentShopCategory = 'potion';
    let gameDifficulty = 'normal'; // é è¨­ç‚ºæ™®é€šé›£åº¦
    let isOpeningChest = false; // é˜²æ­¢å¯¶ç®±é‡è¤‡é–‹å•Ÿ
    let isProcessingEvent = false; // é˜²æ­¢äº‹ä»¶é‡è¤‡è™•ç†

    // å¯†ç¢¼é©—è­‰ç›¸é—œ
    const GOD_PASSWORDS = ['940516', '991103'];
    let passwordAttempts = 0;
    const MAX_PASSWORD_ATTEMPTS = 5;

    // é›£åº¦ä¿‚æ•¸
    const DIFFICULTY_MODIFIERS = {
        easy: {
            monsterGrowth: 0.04, // æ€ªç‰©æˆé•·ä¿‚æ•¸
            playerDamageMultiplier: 1.3, // ç©å®¶å‚·å®³åŠ æˆ
            monsterDamageMultiplier: 0.7, // æ€ªç‰©å‚·å®³é™ä½
            goldMultiplier: 1.5, // é‡‘å¹£ç²å¾—åŠ æˆ
            expMultiplier: 1.5, // ç¶“é©—ç²å¾—åŠ æˆ
            chestChance: 0.2, // å¯¶ç®±å‡ºç¾æ©Ÿç‡ï¼ˆæ”¹ç‚ºå¹³å‡5å±¤è§¸ç™¼ä¸€æ¬¡ï¼‰
            eventChance: 0.2 // éš¨æ©Ÿäº‹ä»¶æ©Ÿç‡ï¼ˆæ”¹ç‚ºå¹³å‡5å±¤è§¸ç™¼ä¸€æ¬¡ï¼‰
        },
        normal: {
            monsterGrowth: 0.08,
            playerDamageMultiplier: 1.0,
            monsterDamageMultiplier: 1.0,
            goldMultiplier: 1.0,
            expMultiplier: 1.0,
            chestChance: 0.2, // æ”¹ç‚ºå¹³å‡5å±¤è§¸ç™¼ä¸€æ¬¡
            eventChance: 0.2 // æ”¹ç‚ºå¹³å‡5å±¤è§¸ç™¼ä¸€æ¬¡
        },
        hard: {
            monsterGrowth: 0.12,
            playerDamageMultiplier: 0.8,
            monsterDamageMultiplier: 1.3,
            goldMultiplier: 0.7,
            expMultiplier: 0.8,
            chestChance: 0.2, // æ”¹ç‚ºå¹³å‡5å±¤è§¸ç™¼ä¸€æ¬¡
            eventChance: 0.2 // æ”¹ç‚ºå¹³å‡5å±¤è§¸ç™¼ä¸€æ¬¡
        }
    };

    // æ“´å±•çš„éŠæˆ²æ•¸æ“šåº«
    const DB = {
        monsters: [
            // åˆç´šæ€ªç‰©
            { name: "å²èŠå§†", hp: 30, atk: 4, icon: "ğŸŸ¢", rarity: 1 },
            { name: "å°è™è ", hp: 25, atk: 5, icon: "ğŸ¦‡", rarity: 1 },
            { name: "å“¥å¸ƒæ—", hp: 45, atk: 7, icon: "ğŸ‘¹", rarity: 1 },
            { name: "éª·é«å…µ", hp: 55, atk: 9, icon: "ğŸ’€", rarity: 1 },
            { name: "æ³¥æ²¼æ€ª", hp: 65, atk: 8, icon: "ğŸŸ¤", rarity: 1 },
            
            // ä¸­ç´šæ€ªç‰©
            { name: "é‡ç‹¼", hp: 80, atk: 12, icon: "ğŸº", rarity: 2 },
            { name: "çŸ³åƒé¬¼", hp: 100, atk: 15, icon: "ğŸ—¿", rarity: 2 },
            { name: "æ¯’èœ˜è››", hp: 70, atk: 18, icon: "ğŸ•·ï¸", rarity: 2 },
            { name: "å¹½éˆ", hp: 90, atk: 14, icon: "ğŸ‘»", rarity: 2 },
            { name: "å·¨èŸ»", hp: 85, atk: 16, icon: "ğŸœ", rarity: 2 },
            
            // é«˜ç´šæ€ªç‰©
            { name: "ç«ç„°å…ƒç´ ", hp: 150, atk: 25, icon: "ğŸ”¥", rarity: 3 },
            { name: "å†°éœœç²¾éˆ", hp: 140, atk: 22, icon: "â„ï¸", rarity: 3 },
            { name: "é›·é›»ç¸", hp: 160, atk: 28, icon: "âš¡", rarity: 3 },
            { name: "å²©æ¼¿æ€ª", hp: 180, atk: 32, icon: "ğŸŒ‹", rarity: 3 },
            { name: "æš—å½±è±¹", hp: 130, atk: 30, icon: "ğŸ†", rarity: 3 },
            
            // ç¨€æœ‰æ€ªç‰©
            { name: "ç¨çœ¼å·¨äºº", hp: 250, atk: 40, icon: "ğŸ‘ï¸", rarity: 4 },
            { name: "é›™é ­çŠ¬", hp: 220, atk: 35, icon: "ğŸ•â€ğŸ¦º", rarity: 4 },
            { name: "é£›é¾", hp: 300, atk: 45, icon: "ğŸ²", rarity: 4 },
            { name: "æµ·æ€ª", hp: 280, atk: 38, icon: "ğŸ™", rarity: 4 },
            { name: "æ¨¹ç²¾", hp: 240, atk: 33, icon: "ğŸŒ³", rarity: 4 }
        ],
        
        bosses: [
            { name: "ç«ç„°ä¹‹ç‹", hp: 800, atk: 100, icon: "ğŸ”¥ğŸ‘‘", rarity: 5 },
            { name: "å†°éœœå¥³çš‡", hp: 900, atk: 110, icon: "â„ï¸ğŸ‘‘", rarity: 5 },
            { name: "é›·éœ†æ³°å¦", hp: 1000, atk: 120, icon: "âš¡ğŸ‘‘", rarity: 5 },
            { name: "æ·±æ·µé ˜ä¸»", hp: 1200, atk: 140, icon: "ğŸ‘¿ğŸ‘‘", rarity: 5 },
            { name: "è–å…‰å¤©ä½¿", hp: 1100, atk: 130, icon: "ğŸ‘¼ğŸ‘‘", rarity: 5 }
        ],
        
        // ç‰©å“æ•¸æ“šåº«
        items: {
            // è—¥æ°´é¡
            "å°å‹ç´…è—¥æ°´": { type: "potion", category: "potion", effect: "hp", val: 80, price: 15, icon: "ğŸ§ª", r: "common", desc: "æ¢å¾© 80 HP" },
            "ä¸­å‹ç´…è—¥æ°´": { type: "potion", category: "potion", effect: "hp", val: 200, price: 45, icon: "ğŸ§ª", r: "rare", desc: "æ¢å¾© 200 HP" },
            "å¤§å‹ç´…è—¥æ°´": { type: "potion", category: "potion", effect: "hp", val: 500, price: 100, icon: "ğŸ§ª", r: "epic", desc: "æ¢å¾© 500 HP" },
            "å°å‹è—è—¥æ°´": { type: "potion", category: "potion", effect: "mp", val: 60, price: 15, icon: "ğŸ’§", r: "common", desc: "æ¢å¾© 60 MP" },
            "ä¸­å‹è—è—¥æ°´": { type: "potion", category: "potion", effect: "mp", val: 150, price: 40, icon: "ğŸ’§", r: "rare", desc: "æ¢å¾© 150 MP" },
            "å¤§å‹è—è—¥æ°´": { type: "potion", category: "potion", effect: "mp", val: 300, price: 80, icon: "ğŸ’§", r: "epic", desc: "æ¢å¾© 300 MP" },
            "å…¨æ¢å¾©è—¥æ°´": { type: "potion", category: "potion", effect: "both", val: 999, price: 200, icon: "ğŸŒŸ", r: "epic", desc: "æ¢å¾©å…¨éƒ¨HPå’ŒMP" },
            
            // æ­¦å™¨é¡ - æ™®é€šæ­¦å™¨å¯åœ¨å•†åº—è³¼è²·
            "æœ¨åŠ": { type: "weapon", category: "weapon", atk: 10, price: 30, icon: "ğŸªµ", r: "common", desc: "ATK +10" },
            "éµåŠ": { type: "weapon", category: "weapon", atk: 25, price: 80, icon: "ğŸ—¡ï¸", r: "common", desc: "ATK +25" },
            "é‹¼éµé•·åŠ": { type: "weapon", category: "weapon", atk: 45, price: 150, icon: "âš”ï¸", r: "rare", desc: "ATK +45" },
            "éŠ€è£½é•·åŠ": { type: "weapon", category: "weapon", atk: 65, price: 250, icon: "ğŸ”ª", r: "rare", desc: "ATK +65" },
            "é­”åŠ›æ³•æ–": { type: "weapon", category: "weapon", atk: 40, price: 180, icon: "ğŸª„", r: "rare", desc: "ATK +40 (é­”æ³•åŠ æˆ)" },
            
            // ç™¾åˆ†æ¯”æ­¦å™¨ - åªèƒ½é€šéé›é€ ç²å¾— (craftOnly: true)
            "ç«ç„°åŠ": { type: "weapon", category: "weapon", atk: 85, atkPercent: 5, price: 400, icon: "ğŸ”¥ğŸ—¡ï¸", r: "epic", desc: "ATK +85ï¼Œæ”»æ“ŠåŠ›+5%", craftOnly: true },
            "å†°éœœä¹‹åˆƒ": { type: "weapon", category: "weapon", atk: 90, atkPercent: 8, price: 450, icon: "â„ï¸ğŸ—¡ï¸", r: "epic", desc: "ATK +90ï¼Œæ”»æ“ŠåŠ›+8%", craftOnly: true },
            "è‹±é›„ä¹‹åˆƒ": { type: "weapon", category: "weapon", atk: 120, atkPercent: 10, price: 800, icon: "âœ¨", r: "epic", desc: "ATK +120ï¼Œæ”»æ“ŠåŠ›+10%", craftOnly: true },
            "è–åŠè‰¾å…‹æ–¯": { type: "weapon", category: "weapon", atk: 200, atkPercent: 15, price: 2000, icon: "ğŸ”±", r: "legend", desc: "ATK +200ï¼Œæ”»æ“ŠåŠ›+15%", craftOnly: true },
            "é¾ç‰™åŠ": { type: "weapon", category: "weapon", atk: 180, atkPercent: 12, price: 1500, icon: "ğŸ‰ğŸ—¡ï¸", r: "legend", desc: "ATK +180ï¼Œæ”»æ“ŠåŠ›+12%", craftOnly: true },
            
            // ç›”ç”²é¡ - æ™®é€šç›”ç”²å¯åœ¨å•†åº—è³¼è²·
            "å¸ƒè¡£": { type: "armor", category: "armor", hp: 20, def: 1, price: 40, icon: "ğŸ‘•", r: "common", desc: "HP +20, DEF +1" },
            "çš®ç”²": { type: "armor", category: "armor", hp: 50, def: 3, price: 100, icon: "ğŸ§¥", r: "common", desc: "HP +50, DEF +3" },
            "é–å­ç”²": { type: "armor", category: "armor", hp: 100, def: 5, price: 250, icon: "ğŸ¥¼", r: "rare", desc: "HP +100, DEF +5" },
            "é‹¼éµç›”ç”²": { type: "armor", category: "armor", hp: 200, def: 8, price: 500, icon: "ğŸ¤–", r: "rare", desc: "HP +200, DEF +8" },
            "é­”æ³•è¢": { type: "armor", category: "armor", hp: 150, def: 4, mp: 50, price: 400, icon: "ğŸ§™â€â™‚ï¸", r: "rare", desc: "HP +150, DEF +4, MP +50" },
            
            // ç™¾åˆ†æ¯”ç›”ç”² - åªèƒ½é€šéé›é€ ç²å¾— (craftOnly: true)
            "é¾é±—ç”²": { type: "armor", category: "armor", hp: 300, def: 12, price: 1000, icon: "ğŸ‰ğŸ›¡ï¸", r: "epic", desc: "HP +300, DEF +12", craftOnly: true },
            "è–é¨å£«ç›”ç”²": { type: "armor", category: "armor", hp: 400, def: 15, price: 1500, icon: "âšœï¸", r: "epic", desc: "HP +400, DEF +15", craftOnly: true },
            "ç¥è–æˆ°ç”²": { type: "armor", category: "armor", hp: 500, def: 20, price: 2500, icon: "âœ¨ğŸ›¡ï¸", r: "legend", desc: "HP +500, DEF +20", craftOnly: true },
            
            // ç‰¹æ®Šç¥è©±è£å‚™ - åªèƒ½é€šéé›é€ ç²å¾— (craftOnly: true)
            "ä¸æœ½æˆ°ç”²": { type: "armor", category: "armor", hp: 0, hpPercent: 25, def: 15, price: 5000, icon: "â™¾ï¸ğŸ›¡ï¸", r: "mythic", desc: "ç¥ç´šæˆ°ç”²ï¼Œå¢åŠ 25%æœ€å¤§ç”Ÿå‘½å€¼å’Œ15é»é˜²ç¦¦", craftOnly: true },
            "ç”Ÿå‘½ä¹‹æºè­·ç”²": { type: "armor", category: "armor", hp: 0, hpPercent: 15, def: 8, price: 3000, icon: "ğŸŒ¿ğŸ›¡ï¸", r: "mythic", desc: "ç¥ç§˜è­·ç”²ï¼Œå¢åŠ 15%æœ€å¤§ç”Ÿå‘½å€¼å’Œ8é»é˜²ç¦¦", craftOnly: true },
            
            // ç´ æé¡ - æ™®é€šç´ æå¯åœ¨å•†åº—è³¼è²·
            "æœ¨æ": { type: "material", category: "material", price: 5, icon: "ğŸªµ", r: "common", desc: "åŸºç¤æœ¨æ" },
            "éµç¤¦çŸ³": { type: "material", category: "material", price: 10, icon: "ğŸª¨", r: "common", desc: "éµè£½å“çš„åŸæ–™" },
            "éŠ…ç¤¦çŸ³": { type: "material", category: "material", price: 15, icon: "ğŸ¥‰", r: "common", desc: "éŠ…è£½å“çš„åŸæ–™" },
            "éŠ€ç¤¦çŸ³": { type: "material", category: "material", price: 30, icon: "ğŸ¥ˆ", r: "common", desc: "éŠ€è£½å“çš„åŸæ–™" },
            "é‡‘ç¤¦çŸ³": { type: "material", category: "material", price: 50, icon: "ğŸ¥‡", r: "rare", desc: "é‡‘è£½å“çš„åŸæ–™" },
            "ç¸çš®": { type: "material", category: "material", price: 8, icon: "ğŸº", r: "common", desc: "é‡ç¸çš„çš®æ¯›" },
            "å°–ç‰™": { type: "material", category: "material", price: 12, icon: "ğŸ¦·", r: "common", desc: "æ€ªç‰©çš„å°–ç‰™" },
            "çˆªå­": { type: "material", category: "material", price: 15, icon: "ğŸ¾", r: "common", desc: "æ€ªç‰©çš„åˆ©çˆª" },
            "ç¾½æ¯›": { type: "material", category: "material", price: 10, icon: "ğŸª¶", r: "common", desc: "é³¥é¡çš„ç¾½æ¯›" },
            "é­”æ³•çµæ™¶": { type: "material", category: "material", price: 40, icon: "ğŸ’", r: "rare", desc: "è˜Šå«é­”åŠ›çš„æ™¶é«”" },
            "éˆé­‚ç¢ç‰‡": { type: "material", category: "material", price: 60, icon: "ğŸ‘»", r: "rare", desc: "æ€ªç‰©éˆé­‚çš„ç¢ç‰‡" },
            "ç«ç„°ä¹‹å¿ƒ": { type: "material", category: "material", price: 80, icon: "â¤ï¸â€ğŸ”¥", r: "rare", desc: "ç«ç„°å…ƒç´ çš„ç²¾è¯" },
            "å†°éœœæ ¸å¿ƒ": { type: "material", category: "material", price: 80, icon: "â„ï¸", r: "rare", desc: "å†°éœœå…ƒç´ çš„ç²¾è¯" },
            "é›·é›»ä¹‹æ ¸": { type: "material", category: "material", price: 80, icon: "âš¡", r: "rare", desc: "é›·é›»å…ƒç´ çš„ç²¾è¯" },
            "å¼·åŒ–å¯¶çŸ³": { type: "material", category: "material", price: 100, icon: "ğŸ’", r: "rare", desc: "ç”¨æ–¼å¼·åŒ–è£å‚™" },
            
            // ç¨€æœ‰ç´ æ - åªèƒ½é€šéæ‰è½ç²å¾— (craftOnly: true)
            "é¾é±—": { type: "material", category: "material", price: 150, icon: "ğŸ‰", r: "epic", desc: "å‚³èªªç”Ÿç‰©çš„é±—ç‰‡", craftOnly: true },
            "é³³å‡°ä¹‹ç¾½": { type: "material", category: "material", price: 200, icon: "ğŸ¦š", r: "epic", desc: "é³³å‡°çš„ç¥è–ç¾½æ¯›", craftOnly: true },
            "æƒ¡é­”è§’": { type: "material", category: "material", price: 180, icon: "ğŸ‘¿", r: "epic", desc: "æƒ¡é­”çš„è§’", craftOnly: true },
            "å¤©ä½¿ä¹‹ç¾½": { type: "material", category: "material", price: 250, icon: "ğŸ‘¼", r: "legend", desc: "å¤©ä½¿çš„ç´”ç™½ç¾½æ¯›", craftOnly: true },
            "æ˜Ÿè¾°ç¢ç‰‡": { type: "material", category: "material", price: 300, icon: "â­", r: "legend", desc: "å¢œè½æ˜Ÿè¾°çš„ç¢ç‰‡", craftOnly: true },
            "ç¥ä¹‹è¡€": { type: "material", category: "material", price: 500, icon: "ğŸ©¸", r: "mythic", desc: "ç¥æ˜çš„è¡€æ¶²", craftOnly: true },
            
            // è­·ç¬¦é¡ - æ”¹ç‚ºåªèƒ½é€šéé›é€ ç²å¾— (craftOnly: true)
            "åŠ›é‡è­·ç¬¦": { type: "buff", category: "buff", stat: "atk", val: 10, price: 0, icon: "ğŸ’", r: "rare", desc: "æ°¸ä¹… ATK +10", craftOnly: true },
            "é˜²ç¦¦è­·ç¬¦": { type: "buff", category: "buff", stat: "def", val: 5, price: 0, icon: "ğŸ›¡ï¸", r: "rare", desc: "æ°¸ä¹… DEF +5", craftOnly: true },
            "ç”Ÿå‘½è­·ç¬¦": { type: "buff", category: "buff", stat: "maxHp", val: 50, price: 0, icon: "â¤ï¸", r: "rare", desc: "æ°¸ä¹… MaxHP +50", craftOnly: true },
            "é­”åŠ›è­·ç¬¦": { type: "buff", category: "buff", stat: "maxMp", val: 30, price: 0, icon: "ğŸŒ€", r: "rare", desc: "æ°¸ä¹… MaxMP +30", craftOnly: true },
            "æš´æ“Šå¯¶ç ": { type: "buff", category: "buff", stat: "crit", val: 3, price: 0, icon: "âœ¨", r: "epic", desc: "æš´æ“Šç‡ +3%", craftOnly: true },
            
            // ä¸Šå¸æ¨¡å¼å°ˆå±¬è£å‚™
            "ç¥æ€’ä¹‹åˆƒ": { type: "weapon", category: "weapon", atk: 150, atkPercent: 20, price: 0, icon: "âš¡ğŸ—¡ï¸", r: "mythic", desc: "ç¥æ˜æ†¤æ€’çš„æ­¦å™¨ï¼Œå¢åŠ 150é»æ”»æ“ŠåŠ›å’Œ20%æ”»æ“ŠåŠ›", godOnly: true },
            "ä¸æœ½æˆ°ç”²": { type: "armor", category: "armor", hp: 0, hpPercent: 25, def: 15, price: 0, icon: "â™¾ï¸ğŸ›¡ï¸", r: "mythic", desc: "ç¥ç´šæˆ°ç”²ï¼Œå¢åŠ 25%æœ€å¤§ç”Ÿå‘½å€¼å’Œ15é»é˜²ç¦¦", godOnly: true },
            "ç”Ÿå‘½ä¹‹æºè­·ç”²": { type: "armor", category: "armor", hp: 0, hpPercent: 15, def: 8, price: 0, icon: "ğŸŒ¿ğŸ›¡ï¸", r: "mythic", desc: "ç¥ç§˜è­·ç”²ï¼Œå¢åŠ 15%æœ€å¤§ç”Ÿå‘½å€¼å’Œ8é»é˜²ç¦¦", godOnly: true }
        },
        
        // åˆæˆé…æ–¹
        recipes: [
            {
                id: 1,
                name: "éµåŠ",
                icon: "ğŸ—¡ï¸",
                result: "éµåŠ",
                desc: "åŸºç¤æ­¦å™¨ï¼Œå¢åŠ 25é»æ”»æ“ŠåŠ›",
                materials: [
                    { name: "éµç¤¦çŸ³", amount: 5 },
                    { name: "æœ¨æ", amount: 3 }
                ]
            },
            {
                id: 2,
                name: "é‹¼éµé•·åŠ",
                icon: "âš”ï¸",
                result: "é‹¼éµé•·åŠ",
                desc: "å …å›ºçš„é‹¼åŠï¼Œå¢åŠ 45é»æ”»æ“ŠåŠ›",
                materials: [
                    { name: "éµç¤¦çŸ³", amount: 8 },
                    { name: "éŠ…ç¤¦çŸ³", amount: 3 },
                    { name: "ç¸çš®", amount: 2 }
                ]
            },
            {
                id: 3,
                name: "é–å­ç”²",
                icon: "ğŸ¥¼",
                result: "é–å­ç”²",
                desc: "é˜²è­·ç›”ç”²ï¼Œå¢åŠ 100HPå’Œ5é»é˜²ç¦¦",
                materials: [
                    { name: "éµç¤¦çŸ³", amount: 10 },
                    { name: "éŠ…ç¤¦çŸ³", amount: 5 },
                    { name: "ç¸çš®", amount: 3 }
                ]
            },
            {
                id: 4,
                name: "é¾é±—ç”²",
                icon: "ğŸ‰ğŸ›¡ï¸",
                result: "é¾é±—ç”²",
                desc: "å‚³èªªé¾é±—è£½æˆçš„ç›”ç”²ï¼Œå¢åŠ 300HPå’Œ12é»é˜²ç¦¦",
                materials: [
                    { name: "é¾é±—", amount: 5 },
                    { name: "é‡‘ç¤¦çŸ³", amount: 10 },
                    { name: "é­”æ³•çµæ™¶", amount: 8 }
                ]
            },
            {
                id: 5,
                name: "ç«ç„°åŠ",
                icon: "ğŸ”¥ğŸ—¡ï¸",
                result: "ç«ç„°åŠ",
                desc: "é™„é­”ç«ç„°ä¹‹åŠï¼Œå¢åŠ 85é»æ”»æ“ŠåŠ›å’Œ5%æ”»æ“ŠåŠ›",
                materials: [
                    { name: "éµç¤¦çŸ³", amount: 10 },
                    { name: "ç«ç„°ä¹‹å¿ƒ", amount: 3 },
                    { name: "é­”æ³•çµæ™¶", amount: 2 }
                ]
            },
            {
                id: 6,
                name: "ç”Ÿå‘½ä¹‹æºè­·ç”²",
                icon: "ğŸŒ¿ğŸ›¡ï¸",
                result: "ç”Ÿå‘½ä¹‹æºè­·ç”²",
                desc: "ç¥ç§˜è­·ç”²ï¼Œå¢åŠ 15%æœ€å¤§ç”Ÿå‘½å€¼å’Œ8é»é˜²ç¦¦",
                materials: [
                    { name: "å¤©ä½¿ä¹‹ç¾½", amount: 2 },
                    { name: "æ˜Ÿè¾°ç¢ç‰‡", amount: 3 },
                    { name: "é­”æ³•çµæ™¶", amount: 10 },
                    { name: "ç¥ä¹‹è¡€", amount: 1 }
                ]
            },
            {
                id: 7,
                name: "ä¸æœ½æˆ°ç”²",
                icon: "â™¾ï¸ğŸ›¡ï¸",
                result: "ä¸æœ½æˆ°ç”²",
                desc: "ç¥ç´šæˆ°ç”²ï¼Œå¢åŠ 25%æœ€å¤§ç”Ÿå‘½å€¼å’Œ15é»é˜²ç¦¦",
                materials: [
                    { name: "ç¥ä¹‹è¡€", amount: 3 },
                    { name: "æ˜Ÿè¾°ç¢ç‰‡", amount: 5 },
                    { name: "é¾é±—", amount: 10 },
                    { name: "é³³å‡°ä¹‹ç¾½", amount: 5 }
                ]
            },
            {
                id: 8,
                name: "è–åŠè‰¾å…‹æ–¯",
                icon: "ğŸ”±",
                result: "è–åŠè‰¾å…‹æ–¯",
                desc: "ç¥è–å‚³èªªä¹‹åŠï¼Œå¢åŠ 200é»æ”»æ“ŠåŠ›å’Œ15%æ”»æ“ŠåŠ›",
                materials: [
                    { name: "å¤©ä½¿ä¹‹ç¾½", amount: 2 },
                    { name: "æ˜Ÿè¾°ç¢ç‰‡", amount: 3 },
                    { name: "é‡‘ç¤¦çŸ³", amount: 8 },
                    { name: "é­”æ³•çµæ™¶", amount: 5 }
                ]
            },
            {
                id: 9,
                name: "å†°éœœä¹‹åˆƒ",
                icon: "â„ï¸ğŸ—¡ï¸",
                result: "å†°éœœä¹‹åˆƒ",
                desc: "å¯’å†°é™„é­”ä¹‹åŠï¼Œå¢åŠ 90é»æ”»æ“ŠåŠ›å’Œ8%æ”»æ“ŠåŠ›",
                materials: [
                    { name: "éŠ€è£½é•·åŠ", amount: 1 },
                    { name: "å†°éœœæ ¸å¿ƒ", amount: 5 },
                    { name: "é­”æ³•çµæ™¶", amount: 8 }
                ]
            },
            {
                id: 10,
                name: "è‹±é›„ä¹‹åˆƒ",
                icon: "âœ¨",
                result: "è‹±é›„ä¹‹åˆƒ",
                desc: "è‹±é›„çš„æ­¦å™¨ï¼Œå¢åŠ 120é»æ”»æ“ŠåŠ›å’Œ10%æ”»æ“ŠåŠ›",
                materials: [
                    { name: "é‹¼éµé•·åŠ", amount: 1 },
                    { name: "é¾é±—", amount: 3 },
                    { name: "æ˜Ÿè¾°ç¢ç‰‡", amount: 2 },
                    { name: "å¼·åŒ–å¯¶çŸ³", amount: 5 }
                ]
            },
            // æ–°å¢è­·ç¬¦é…æ–¹
            {
                id: 11,
                name: "åŠ›é‡è­·ç¬¦",
                icon: "ğŸ’",
                result: "åŠ›é‡è­·ç¬¦",
                desc: "æ°¸ä¹…å¢åŠ 10é»æ”»æ“ŠåŠ›",
                materials: [
                    { name: "é‡‘ç¤¦çŸ³", amount: 5 },
                    { name: "é­”æ³•çµæ™¶", amount: 3 },
                    { name: "å¼·åŒ–å¯¶çŸ³", amount: 2 }
                ]
            },
            {
                id: 12,
                name: "é˜²ç¦¦è­·ç¬¦",
                icon: "ğŸ›¡ï¸",
                result: "é˜²ç¦¦è­·ç¬¦",
                desc: "æ°¸ä¹…å¢åŠ 5é»é˜²ç¦¦åŠ›",
                materials: [
                    { name: "éŠ€ç¤¦çŸ³", amount: 5 },
                    { name: "ç¸çš®", amount: 3 },
                    { name: "å¼·åŒ–å¯¶çŸ³", amount: 2 }
                ]
            },
            {
                id: 13,
                name: "ç”Ÿå‘½è­·ç¬¦",
                icon: "â¤ï¸",
                result: "ç”Ÿå‘½è­·ç¬¦",
                desc: "æ°¸ä¹…å¢åŠ 50é»æœ€å¤§ç”Ÿå‘½å€¼",
                materials: [
                    { name: "é‡‘ç¤¦çŸ³", amount: 3 },
                    { name: "é­”æ³•çµæ™¶", amount: 5 },
                    { name: "å¼·åŒ–å¯¶çŸ³", amount: 3 }
                ]
            },
            {
                id: 14,
                name: "é­”åŠ›è­·ç¬¦",
                icon: "ğŸŒ€",
                result: "é­”åŠ›è­·ç¬¦",
                desc: "æ°¸ä¹…å¢åŠ 30é»æœ€å¤§é­”åŠ›å€¼",
                materials: [
                    { name: "éŠ€ç¤¦çŸ³", amount: 3 },
                    { name: "é­”æ³•çµæ™¶", amount: 8 },
                    { name: "å¼·åŒ–å¯¶çŸ³", amount: 3 }
                ]
            },
            {
                id: 15,
                name: "æš´æ“Šå¯¶ç ",
                icon: "âœ¨",
                result: "æš´æ“Šå¯¶ç ",
                desc: "æ°¸ä¹…å¢åŠ 3%æš´æ“Šç‡",
                materials: [
                    { name: "é‡‘ç¤¦çŸ³", amount: 10 },
                    { name: "æ˜Ÿè¾°ç¢ç‰‡", amount: 2 },
                    { name: "å¼·åŒ–å¯¶çŸ³", amount: 5 }
                ]
            }
        ],
        
        // å¼·åŒ–è¦å‰‡
        enhancementRules: {
            // æ¯æ¬¡å¼·åŒ–å¢åŠ çš„å±¬æ€§
            weapon: {
                atk: 5, // æ¯æ¬¡å¼·åŒ–å¢åŠ 5é»æ”»æ“ŠåŠ›
                atkPercent: 1, // æ¯æ¬¡å¼·åŒ–å¢åŠ 1%æ”»æ“ŠåŠ›
                costMultiplier: 100, // åŸºç¤é‡‘å¹£æ¶ˆè€—
                materialCost: 2, // æ¯æ¬¡å¼·åŒ–éœ€è¦çš„å¼·åŒ–å¯¶çŸ³æ•¸é‡
                successRate: [100, 90, 80, 70, 60, 50, 40, 30, 20, 10] // å¼·åŒ–ç­‰ç´š0-9çš„æˆåŠŸç‡
            },
            armor: {
                hp: 20, // æ¯æ¬¡å¼·åŒ–å¢åŠ 20HP
                def: 2, // æ¯æ¬¡å¼·åŒ–å¢åŠ 2é»é˜²ç¦¦
                hpPercent: 0.5, // æ¯æ¬¡å¼·åŒ–å¢åŠ 0.5%ç”Ÿå‘½å€¼
                costMultiplier: 80,
                materialCost: 2,
                successRate: [100, 90, 80, 70, 60, 50, 40, 30, 20, 10]
            }
        },
        
        // å¯¶ç®±çå‹µèˆ‡æ‡²ç½°
        chestRewards: {
            good: [
                { type: "gold", amount: 500, message: "ç™¼ç¾äº† 500 é‡‘å¹£ï¼", icon: "ğŸ’°" },
                { type: "exp", amount: 100, message: "ç²å¾— 100 ç¶“é©—å€¼ï¼", icon: "â­" },
                { type: "item", item: "å¤§å‹ç´…è—¥æ°´", message: "ç™¼ç¾äº† å¤§å‹ç´…è—¥æ°´ï¼", icon: "ğŸ§ª" },
                { type: "item", item: "å¤§å‹è—è—¥æ°´", message: "ç™¼ç¾äº† å¤§å‹è—è—¥æ°´ï¼", icon: "ğŸ’§" },
                { type: "material", item: "å¼·åŒ–å¯¶çŸ³", amount: 10, message: "ç™¼ç¾äº† 10 å€‹å¼·åŒ–å¯¶çŸ³ï¼", icon: "ğŸ’" },
                { type: "material", item: "é‡‘ç¤¦çŸ³", amount: 5, message: "ç™¼ç¾äº† 5 å€‹é‡‘ç¤¦çŸ³ï¼", icon: "ğŸ¥‡" },
                { type: "buff", stat: "atk", val: 5, message: "ç²å¾—åŠ›é‡ç¥ç¦ï¼æ”»æ“ŠåŠ›æ°¸ä¹… +5", icon: "ğŸ’ª" },
                { type: "buff", stat: "maxHp", val: 50, message: "ç²å¾—ç”Ÿå‘½ç¥ç¦ï¼æœ€å¤§ç”Ÿå‘½å€¼æ°¸ä¹… +50", icon: "â¤ï¸" }
            ],
            bad: [
                { type: "damage", amount: 30, message: "å¯¶ç®±çˆ†ç‚¸ï¼å—åˆ° 30 é»å‚·å®³", icon: "ğŸ’¥" },
                { type: "curse", stat: "atk", val: -5, message: "è¢«è©›å’’äº†ï¼æ”»æ“ŠåŠ›æ°¸ä¹… -5", icon: "ğŸ‘¹" },
                { type: "trap", damage: 50, message: "è§¸ç™¼é™·é˜±ï¼å—åˆ° 50 é»å‚·å®³", icon: "âš ï¸" },
                { type: "goldLoss", amount: 200, message: "å¯¶ç®±æ˜¯ç©ºçš„ï¼Œé‚„æå¤±äº† 200 é‡‘å¹£", icon: "ğŸ˜­" },
                { type: "poison", damage: 20, duration: 3, message: "ä¸­æ¯’äº†ï¼æ¯å›åˆå—åˆ° 20 é»å‚·å®³ï¼ŒæŒçºŒ 3 å›åˆ", icon: "â˜ ï¸" },
                { type: "confusion", message: "é™·å…¥æ··äº‚ï¼ä¸‹å›åˆæ”»æ“Šå¯èƒ½å¤±èª¤", icon: "ğŸŒ€" }
            ]
        },
        
        // éš¨æ©Ÿäº‹ä»¶
        randomEvents: [
            // å£äº‹ä»¶
            {
                name: "è·Œè½å±±è°·",
                icon: "ğŸª¨",
                desc: "ä½ ä¸å°å¿ƒè·Œè½å±±è°·ï¼Œå—åˆ°äº†ä¸€äº›å‚·å®³ã€‚",
                type: "bad",
                effect: function() {
                    const damage = Math.floor(Player.maxHp * 0.15);
                    Player.hp = Math.max(1, Player.hp - damage);
                    UI.log(`è·Œè½å±±è°·ï¼Œå—åˆ° ${damage} é»å‚·å®³ï¼`);
                    return `ä½ è·Œè½å±±è°·ï¼Œå—åˆ° ${damage} é»å‚·å®³ï¼`;
                }
            },
            {
                name: "é­é‡é™·é˜±",
                icon: "âš ï¸",
                desc: "ä½ ä¸å°å¿ƒè§¸ç™¼äº†é™·é˜±ï¼Œå—åˆ°äº†å‚·å®³ã€‚",
                type: "bad",
                effect: function() {
                    const damage = Math.floor(Player.maxHp * 0.1);
                    Player.hp = Math.max(1, Player.hp - damage);
                    UI.log(`è§¸ç™¼é™·é˜±ï¼Œå—åˆ° ${damage} é»å‚·å®³ï¼`);
                    return `ä½ è§¸ç™¼äº†é™·é˜±ï¼Œå—åˆ° ${damage} é»å‚·å®³ï¼`;
                }
            },
            {
                name: "è¿·è·¯",
                icon: "ğŸŒ€",
                desc: "ä½ åœ¨è¿·å®®ä¸­è¿·è·¯äº†ï¼Œæµªè²»äº†ä¸€äº›æ™‚é–“ã€‚",
                type: "bad",
                effect: function() {
                    UI.log("ä½ åœ¨è¿·å®®ä¸­è¿·è·¯äº†ï¼Œæµªè²»äº†ä¸€äº›æ™‚é–“ã€‚");
                    return "ä½ åœ¨è¿·å®®ä¸­è¿·è·¯äº†ï¼Œæµªè²»äº†ä¸€äº›æ™‚é–“ã€‚";
                }
            },
            
            // å¥½äº‹ä»¶
            {
                name: "ç¥æ˜ä¿ä½‘",
                icon: "ğŸ‘¼",
                desc: "ä½ æ„Ÿå—åˆ°äº†ç¥æ˜çš„ç¥ç¦ï¼Œç²å¾—äº†é‡‘å¹£å’Œç´ æã€‚",
                type: "good",
                effect: function() {
                    const gold = 200 + Math.floor(Math.random() * 300);
                    Player.gold += gold;
                    
                    // ç²å¾—éš¨æ©Ÿç¨€æœ‰ç´ æ
                    const rareMats = ["é¾é±—", "é³³å‡°ä¹‹ç¾½", "æ˜Ÿè¾°ç¢ç‰‡", "å¤©ä½¿ä¹‹ç¾½", "ç¥ä¹‹è¡€"];
                    const mat = rareMats[Math.floor(Math.random() * rareMats.length)];
                    Game.addMaterial(mat, 1 + Math.floor(Math.random() * 2));
                    
                    UI.log(`ç¥æ˜ä¿ä½‘ï¼Œç²å¾— ${gold} é‡‘å¹£å’Œ ${mat}ï¼`);
                    return `ç¥æ˜ä¿ä½‘ï¼Œç²å¾— ${gold} é‡‘å¹£å’Œ ${mat}ï¼`;
                }
            },
            {
                name: "ç™¼ç¾å¯¶è—",
                icon: "ğŸ’",
                desc: "ä½ åœ¨è·¯ä¸Šç™¼ç¾äº†ä¸€å€‹éš±è—çš„å¯¶è—ã€‚",
                type: "good",
                effect: function() {
                    const gold = 500 + Math.floor(Math.random() * 1000);
                    Player.gold += gold;
                    UI.log(`ç™¼ç¾å¯¶è—ï¼Œç²å¾— ${gold} é‡‘å¹£ï¼`);
                    return `ç™¼ç¾å¯¶è—ï¼Œç²å¾— ${gold} é‡‘å¹£ï¼`;
                }
            },
            {
                name: "ç¥ç§˜å•†äºº",
                icon: "ğŸ›’",
                desc: "ä½ é‡åˆ°äº†ä¸€ä½ç¥ç§˜å•†äººï¼Œä»–ä½åƒ¹è³£çµ¦ä½ ä¸€äº›å¥½æ±è¥¿ã€‚",
                type: "good",
                effect: function() {
                    const items = ["ä¸­å‹ç´…è—¥æ°´", "ä¸­å‹è—è—¥æ°´", "å¼·åŒ–å¯¶çŸ³", "é­”æ³•çµæ™¶"];
                    const item = items[Math.floor(Math.random() * items.length)];
                    const amount = 3 + Math.floor(Math.random() * 5);
                    
                    if (DB.items[item].type === "material") {
                        Game.addMaterial(item, amount);
                    } else {
                        for (let i = 0; i < amount; i++) {
                            Game.addItem(item);
                        }
                    }
                    
                    UI.log(`ç¥ç§˜å•†äººè³£çµ¦ä½  ${item} x${amount}ï¼`);
                    return `ç¥ç§˜å•†äººè³£çµ¦ä½  ${item} x${amount}ï¼`;
                }
            },
            
            // ä¸­æ€§äº‹ä»¶
            {
                name: "ä¼‘æ¯é»",
                icon: "ğŸŒ¿",
                desc: "ä½ ç™¼ç¾äº†ä¸€å€‹å®‰å…¨çš„ä¼‘æ¯é»ï¼Œæ¢å¾©äº†ä¸€äº›ç”Ÿå‘½å€¼ã€‚",
                type: "neutral",
                effect: function() {
                    const heal = Math.floor(Player.maxHp * 0.3);
                    Player.hp = Math.min(Player.maxHp, Player.hp + heal);
                    UI.log(`åœ¨ä¼‘æ¯é»æ¢å¾©äº† ${heal} HPï¼`);
                    return `åœ¨ä¼‘æ¯é»æ¢å¾©äº† ${heal} HPï¼`;
                }
            },
            {
                name: "ç¥ç§˜æ³‰æ°´",
                icon: "ğŸ’§",
                desc: "ä½ ç™¼ç¾äº†ä¸€è™•ç¥ç§˜çš„æ³‰æ°´ï¼Œæ¢å¾©äº†ä¸€äº›é­”åŠ›å€¼ã€‚",
                type: "neutral",
                effect: function() {
                    const mana = Math.floor(Player.maxMp * 0.4);
                    Player.mp = Math.min(Player.maxMp, Player.mp + mana);
                    UI.log(`é£²ç”¨ç¥ç§˜æ³‰æ°´æ¢å¾©äº† ${mana} MPï¼`);
                    return `é£²ç”¨ç¥ç§˜æ³‰æ°´æ¢å¾©äº† ${mana} MPï¼`;
                }
            }
        ]
    };

    // ç©å®¶ç‹€æ…‹
    const Player = {
        hp: 100, maxHp: 100, mp: 100, maxMp: 100,
        atk: 10, crit: 5, def: 0, gold: 50,
        depth: 0, level: 1, exp: 0, maxExp: 100,
        bag: {}, // æ”¹ç‚ºç‰©ä»¶ä¾†å­˜å„²å †ç–Šç‰©å“
        weapon: null, armor: null, class: "",
        materials: {},
        baseMaxHp: 100,
        baseAtk: 10,
        baseDef: 0,
        equipmentHpBonus: 0,
        equipmentHpPercent: 0,
        equipmentAtkPercent: 0,
        equipmentDefBonus: 0,
        // æ–°å¢ç‹€æ…‹æ•ˆæœ
        buffs: [],
        debuffs: []
    };

    // éŠæˆ²ä¸»é‚è¼¯
    const Game = {
        state: "idle",
        enemy: null,
        bossCount: 0,
        currentPage: "adventure",
        chestActive: false,
        eventActive: false,
        isExploring: false, // æ–°å¢ï¼šæ¨™è¨˜æ˜¯å¦æ­£åœ¨æ¢ç´¢

        init(clsId) {
            // è·æ¥­åˆå§‹åŒ–
            if(clsId === 'knight'){ 
                Player.class = "é¨å£«"; 
                Player.maxHp = 180; Player.hp = 180; 
                Player.baseMaxHp = 180;
                Player.atk = 12; Player.def = 2; // é¨å£«é˜²ç¦¦2
                Player.baseAtk = 12;
                Player.baseDef = 2;
                Player.maxMp = 80; Player.mp = 80; 
                Player.crit = 5; // é¨å£«åŸºç¤æš´æ“Š5%
            }
            else if(clsId === 'thief'){ 
                Player.class = "ç›œè³Š"; 
                Player.maxHp = 110; Player.hp = 110;
                Player.baseMaxHp = 110;
                Player.atk = 18; Player.crit = 15; 
                Player.def = 0; // ç›œè³Šç„¡é˜²ç¦¦
                Player.baseAtk = 18;
                Player.baseDef = 0;
                Player.maxMp = 100; Player.mp = 100; 
            }
            else if(clsId === 'mage'){ 
                Player.class = "æ³•å¸«"; 
                Player.maxHp = 90; Player.hp = 90;
                Player.baseMaxHp = 90;
                Player.atk = 10; 
                Player.def = 0; // æ³•å¸«ç„¡é˜²ç¦¦
                Player.baseAtk = 10;
                Player.baseDef = 0;
                Player.maxMp = 200; Player.mp = 200; 
                Player.crit = 5; // æ³•å¸«åŸºç¤æš´æ“Š5%
            }
            else if(clsId === 'ranger'){ 
                Player.class = "çµäºº"; 
                Player.maxHp = 130; Player.hp = 130;
                Player.baseMaxHp = 130;
                Player.atk = 16; Player.crit = 12; 
                Player.def = 0; // çµäººç„¡é˜²ç¦¦
                Player.baseAtk = 16;
                Player.baseDef = 0;
                Player.maxMp = 120; Player.mp = 120; 
            }
            else if(clsId === 'god'){ 
                Player.class = "ä¸Šå¸"; 
                Player.maxHp = 10000; Player.hp = 10000; 
                Player.baseMaxHp = 10000;
                Player.atk = 1000; 
                Player.baseAtk = 1000;
                Player.def = 100;
                Player.baseDef = 100;
                Player.crit = 50;
                Player.maxMp = 10000; Player.mp = 10000; 
                Player.gold = 999999;
                
                // æ·»åŠ æ‰€æœ‰è—¥æ°´å„999å€‹
                const potions = ["å°å‹ç´…è—¥æ°´", "ä¸­å‹ç´…è—¥æ°´", "å¤§å‹ç´…è—¥æ°´", "å°å‹è—è—¥æ°´", "ä¸­å‹è—è—¥æ°´", "å¤§å‹è—è—¥æ°´", "å…¨æ¢å¾©è—¥æ°´"];
                potions.forEach(potion => {
                    Game.addItem(potion, 999);
                });
                
                // æ·»åŠ æ‰€æœ‰ç´ æå„999å€‹
                const materials = ["æœ¨æ", "éµç¤¦çŸ³", "éŠ…ç¤¦çŸ³", "éŠ€ç¤¦çŸ³", "é‡‘ç¤¦çŸ³", "ç¸çš®", "å°–ç‰™", "çˆªå­", "ç¾½æ¯›", 
                                 "é­”æ³•çµæ™¶", "éˆé­‚ç¢ç‰‡", "ç«ç„°ä¹‹å¿ƒ", "å†°éœœæ ¸å¿ƒ", "é›·é›»ä¹‹æ ¸", "é¾é±—", "é³³å‡°ä¹‹ç¾½", 
                                 "æƒ¡é­”è§’", "å¤©ä½¿ä¹‹ç¾½", "æ˜Ÿè¾°ç¢ç‰‡", "ç¥ä¹‹è¡€", "å¼·åŒ–å¯¶çŸ³"];
                materials.forEach(mat => {
                    Game.addMaterial(mat, 999);
                });
                
                // æ·»åŠ æ‰€æœ‰è­·ç¬¦å„999å€‹
                const buffs = ["åŠ›é‡è­·ç¬¦", "é˜²ç¦¦è­·ç¬¦", "ç”Ÿå‘½è­·ç¬¦", "é­”åŠ›è­·ç¬¦", "æš´æ“Šå¯¶ç "];
                buffs.forEach(buff => {
                    Game.addItem(buff, 999);
                });
                
                // æ·»åŠ ä¸Šå¸å°ˆå±¬è£å‚™
                Game.addItem("ç¥æ€’ä¹‹åˆƒ", 1);
                Game.addItem("ä¸æœ½æˆ°ç”²", 1);
                
                // è‡ªå‹•è£å‚™æœ€å¥½çš„è£å‚™
                const godWeapon = Game.findItemInBag("ç¥æ€’ä¹‹åˆƒ");
                const godArmor = Game.findItemInBag("ä¸æœ½æˆ°ç”²");
                
                if (godWeapon) {
                    Player.weapon = godWeapon;
                    Player.equipmentAtkPercent = godWeapon.atkPercent || 0;
                    // å¾èƒŒåŒ…ç§»é™¤
                    Game.removeItemFromBag("ç¥æ€’ä¹‹åˆƒ", 1);
                }
                
                if (godArmor) {
                    Player.armor = godArmor;
                    if (godArmor.hp) Player.equipmentHpBonus += godArmor.hp;
                    if (godArmor.hpPercent) Player.equipmentHpPercent += godArmor.hpPercent;
                    if (godArmor.def) Player.equipmentDefBonus += godArmor.def;
                    // å¾èƒŒåŒ…ç§»é™¤
                    Game.removeItemFromBag("ä¸æœ½æˆ°ç”²", 1);
                }
                
                UI.log("âš¡ ä¸Šå¸æ¨¡å¼å·²æ¿€æ´»ï¼");
            }
            
            // é‡ç½®å…¶ä»–ç‹€æ…‹
            Player.depth = 0;
            Player.level = 1;
            Player.exp = 0;
            Player.maxExp = 100;
            if (clsId !== 'god') Player.gold = 50;
            if (clsId !== 'god') {
                Player.bag = {};
                Player.weapon = null;
                Player.armor = null;
                Player.materials = {};
                Player.equipmentHpBonus = 0;
                Player.equipmentHpPercent = 0;
                Player.equipmentAtkPercent = 0;
                Player.equipmentDefBonus = 0;
                Player.buffs = [];
                Player.debuffs = [];
                
                // çµ¦åˆå§‹ç‰©å“
                Game.addItem("å°å‹ç´…è—¥æ°´", 1);
                Game.addMaterial("å¼·åŒ–å¯¶çŸ³", 5);
            }
            
            Game.bossCount = 0;
            Game.currentPage = "adventure";
            isCombatAction = false;
            isOpeningChest = false;
            isProcessingEvent = false;
            Game.isExploring = false;
            currentBagCategory = 'all';
            currentShopCategory = 'potion';
            
            // æ›´æ–°ç©å®¶å±¬æ€§
            this.updatePlayerStats();
            
            document.getElementById('start-modal').style.display = 'none';
            this.next();
        },

        next() {
            this.state = "idle";
            isCombatAction = false;
            this.showPage("adventure");
            UI.renderStage("ğŸŒ²", "æ£®æ—å°å¾‘", "é¸æ“‡å†’éšªæˆ–é›é€ ...", false);
            UI.update();
            this.updateButtons();
        },

        showPage(page) {
            this.currentPage = page;
            document.getElementById('adventure-page').classList.remove('active');
            document.getElementById('shop-page').classList.remove('active');
            document.getElementById('forge-page').classList.remove('active');
            document.getElementById('upgrade-page').classList.remove('active');
            document.getElementById('chest-page').style.display = 'none';
            document.getElementById('event-page').style.display = 'none';
            
            if (page === 'chest') {
                document.getElementById('chest-page').style.display = 'block';
            } else if (page === 'event') {
                document.getElementById('event-page').style.display = 'block';
            } else {
                const pageElement = document.getElementById(page + '-page');
                if (pageElement) {
                    pageElement.classList.add('active');
                }
            }
            
            if (page === 'upgrade') {
                UI.renderUpgrade();
            }
            
            this.updateButtons();
        },

        updateButtons() {
            const inCombat = this.state === 'combat';
            const isAdventure = this.currentPage === 'adventure';
            
            document.getElementById('btn-explore').disabled = inCombat || !isAdventure;
            document.getElementById('btn-attack').disabled = !inCombat || !isAdventure;
            document.getElementById('btn-flee').disabled = !inCombat || !isAdventure;
            
            // æˆ°é¬¥ä¸­ç‰¹æ®Šè™•ç†å•†åº—ã€é›é€ å’Œé€²åŒ–æŒ‰éˆ•
            const shopBtn = document.getElementById('btn-shop');
            const craftBtn = document.getElementById('btn-craft');
            const upgradeBtn = document.getElementById('btn-upgrade');
            
            shopBtn.disabled = inCombat;
            craftBtn.disabled = inCombat;
            upgradeBtn.disabled = inCombat;
            
            if (inCombat) {
                shopBtn.classList.add('combat-disabled');
                craftBtn.classList.add('combat-disabled');
                upgradeBtn.classList.add('combat-disabled');
                document.getElementById('combat-warning').style.display = 'block';
            } else {
                shopBtn.classList.remove('combat-disabled');
                craftBtn.classList.remove('combat-disabled');
                upgradeBtn.classList.remove('combat-disabled');
                document.getElementById('combat-warning').style.display = 'none';
            }
            
            shopBtn.innerHTML = inCombat ? 'ğŸª å•†åº—<br><small style="font-size:0.6em">æˆ°é¬¥ä¸­</small>' : 'ğŸª å•†åº—';
            craftBtn.innerHTML = inCombat ? 'âš’ï¸ é›é€ <br><small style="font-size:0.6em">æˆ°é¬¥ä¸­</small>' : 'âš’ï¸ é›é€ ';
            upgradeBtn.innerHTML = inCombat ? 'ğŸ”§ é€²åŒ–<br><small style="font-size:0.6em">æˆ°é¬¥ä¸­</small>' : 'ğŸ”§ é€²åŒ–';
        },

        setDifficulty(difficulty) {
            gameDifficulty = difficulty;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('[id^="difficulty-"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`difficulty-${difficulty}`).classList.add('active');
            
            UI.log(`é›£åº¦è¨­å®šç‚ºï¼š${difficulty === 'easy' ? 'ç°¡å–®' : difficulty === 'normal' ? 'æ™®é€š' : 'å›°é›£'}`);
        },

        openShop() {
            if (this.state === 'combat') return;
            this.showPage("shop");
            UI.renderShop();
            UI.log("é€²å…¥äº†å•†åº—");
        },

        closeShop() {
            this.showPage("adventure");
        },

        openForge() {
            if (this.state === 'combat') return;
            this.showPage("forge");
            UI.renderRecipes();
            UI.log("é€²å…¥äº†é›é€ å ´");
        },

        closeForge() {
            this.showPage("adventure");
        },

        openUpgrade() {
            if (this.state === 'combat') return;
            this.showPage("upgrade");
            UI.log("é€²å…¥äº†é€²åŒ–å°");
        },

        closeUpgrade() {
            this.showPage("adventure");
        },

        explore() {
            if (this.currentPage !== 'adventure' || this.isExploring) return;
            
            this.isExploring = true;
            UI.log(`é–‹å§‹æ¢ç´¢...`);
            
            // éš¨æ©Ÿäº‹ä»¶è§¸ç™¼ï¼ˆæ ¹æ“šé›£åº¦ï¼‰
            const eventChance = DIFFICULTY_MODIFIERS[gameDifficulty].eventChance;
            if (Math.random() < eventChance && Player.depth > 3) {
                this.triggerRandomEvent();
                return;
            }
            
            // éš¨æ©Ÿé‡åˆ°å¯¶ç®±
            const chestChance = DIFFICULTY_MODIFIERS[gameDifficulty].chestChance;
            if (Math.random() < chestChance && Player.depth > 5) {
                this.triggerChest();
                return;
            }
            
            if (Player.depth > 0 && Player.depth % 100 === 0) {
                this.triggerBoss();
            } else {
                this.triggerCombat();
            }
        },

        triggerCombat() {
            this.state = "combat";
            this.isExploring = false;
            Player.depth++; // åªæœ‰é€²å…¥æˆ°é¬¥æ™‚æ‰å¢åŠ å±¤æ•¸
            const lvl = Math.max(0, Math.floor((Player.depth - 1) / 5));
            const idx = Math.min(DB.monsters.length - 1, lvl);
            const m = DB.monsters[idx];
            const growth = 1 + (Player.depth * DIFFICULTY_MODIFIERS[gameDifficulty].monsterGrowth);
            this.enemy = { 
                ...m, 
                hp: Math.floor(m.hp * growth), 
                maxHp: Math.floor(m.hp * growth),
                atk: Math.floor(m.atk * growth)
            };
            UI.renderStage(this.enemy.icon, this.enemy.name, "æº–å‚™æˆ°é¬¥ï¼", true);
            this.updateButtons();
            UI.update();
        },

        triggerBoss() {
            this.state = "combat";
            this.isExploring = false;
            Player.depth++; // åªæœ‰é€²å…¥æˆ°é¬¥æ™‚æ‰å¢åŠ å±¤æ•¸
            this.bossCount++;
            const boss = DB.bosses[(this.bossCount - 1) % DB.bosses.length];
            const growth = 1 + (Player.depth * DIFFICULTY_MODIFIERS[gameDifficulty].monsterGrowth * 1.5);
            this.enemy = {
                ...boss,
                hp: Math.floor(boss.hp * growth),
                maxHp: Math.floor(boss.hp * growth),
                atk: Math.floor(boss.atk * growth),
                isBoss: true
            };
            document.getElementById('boss-warning').style.display = 'block';
            document.getElementById('boss-number').innerText = this.bossCount;
            UI.renderStage(this.enemy.icon, `${this.enemy.name} (BOSS)`, "å¼·å¤§çš„æ•µäººå‡ºç¾ï¼", true);
            this.updateButtons();
            UI.update();
        },

        triggerChest() {
            this.state = "idle";
            this.isExploring = false;
            this.chestActive = true;
            isOpeningChest = false; // é‡ç½®å¯¶ç®±é–‹å•Ÿç‹€æ…‹
            document.getElementById('chest-icon').innerText = "ğŸ";
            document.getElementById('chest-message').innerText = "ä½ ç™¼ç¾äº†ä¸€å€‹ç¥ç§˜å¯¶ç®±ï¼è¦æ‰“é–‹å®ƒå—ï¼Ÿ";
            document.getElementById('chest-message').style.color = "";
            
            // å•Ÿç”¨æŒ‰éˆ•
            const buttons = document.querySelectorAll('#chest-content button');
            buttons.forEach(btn => btn.disabled = false);
            
            this.showPage("chest");
            UI.log("ç™¼ç¾äº†ä¸€å€‹ç¥ç§˜å¯¶ç®±ï¼");
        },

        triggerRandomEvent() {
            this.state = "idle";
            this.isExploring = false;
            this.eventActive = true;
            isProcessingEvent = false; // é‡ç½®äº‹ä»¶è™•ç†ç‹€æ…‹
            
            const events = DB.randomEvents;
            const event = events[Math.floor(Math.random() * events.length)];
            
            document.getElementById('event-icon').innerText = event.icon;
            document.getElementById('event-name').innerText = event.name;
            document.getElementById('event-desc').innerText = event.desc;
            document.getElementById('event-result').innerHTML = "";
            
            // å•Ÿç”¨æŒ‰éˆ•
            const buttons = document.querySelectorAll('#event-content button');
            buttons.forEach(btn => btn.disabled = false);
            
            this.showPage("event");
            UI.log(`é‡åˆ°äº†éš¨æ©Ÿäº‹ä»¶ï¼š${event.name}`);
        },

        // ä¿®æ”¹æ·»åŠ ç‰©å“å‡½æ•¸ä»¥æ”¯æŒå †ç–Š
        addItem(name, count = 1) {
            if (!Player.bag[name]) {
                Player.bag[name] = {
                    ...DB.items[name],
                    count: 0,
                    enhanceLevel: 0
                };
            }
            
            Player.bag[name].count += count;
            
            if (count === 1) {
                UI.log(`ç²å¾—: ${name}`);
            } else {
                UI.log(`ç²å¾—: ${name} x${count}`);
            }
            UI.update();
        },

        // å¾èƒŒåŒ…ç§»é™¤ç‰©å“
        removeItemFromBag(name, count = 1) {
            if (Player.bag[name] && Player.bag[name].count >= count) {
                Player.bag[name].count -= count;
                if (Player.bag[name].count <= 0) {
                    delete Player.bag[name];
                }
                return true;
            }
            return false;
        },

        // æŸ¥æ‰¾èƒŒåŒ…ä¸­çš„ç‰©å“
        findItemInBag(name) {
            return Player.bag[name] ? {...Player.bag[name], name: name} : null;
        },

        addMaterial(name, amount = 1) {
            if (!Player.materials[name]) {
                Player.materials[name] = 0;
            }
            Player.materials[name] += amount;
            UI.log(`ç²å¾—ç´ æ: ${name} x${amount}`);
            UI.update();
        },

        removeMaterial(name, amount = 1) {
            if (Player.materials[name] && Player.materials[name] >= amount) {
                Player.materials[name] -= amount;
                if (Player.materials[name] <= 0) {
                    delete Player.materials[name];
                }
                return true;
            }
            return false;
        },

        getMaterialCount(name) {
            return Player.materials[name] || 0;
        },

        buyItem(name) {
            const item = DB.items[name];
            if (Player.gold >= item.price) {
                Player.gold -= item.price;
                if (item.category === 'material') {
                    this.addMaterial(name);
                } else {
                    this.addItem(name);
                }
                UI.log(`è³¼è²·äº† ${name}`);
            } else {
                UI.log("é‡‘å¹£ä¸è¶³ï¼");
            }
        },

        craftItem(recipeId) {
            const recipe = DB.recipes.find(r => r.id === recipeId);
            if (!recipe) return false;
            
            // æª¢æŸ¥ææ–™æ˜¯å¦è¶³å¤ 
            for (const mat of recipe.materials) {
                if (mat.name === "éŠ€è£½é•·åŠ" || mat.name === "é‹¼éµé•·åŠ") {
                    // æª¢æŸ¥æ˜¯å¦æœ‰é€™å€‹æ­¦å™¨
                    const weapon = this.findItemInBag(mat.name);
                    if (!weapon || weapon.count < mat.amount) {
                        UI.log(`ç´ æä¸è¶³ï¼éœ€è¦ ${mat.name} x${mat.amount}`);
                        return false;
                    }
                } else if (this.getMaterialCount(mat.name) < mat.amount) {
                    UI.log(`ç´ æä¸è¶³ï¼éœ€è¦ ${mat.name} x${mat.amount}`);
                    return false;
                }
            }
            
            // æ‰£é™¤ææ–™
            for (const mat of recipe.materials) {
                if (mat.name === "éŠ€è£½é•·åŠ" || mat.name === "é‹¼éµé•·åŠ") {
                    // å¾èƒŒåŒ…ä¸­ç§»é™¤æ­¦å™¨
                    this.removeItemFromBag(mat.name, mat.amount);
                } else {
                    this.removeMaterial(mat.name, mat.amount);
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºè­·ç¬¦ï¼ˆbuffé¡ï¼‰
            if (recipe.result in DB.items && DB.items[recipe.result].type === "buff") {
                this.addItem(recipe.result, 1);
            } else if (recipe.result in DB.items) {
                this.addItem(recipe.result, 1);
            } else {
                // é€™æ˜¯ç‰¹æ®Šè£å‚™ï¼Œç›´æ¥æ·»åŠ åˆ°èƒŒåŒ…
                const specialItem = {
                    name: recipe.result,
                    type: recipe.type || "armor",
                    category: recipe.type || "armor",
                    icon: recipe.icon,
                    r: recipe.r || "rare",
                    desc: recipe.desc,
                    hp: recipe.hp || 0,
                    hpPercent: recipe.hpPercent || 0,
                    def: recipe.def || 0,
                    atk: recipe.atk || 0,
                    atkPercent: recipe.atkPercent || 0,
                    isSpecial: true,
                    enhanceLevel: 0
                };
                this.addItem(recipe.result, 1);
            }
            
            UI.log(`æˆåŠŸé›é€ äº† ${recipe.name}ï¼`);
            UI.renderRecipes();
            return true;
        },

        enhanceItem(itemName) {
            const item = Player.bag[itemName];
            if (!item || (item.type !== 'weapon' && item.type !== 'armor')) {
                UI.log("ç„¡æ³•å¼·åŒ–æ­¤ç‰©å“");
                return false;
            }
            
            // æª¢æŸ¥å¼·åŒ–ç­‰ç´šä¸Šé™
            if (item.enhanceLevel >= 9) {
                UI.log("æ­¤ç‰©å“å·²é”åˆ°æœ€å¤§å¼·åŒ–ç­‰ç´š");
                return false;
            }
            
            const rules = DB.enhancementRules[item.type];
            const cost = rules.costMultiplier * (item.enhanceLevel + 1);
            const materialNeeded = rules.materialCost;
            const successRate = rules.successRate[item.enhanceLevel];
            
            // æª¢æŸ¥è³‡æº
            if (Player.gold < cost) {
                UI.log(`é‡‘å¹£ä¸è¶³ï¼éœ€è¦ ${cost} G`);
                return false;
            }
            
            if (this.getMaterialCount("å¼·åŒ–å¯¶çŸ³") < materialNeeded) {
                UI.log(`å¼·åŒ–å¯¶çŸ³ä¸è¶³ï¼éœ€è¦ ${materialNeeded} å€‹`);
                return false;
            }
            
            // æ‰£é™¤è³‡æº
            Player.gold -= cost;
            this.removeMaterial("å¼·åŒ–å¯¶çŸ³", materialNeeded);
            
            // è¨ˆç®—æˆåŠŸç‡
            const success = Math.random() * 100 < successRate;
            
            if (success) {
                // å¼·åŒ–æˆåŠŸ
                item.enhanceLevel++;
                
                // å¢åŠ å±¬æ€§
                if (item.type === 'weapon') {
                    // ä¿å­˜åŸå§‹åŸºç¤å€¼ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¼·åŒ–ï¼‰
                    if (!item.baseAtk) item.baseAtk = item.atk || 0;
                    if (!item.baseAtkPercent) item.baseAtkPercent = item.atkPercent || 0;
                    
                    // è¨ˆç®—å¼·åŒ–å¾Œçš„å±¬æ€§
                    item.atk = (item.baseAtk || 0) + (rules.atk * item.enhanceLevel);
                    item.atkPercent = (item.baseAtkPercent || 0) + (rules.atkPercent * item.enhanceLevel);
                } else if (item.type === 'armor') {
                    // ä¿å­˜åŸå§‹åŸºç¤å€¼
                    if (!item.baseHp) item.baseHp = item.hp || 0;
                    if (!item.baseDef) item.baseDef = item.def || 0;
                    if (!item.baseHpPercent) item.baseHpPercent = item.hpPercent || 0;
                    
                    // è¨ˆç®—å¼·åŒ–å¾Œçš„å±¬æ€§
                    item.hp = (item.baseHp || 0) + (rules.hp * item.enhanceLevel);
                    item.def = (item.baseDef || 0) + (rules.def * item.enhanceLevel);
                    item.hpPercent = (item.baseHpPercent || 0) + (rules.hpPercent * item.enhanceLevel);
                }
                
                UI.log(`${itemName} å¼·åŒ–æˆåŠŸï¼ç¾åœ¨æ˜¯ +${item.enhanceLevel}`);
                
                // æ›´æ–°è£å‚™ä¸­çš„ç‰©å“
                if (Player.weapon && Player.weapon.name === itemName) {
                    Player.weapon = {...item};
                    Player.weapon.name = itemName;
                    this.updatePlayerStats();
                }
                if (Player.armor && Player.armor.name === itemName) {
                    Player.armor = {...item};
                    Player.armor.name = itemName;
                    this.updatePlayerStats();
                }
                
                // é¡¯ç¤ºç‰¹æ•ˆ
                const itemSlot = document.querySelector(`.item-slot[data-name="${itemName}"]`);
                if (itemSlot) {
                    itemSlot.classList.add('enhance-success');
                    setTimeout(() => itemSlot.classList.remove('enhance-success'), 1000);
                }
            } else {
                UI.log(`${itemName} å¼·åŒ–å¤±æ•—ï¼`);
            }
            
            UI.renderUpgrade();
            UI.update();
            return success;
        },

        gainExp(amount) {
            const modifiedAmount = Math.floor(amount * DIFFICULTY_MODIFIERS[gameDifficulty].expMultiplier);
            Player.exp += modifiedAmount;
            UI.log(`+${modifiedAmount} EXP`);
            while (Player.exp >= Player.maxExp) {
                Player.exp -= Player.maxExp;
                Player.level++;
                Player.maxExp = Math.floor(Player.maxExp * 1.5);
                
                // è·æ¥­æˆé•·
                if(Player.class === "é¨å£«") { 
                    Player.baseMaxHp += 25; 
                    Player.baseAtk += 4; 
                    Player.baseDef += 1; // é¨å£«æ¯æ¬¡å‡ç´šå¢åŠ 1é»åŸºç¤é˜²ç¦¦
                    // ç§»é™¤æš´æ“Šæˆé•·
                }
                else if(Player.class === "ç›œè³Š") { 
                    Player.baseMaxHp += 15; 
                    Player.baseAtk += 6; 
                    // ç§»é™¤æš´æ“Šæˆé•·ï¼Œæ”¹ç‚ºåŸºç¤5%
                    Player.baseDef += 0.2; // ç›œè³Šå¢åŠ å°‘é‡é˜²ç¦¦
                }
                else if(Player.class === "æ³•å¸«") { 
                    Player.baseMaxHp += 10; 
                    Player.maxMp += 40; 
                    Player.baseAtk += 4; 
                    // ç§»é™¤æš´æ“Šæˆé•·
                    Player.baseDef += 0.1; // æ³•å¸«å¢åŠ æ¥µå°‘é‡é˜²ç¦¦
                }
                else if(Player.class === "çµäºº") { 
                    Player.baseMaxHp += 18; 
                    Player.baseAtk += 5; 
                    // ç§»é™¤æš´æ“Šæˆé•·ï¼Œæ”¹ç‚ºåŸºç¤5%
                    Player.baseDef += 0.5; // çµäººå¢åŠ ä¸­ç­‰é˜²ç¦¦
                }
                else if(Player.class === "ä¸Šå¸") { 
                    Player.baseMaxHp += 1000; 
                    Player.baseAtk += 100; 
                    // ç§»é™¤æš´æ“Šæˆé•·
                    Player.baseDef += 5;
                    Player.maxMp += 1000;
                }
                
                // é‡æ–°è¨ˆç®—æœ€å¤§ç”Ÿå‘½å€¼ï¼ˆåŒ…æ‹¬è£å‚™åŠ æˆï¼‰
                this.updatePlayerStats();
                Player.hp = Player.maxHp;
                Player.mp = Player.maxMp;
                UI.log(`â­ å‡ç´šåˆ° Lv.${Player.level}ï¼`);
            }
            UI.update();
        },
        
        // æ›´æ–°ç©å®¶çš„å±¬æ€§ï¼ˆè€ƒæ…®åŸºç¤å€¼ã€è£å‚™å›ºå®šåŠ æˆå’Œç™¾åˆ†æ¯”åŠ æˆï¼‰
        updatePlayerStats() {
            // è¨ˆç®—ç”Ÿå‘½å€¼
            const baseHp = Player.baseMaxHp;
            const fixedHpBonus = Player.equipmentHpBonus;
            const percentHpBonus = Player.equipmentHpPercent / 100;
            Player.maxHp = Math.floor(baseHp * (1 + percentHpBonus)) + fixedHpBonus;
            
            // è¨ˆç®—æ”»æ“ŠåŠ›
            const baseAtk = Player.baseAtk;
            const fixedAtkBonus = Player.weapon ? Player.weapon.atk : 0;
            const percentAtkBonus = Player.equipmentAtkPercent / 100;
            Player.atk = Math.floor(baseAtk * (1 + percentAtkBonus)) + fixedAtkBonus;
            
            // è¨ˆç®—é˜²ç¦¦åŠ›
            const baseDef = Player.baseDef;
            const fixedDefBonus = Player.equipmentDefBonus;
            Player.def = baseDef + fixedDefBonus;
            
            // ç¢ºä¿ç•¶å‰HPä¸è¶…éæœ€å¤§HP
            if (Player.hp > Player.maxHp) {
                Player.hp = Player.maxHp;
            }
            
            // ç¢ºä¿ç•¶å‰MPä¸è¶…éæœ€å¤§MP
            if (Player.mp > Player.maxMp) {
                Player.mp = Player.maxMp;
            }
            
            UI.update();
        },

        rest() {
            if (this.state !== 'idle' || this.currentPage !== 'adventure') return;
            Player.hp = Player.maxHp;
            Player.mp = Player.maxMp;
            UI.log("åœ¨æ­¤ä¼‘æ¯,æ¢å¾©äº†ç²¾åŠ›");
            this.next();
        },
        
        showDeathScreen() {
            document.getElementById('dead-depth').innerText = Player.depth;
            document.getElementById('dead-bosses').innerText = Game.bossCount;
            document.getElementById('dead-level').innerText = Player.level;
            document.getElementById('dead-modal').style.display = 'flex';
        },
        
        restart() {
            document.getElementById('dead-modal').style.display = 'none';
            document.getElementById('start-modal').style.display = 'flex';
        }
    };

    // å¯¶ç®±ç³»çµ±
    const Chest = {
        open() {
            if (isOpeningChest) return; // é˜²æ­¢é‡è¤‡é–‹å•Ÿ
            isOpeningChest = true;
            
            // ç¦ç”¨æŒ‰éˆ•
            const buttons = document.querySelectorAll('#chest-content button');
            buttons.forEach(btn => btn.disabled = true);
            
            const chestIcon = document.getElementById('chest-icon');
            const chestMessage = document.getElementById('chest-message');
            
            // æ’­æ”¾é–‹ç®±å‹•ç•«
            chestIcon.classList.add('chest-opening');
            
            setTimeout(() => {
                chestIcon.classList.remove('chest-opening');
                
                // 50% å¥½å¯¶ç®±, 50% å£å¯¶ç®±
                const isGood = Math.random() < 0.5;
                
                if (isGood) {
                    // å¥½å¯¶ç®±
                    const rewards = DB.chestRewards.good;
                    const reward = rewards[Math.floor(Math.random() * rewards.length)];
                    chestIcon.innerText = reward.icon;
                    
                    this.applyGoodReward(reward);
                    
                    chestMessage.innerHTML = `<span class="chest-result-good">${reward.message}</span>`;
                } else {
                    // å£å¯¶ç®±
                    const punishments = DB.chestRewards.bad;
                    const punishment = punishments[Math.floor(Math.random() * punishments.length)];
                    chestIcon.innerText = punishment.icon;
                    
                    this.applyBadReward(punishment);
                    
                    chestMessage.innerHTML = `<span class="chest-result-bad">${punishment.message}</span>`;
                }
                
                // 3ç§’å¾Œè¿”å›å†’éšª
                setTimeout(() => {
                    Game.chestActive = false;
                    isOpeningChest = false;
                    Game.next();
                }, 3000);
            }, 500);
        },
        
        applyGoodReward(reward) {
            switch(reward.type) {
                case "gold":
                    const goldAmount = Math.floor(reward.amount * DIFFICULTY_MODIFIERS[gameDifficulty].goldMultiplier);
                    Player.gold += goldAmount;
                    UI.log(`å¾å¯¶ç®±ç²å¾— ${goldAmount} é‡‘å¹£ï¼`);
                    break;
                case "exp":
                    Player.exp += reward.amount;
                    UI.log(`å¾å¯¶ç®±ç²å¾— ${reward.amount} ç¶“é©—å€¼ï¼`);
                    Game.gainExp(0); // è§¸ç™¼å‡ç´šæª¢æŸ¥
                    break;
                case "item":
                    Game.addItem(reward.item, 1);
                    break;
                case "material":
                    Game.addMaterial(reward.item, reward.amount);
                    break;
                case "buff":
                    if (reward.stat === "atk") {
                        Player.baseAtk += reward.val;
                        Player.equipmentAtkPercent = 0;
                        if (Player.weapon && Player.weapon.atkPercent) {
                            Player.equipmentAtkPercent = Player.weapon.atkPercent;
                        }
                    } else if (reward.stat === "maxHp") {
                        Player.baseMaxHp += reward.val;
                        Game.updatePlayerStats();
                        Player.hp += reward.val;
                    } else if (reward.stat === "def") {
                        Player.baseDef += reward.val;
                        Game.updatePlayerStats();
                    }
                    Game.updatePlayerStats();
                    break;
            }
            UI.update();
        },
        
        applyBadReward(punishment) {
            switch(punishment.type) {
                case "damage":
                    Player.hp -= punishment.amount;
                    if (Player.hp <= 0) {
                        Game.showDeathScreen();
                    }
                    UI.log(`å¯¶ç®±é€ æˆ ${punishment.amount} é»å‚·å®³ï¼`);
                    break;
                case "curse":
                    if (punishment.stat === "atk") {
                        Player.baseAtk += punishment.val;
                        Player.equipmentAtkPercent = 0;
                        if (Player.weapon && Player.weapon.atkPercent) {
                            Player.equipmentAtkPercent = Player.weapon.atkPercent;
                        }
                    } else if (punishment.stat === "def") {
                        Player.baseDef += punishment.val;
                        Game.updatePlayerStats();
                    }
                    Game.updatePlayerStats();
                    break;
                case "trap":
                    Player.hp -= punishment.damage;
                    if (Player.hp <= 0) {
                        Game.showDeathScreen();
                    }
                    UI.log(`é™·é˜±é€ æˆ ${punishment.damage} é»å‚·å®³ï¼`);
                    break;
                case "goldLoss":
                    Player.gold = Math.max(0, Player.gold - punishment.amount);
                    UI.log(`æå¤±äº† ${punishment.amount} é‡‘å¹£ï¼`);
                    break;
                case "poison":
                    // ç°¡å–®å¯¦ç¾ä¸­æ¯’æ•ˆæœ
                    Player.hp -= punishment.damage;
                    if (Player.hp <= 0) {
                        Game.showDeathScreen();
                    }
                    UI.log(`ä¸­æ¯’ï¼å—åˆ° ${punishment.damage} é»å‚·å®³ï¼`);
                    break;
                case "confusion":
                    UI.log("é™·å…¥æ··äº‚ç‹€æ…‹ï¼");
                    break;
            }
            UI.update();
        },
        
        skip() {
            if (isOpeningChest) return;
            Game.chestActive = false;
            isOpeningChest = false;
            Game.next();
            UI.log("ä½ é¸æ“‡äº†å¿½ç•¥å¯¶ç®±");
        }
    };

    // éš¨æ©Ÿäº‹ä»¶ç³»çµ±
    const RandomEvent = {
        process() {
            if (isProcessingEvent) return; // é˜²æ­¢é‡è¤‡è™•ç†
            isProcessingEvent = true;
            
            // ç¦ç”¨æŒ‰éˆ•
            const buttons = document.querySelectorAll('#event-content button');
            buttons.forEach(btn => btn.disabled = true);
            
            const eventName = document.getElementById('event-name').innerText;
            const events = DB.randomEvents;
            const event = events.find(e => e.name === eventName);
            
            if (!event) {
                this.skip();
                return;
            }
            
            // åŸ·è¡Œäº‹ä»¶æ•ˆæœ
            const result = event.effect();
            const resultElement = document.getElementById('event-result');
            
            // æ ¹æ“šäº‹ä»¶é¡å‹è¨­ç½®é¡è‰²
            let resultClass = "";
            if (event.type === "good") {
                resultClass = "event-result-good";
            } else if (event.type === "bad") {
                resultClass = "event-result-bad";
            } else {
                resultClass = "event-result-neutral";
            }
            
            resultElement.innerHTML = `<div class="event-reward ${resultClass}">${result}</div>`;
            UI.update();
            
            // 3ç§’å¾Œè¿”å›å†’éšª
            setTimeout(() => {
                Game.eventActive = false;
                isProcessingEvent = false;
                Game.next();
            }, 3000);
        },
        
        skip() {
            if (isProcessingEvent) return;
            Game.eventActive = false;
            isProcessingEvent = false;
            Game.next();
            UI.log("ä½ é¸æ“‡äº†è·³éäº‹ä»¶");
        }
    };

    // æˆ°é¬¥ç³»çµ±
    const Combat = {
        playerAttack() {
            if (Game.state !== 'combat' || isCombatAction || Game.currentPage !== 'adventure') return;
            
            isCombatAction = true;
            const base = Player.atk * DIFFICULTY_MODIFIERS[gameDifficulty].playerDamageMultiplier;
            const isCrit = Math.random() * 100 < Player.crit;
            const dmg = Math.floor(isCrit ? base * 2 : base);
            this.dealDamage(dmg, isCrit);
            
            setTimeout(() => {
                if (Game.state === 'combat' && Game.enemy && Game.enemy.hp > 0) {
                    isCombatAction = false;
                }
            }, 800);
        },

        useSkill(id) {
            if ((Game.state !== 'combat' && id !== 2) || isCombatAction || Game.currentPage !== 'adventure') return;
            
            isCombatAction = true;
            const base = Player.atk * DIFFICULTY_MODIFIERS[gameDifficulty].playerDamageMultiplier;
            
            if (id === 1 && Player.mp >= 20) {
                Player.mp -= 20;
                const dmg = Math.floor(base * 2.2);
                this.dealDamage(dmg, true);
            } else if (id === 2 && Player.mp >= 30) {
                Player.mp -= 30;
                const heal = Math.floor(Player.maxHp * 0.5);
                Player.hp = Math.min(Player.maxHp, Player.hp + heal);
                UI.float(`+${heal}`, "var(--success)");
                UI.log(`ä½¿ç”¨æ²»ç™’è¡“æ¢å¾©äº† ${heal} HP`);
                
                if(Game.state === 'combat' && Game.enemy && Game.enemy.hp > 0) {
                    setTimeout(() => {
                        this.enemyTurn();
                        isCombatAction = false;
                    }, 800);
                } else {
                    isCombatAction = false;
                }
                UI.update();
                return;
            } else if (id === 3 && Player.mp >= 60) {
                Player.mp -= 60;
                const dmg = Math.floor(base * 4.5);
                this.dealDamage(dmg, true);
            } else {
                isCombatAction = false;
                UI.log("é­”åŠ›ä¸è¶³ï¼");
                return;
            }
            
            setTimeout(() => {
                if (Game.state === 'combat' && Game.enemy && Game.enemy.hp > 0) {
                    isCombatAction = false;
                }
            }, 800);
        },

        dealDamage(dmg, isCrit) {
            Game.enemy.hp -= dmg;
            
            // åœ¨äº‹ä»¶æè¿°å€åŸŸé¡¯ç¤ºç©å®¶æ”»æ“Šå‚·å®³
            const originalDesc = document.getElementById('event-desc').innerText;
            document.getElementById('event-desc').innerText = `ä½ å° ${Game.enemy.name} é€ æˆ ${dmg}${isCrit ? ' (æš´æ“Š)' : ''} å‚·å®³`;
            document.getElementById('event-desc').style.color = isCrit ? "#ffeb3b" : "#4caf50";
            
            UI.float(dmg + (isCrit ? "!" : ""), isCrit ? "#ffeb3b" : "white");
            UI.shake();
            UI.log(`ä½ å° ${Game.enemy.name} é€ æˆ ${dmg}${isCrit ? ' (æš´æ“Š)' : ''} å‚·å®³`);
            
            if (Game.enemy.hp <= 0) {
                this.win();
                // æˆ°é¬¥å‹åˆ©æ™‚æ‰è½ç´ æ
                if (Math.random() < 0.7) {
                    const commonMats = ["æœ¨æ", "éµç¤¦çŸ³", "ç¸çš®", "å°–ç‰™", "çˆªå­", "å¼·åŒ–å¯¶çŸ³"];
                    const randomMat = commonMats[Math.floor(Math.random() * commonMats.length)];
                    const amount = 1 + Math.floor(Math.random() * 3);
                    Game.addMaterial(randomMat, amount);
                }
                
                // BOSSæˆ°æœ‰æ©Ÿç‡æ‰è½ç¨€æœ‰ç´ æ
                if (Game.enemy.isBoss && Math.random() < 0.5) {
                    const rareMats = ["é¾é±—", "é³³å‡°ä¹‹ç¾½", "æƒ¡é­”è§’", "å¤©ä½¿ä¹‹ç¾½", "æ˜Ÿè¾°ç¢ç‰‡", "ç¥ä¹‹è¡€"];
                    const randomMat = rareMats[Math.floor(Math.random() * rareMats.length)];
                    Game.addMaterial(randomMat, 1);
                    UI.log(`BOSSæ‰è½ç¨€æœ‰ç´ æï¼š${randomMat}ï¼`);
                }
            } else {
                setTimeout(() => {
                    // æ¢å¾©åŸä¾†çš„æè¿°
                    document.getElementById('event-desc').innerText = originalDesc;
                    document.getElementById('event-desc').style.color = "#888";
                    this.enemyTurn();
                }, 600);
            }
            UI.update();
        },

        enemyTurn() {
            if (Game.state !== 'combat') return;
            
            // æ€ªç‰©æ”»æ“ŠåŠ›è€ƒæ…®é›£åº¦ä¿‚æ•¸
            const enemyDamage = Game.enemy.atk * DIFFICULTY_MODIFIERS[gameDifficulty].monsterDamageMultiplier;
            // å‚·å®³è¨ˆç®—å…¬å¼ï¼šæ€ªç‰©æ”»æ“ŠåŠ› - ç©å®¶é˜²ç¦¦ï¼ˆé˜²ç¦¦ç›´æ¥æ¸›å‚·ï¼‰
            const finalDamage = Math.max(1, Math.floor(enemyDamage - Player.def));
            
            // åœ¨äº‹ä»¶æè¿°å€åŸŸé¡¯ç¤ºæ•µäººæ”»æ“Šå‚·å®³
            const originalDesc = document.getElementById('event-desc').innerText;
            document.getElementById('event-desc').innerText = `${Game.enemy.name} å°ä½ é€ æˆ ${finalDamage} å‚·å®³`;
            document.getElementById('event-desc').style.color = "#ff5252";
            
            Player.hp -= finalDamage;
            UI.float(`-${finalDamage}`, "var(--danger)");
            UI.shake(); // ç©å®¶å—åˆ°å‚·å®³æ™‚éœ‡å‹•
            UI.log(`${Game.enemy.name} å°ä½ é€ æˆ ${finalDamage} å‚·å®³ (åŸå§‹å‚·å®³: ${enemyDamage.toFixed(1)}, é˜²ç¦¦æ¸›å…: ${Player.def})`);
            
            if (Player.hp <= 0) {
                Game.showDeathScreen();
            } else {
                // å»¶é²æ¢å¾©åŸä¾†çš„æè¿°
                setTimeout(() => {
                    document.getElementById('event-desc').innerText = originalDesc;
                    document.getElementById('event-desc').style.color = "#888";
                }, 1000);
            }
            isCombatAction = false;
            UI.update();
        },

        win() {
            const baseLoot = Math.floor(Game.enemy.maxHp / 5) + 5;
            const lootMultiplier = DIFFICULTY_MODIFIERS[gameDifficulty].goldMultiplier;
            const loot = Math.floor((Game.enemy.isBoss ? baseLoot * 10 : baseLoot) * lootMultiplier);
            const expGain = Math.floor((Game.enemy.isBoss ? Math.floor(Game.enemy.maxHp / 2) : Math.floor(Game.enemy.maxHp / 6) + 15) * DIFFICULTY_MODIFIERS[gameDifficulty].expMultiplier);
            Player.gold += loot;
            Game.gainExp(expGain);
            UI.log(`æ“Šæ•—äº† ${Game.enemy.name}ï¼ +${loot}G +${expGain}EXP`);
            
            // BOSSæˆ°æœ‰æ©Ÿç‡æ‰è½ç‰¹æ®Šè£å‚™
            if (Game.enemy.isBoss && Math.random() < 0.3) {
                const bossItems = ["ç«ç„°åŠ", "å†°éœœä¹‹åˆƒ", "è‹±é›„ä¹‹åˆƒ", "é¾é±—ç”²", "è–é¨å£«ç›”ç”²"];
                const randomItem = bossItems[Math.floor(Math.random() * bossItems.length)];
                Game.addItem(randomItem, 1);
            }
            
            Game.state = "idle";
            isCombatAction = false;
            UI.renderStage("ğŸ†", "æˆ°é¬¥å‹åˆ©", `ç²å¾— ${loot} é‡‘å¹£ & ${expGain} EXP`, false);
            
            // å»¶é²æ¸…ç©ºå‹åˆ©è¨Šæ¯
            setTimeout(() => {
                document.getElementById('event-desc').innerText = "";
            }, 2000);
            
            document.getElementById('boss-warning').style.display = 'none';
            Game.updateButtons();
            UI.update();
        },

        flee() {
            if (Game.state !== 'combat' || isCombatAction || Game.currentPage !== 'adventure') return;
            
            isCombatAction = true;
            const fleeChance = 0.7; // é€ƒè·‘æˆåŠŸç‡è¨­ç‚º70%
            
            if (Math.random() < fleeChance) {
                UI.log("é€ƒè·‘æˆåŠŸ");
                setTimeout(() => {
                    Game.next();
                    isCombatAction = false;
                }, 800);
            } else {
                UI.log("é€ƒè·‘å¤±æ•—ï¼");
                UI.shake(); // é€ƒè·‘å¤±æ•—æ™‚éœ‡å‹•è¢å¹•
                // é€ƒè·‘å¤±æ•—æœƒè¢«æ•µäººæ”»æ“Š
                setTimeout(() => {
                    // åœ¨äº‹ä»¶æè¿°å€åŸŸé¡¯ç¤ºé€ƒè·‘å¤±æ•—
                    const originalDesc = document.getElementById('event-desc').innerText;
                    document.getElementById('event-desc').innerText = "é€ƒè·‘å¤±æ•—ï¼";
                    document.getElementById('event-desc').style.color = "#ff9800";
                    
                    // å»¶é²ä¸€ä¸‹å†é¡¯ç¤ºå‚·å®³
                    setTimeout(() => {
                        // åœ¨äº‹ä»¶æè¿°å€åŸŸé¡¯ç¤ºæ•µäººæ”»æ“Šå‚·å®³
                        const enemyDamage = Game.enemy.atk * DIFFICULTY_MODIFIERS[gameDifficulty].monsterDamageMultiplier;
                        // å‚·å®³è¨ˆç®—å…¬å¼ï¼šæ€ªç‰©æ”»æ“ŠåŠ› - ç©å®¶é˜²ç¦¦ï¼ˆé˜²ç¦¦ç›´æ¥æ¸›å‚·ï¼‰
                        const finalDamage = Math.max(1, Math.floor(enemyDamage - Player.def));
                        
                        document.getElementById('event-desc').innerText = `${Game.enemy.name} è¶ä½ é€ƒè·‘æ™‚æ”»æ“Šï¼Œå°ä½ é€ æˆ ${finalDamage} å‚·å®³`;
                        document.getElementById('event-desc').style.color = "#ff5252";
                        
                        // ç›´æ¥åŸ·è¡Œæ•µäººæ”»æ“Šé‚è¼¯
                        Player.hp -= finalDamage;
                        UI.float(`-${finalDamage}`, "var(--danger)");
                        UI.shake(); // å—åˆ°å‚·å®³æ™‚éœ‡å‹•
                        UI.log(`${Game.enemy.name} è¶ä½ é€ƒè·‘æ™‚æ”»æ“Šï¼Œå°ä½ é€ æˆ ${finalDamage} å‚·å®³`);
                        
                        // æ¢å¾©åŸä¾†çš„æè¿°
                        setTimeout(() => {
                            document.getElementById('event-desc').innerText = originalDesc;
                            document.getElementById('event-desc').style.color = "#888";
                        }, 1000);
                        
                        if (Player.hp <= 0) {
                            Game.showDeathScreen();
                        } else {
                            isCombatAction = false;
                        }
                        UI.update();
                    }, 600);
                }, 800);
            }
        }
    };

    // UI ç³»çµ±
    const UI = {
        update() {
            document.getElementById('ui-level').innerText = Player.level;
            document.getElementById('ui-depth').innerText = Player.depth;
            document.getElementById('ui-gold').innerText = Player.gold.toLocaleString();
            document.getElementById('ui-class').innerText = Player.class;
            
            // è¨ˆç®—ç¸½æ”»æ“ŠåŠ›ï¼ˆåŸºç¤+æ­¦å™¨ï¼‰
            const totalAtk = Player.atk;
            document.getElementById('ui-atk').innerText = totalAtk.toLocaleString();
            
            // è¨ˆç®—ç¸½é˜²ç¦¦åŠ›ï¼ˆåŸºç¤+ç›”ç”²ï¼‰
            const totalDef = Player.def;
            document.getElementById('ui-def').innerText = totalDef.toLocaleString();
            
            document.getElementById('ui-crit').innerText = Player.crit.toFixed(1) + "%";
            
            // æ›´æ–°æ­¦å™¨é¡¯ç¤º
            let weaponName = Player.weapon ? Player.weapon.name : "- ç„¡ -";
            let weaponDesc = Player.weapon ? Player.weapon.desc : "ç„¡æ•ˆæœ";
            if (Player.weapon) {
                if (Player.weapon.enhanceLevel > 0) {
                    weaponName += ` +${Player.weapon.enhanceLevel}`;
                    weaponDesc += ` (å¼·åŒ–+${Player.weapon.enhanceLevel})`;
                }
                // é¡¯ç¤ºå¯¦éš›æ•¸å€¼
                const atkValue = Player.weapon.atk || 0;
                const atkPercentValue = Player.weapon.atkPercent || 0;
                if (atkPercentValue > 0) {
                    weaponDesc = `ATK +${atkValue} (${atkPercentValue}%åŠ æˆ)`;
                } else {
                    weaponDesc = `ATK +${atkValue}`;
                }
            }
            document.getElementById('ui-weapon').innerText = `æ­¦å™¨: ${weaponName}`;
            document.getElementById('weapon-desc').innerText = weaponDesc;
            
            // æ›´æ–°ç›”ç”²é¡¯ç¤º
            let armorName = Player.armor ? Player.armor.name : "- ç„¡ -";
            let armorDesc = Player.armor ? Player.armor.desc : "ç„¡æ•ˆæœ";
            if (Player.armor) {
                if (Player.armor.enhanceLevel > 0) {
                    armorName += ` +${Player.armor.enhanceLevel}`;
                    armorDesc += ` (å¼·åŒ–+${Player.armor.enhanceLevel})`;
                }
                // é¡¯ç¤ºå¯¦éš›æ•¸å€¼
                const hpValue = Player.armor.hp || 0;
                const defValue = Player.armor.def || 0;
                const hpPercentValue = Player.armor.hpPercent || 0;
                armorDesc = `HP +${hpValue}, DEF +${defValue}`;
                if (hpPercentValue > 0) {
                    armorDesc += `, HP +${hpPercentValue}%`;
                }
            }
            document.getElementById('ui-armor').innerText = `ç›”ç”²: ${armorName}`;
            document.getElementById('armor-desc').innerText = armorDesc;
            
            // é ­åƒæ›´æ–°
            if (Player.class === "é¨å£«") document.getElementById('ui-avatar').innerText = "âš”ï¸";
            else if (Player.class === "ç›œè³Š") document.getElementById('ui-avatar').innerText = "ğŸ—¡ï¸";
            else if (Player.class === "æ³•å¸«") document.getElementById('ui-avatar').innerText = "ğŸ§™";
            else if (Player.class === "çµäºº") document.getElementById('ui-avatar').innerText = "ğŸ¹";
            else if (Player.class === "ä¸Šå¸") document.getElementById('ui-avatar').innerText = "ğŸ‘‘";

            this.setBar('exp', Player.exp, Player.maxExp);
            this.setBar('hp', Player.hp, Player.maxHp);
            this.setBar('mp', Player.mp, Player.maxMp);
            
            if (Game.enemy && Game.state === 'combat' && Game.currentPage === 'adventure') {
                this.setBar('enemy-hp', Game.enemy.hp, Game.enemy.maxHp);
                document.getElementById('enemy-atk').innerText = Game.enemy.atk;
                document.getElementById('enemy-hp-text').innerText = `${Game.enemy.hp}/${Game.enemy.maxHp}`;
            }

            const inCombat = Game.state === 'combat' && Game.currentPage === 'adventure';
            const isAdventure = Game.currentPage === 'adventure';
            
            const canUseSkills = isAdventure && !isCombatAction;
            document.getElementById('skill-1').disabled = (Player.mp < 20) || !canUseSkills;
            document.getElementById('skill-2').disabled = (Player.mp < 30) || !canUseSkills;
            document.getElementById('skill-3').disabled = (Player.mp < 60) || !canUseSkills;

            const base = Player.atk;
            document.getElementById('sk1-val').innerText = `${Math.floor(base * 2.2).toLocaleString()} (20MP)`;
            document.getElementById('sk2-val').innerText = `+${Math.floor(Player.maxHp * 0.5).toLocaleString()} (30MP)`;
            document.getElementById('sk3-val').innerText = `${Math.floor(base * 4.5).toLocaleString()} (60MP)`;

            this.renderBag();
            if (Game.currentPage === 'shop') {
                this.renderShop();
            }
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            Game.updateButtons();
        },

        setBar(id, v, m) {
            const p = Math.max(0, (v / m) * 100);
            document.getElementById(`${id}-bar`).style.width = p + "%";
            if (document.getElementById(`${id}-text`)) {
                document.getElementById(`${id}-text`).innerText = `${Math.floor(Math.max(0,v)).toLocaleString()} / ${Math.floor(m).toLocaleString()}`;
            }
        },

        renderStage(ico, name, desc, showEnemy) {
            document.getElementById('enemy-sprite').innerText = ico;
            document.getElementById('event-name').innerText = name;
            document.getElementById('event-desc').innerText = desc;
            document.getElementById('enemy-panel').style.display = showEnemy ? "block" : "none";
        },

        renderBag() {
            const bagDiv = document.getElementById('bag-grid');
            if (!bagDiv) return;
            
            bagDiv.innerHTML = "";
            
            let itemsToShow = [];
            
            if (currentBagCategory === 'all') {
                // æ·»åŠ ç‰©å“
                Object.keys(Player.bag).forEach(name => {
                    const item = Player.bag[name];
                    if (item && item.count > 0) {
                        itemsToShow.push({ 
                            name, 
                            ...item,
                            isItem: true
                        });
                    }
                });
                // æ·»åŠ ææ–™
                Object.keys(Player.materials).forEach(name => {
                    const count = Player.materials[name];
                    const itemInfo = DB.items[name];
                    if (itemInfo && count > 0) {
                        itemsToShow.push({ 
                            name, 
                            ...itemInfo, 
                            isMaterial: true, 
                            count: count 
                        });
                    }
                });
            } else if (currentBagCategory === 'material') {
                Object.keys(Player.materials).forEach(name => {
                    const count = Player.materials[name];
                    const itemInfo = DB.items[name];
                    if (itemInfo && count > 0) {
                        itemsToShow.push({ 
                            name, 
                            ...itemInfo, 
                            isMaterial: true, 
                            count: count 
                        });
                    }
                });
            } else if (currentBagCategory === 'potion') {
                Object.keys(Player.bag).forEach(name => {
                    const item = Player.bag[name];
                    if (item && item.count > 0 && item.category === 'potion') {
                        itemsToShow.push({ 
                            name, 
                            ...item,
                            isItem: true
                        });
                    }
                });
            } else if (currentBagCategory === 'weapon') {
                Object.keys(Player.bag).forEach(name => {
                    const item = Player.bag[name];
                    if (item && item.count > 0 && item.category === 'weapon') {
                        itemsToShow.push({ 
                            name, 
                            ...item,
                            isItem: true
                        });
                    }
                });
            } else if (currentBagCategory === 'armor') {
                Object.keys(Player.bag).forEach(name => {
                    const item = Player.bag[name];
                    if (item && item.count > 0 && item.category === 'armor') {
                        itemsToShow.push({ 
                            name, 
                            ...item,
                            isItem: true
                        });
                    }
                });
            } else if (currentBagCategory === 'buff') {
                Object.keys(Player.bag).forEach(name => {
                    const item = Player.bag[name];
                    if (item && item.count > 0 && item.category === 'buff') {
                        itemsToShow.push({ 
                            name, 
                            ...item,
                            isItem: true
                        });
                    }
                });
            }
            
            if (itemsToShow.length === 0) {
                let emptyMessage = "èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ";
                if (currentBagCategory === 'potion') emptyMessage = "æ²’æœ‰è—¥æ°´";
                else if (currentBagCategory === 'weapon') emptyMessage = "æ²’æœ‰æ­¦å™¨";
                else if (currentBagCategory === 'armor') emptyMessage = "æ²’æœ‰ç›”ç”²";
                else if (currentBagCategory === 'material') emptyMessage = "æ²’æœ‰ç´ æ";
                else if (currentBagCategory === 'buff') emptyMessage = "æ²’æœ‰è­·ç¬¦";
                
                bagDiv.innerHTML = `<div style='grid-column:1/-1; text-align:center; color:#666; padding:10px; font-size:0.8em;'>${emptyMessage}</div>`;
                return;
            }
            
            itemsToShow.forEach((item) => {
                const slot = document.createElement('div');
                
                // æ ¹æ“šç‰©å“å“è³ªè¨­å®šé‚Šæ¡†é¡è‰²
                let rarityClass = 'r-common';
                if (item.r) {
                    rarityClass = `r-${item.r}`;
                } else if (item.isSpecial) {
                    rarityClass = 'r-mythic';
                }
                
                slot.className = `item-slot ${rarityClass} category-${item.category || 'material'}`;
                slot.setAttribute('data-name', item.name);
                
                // å¦‚æœæœ‰å¼·åŒ–ç­‰ç´šï¼Œæ·»åŠ å¼·åŒ–æ¨™è¨˜
                if (item.enhanceLevel > 0) {
                    slot.classList.add('enhanced');
                    slot.setAttribute('data-enhance', `+${item.enhanceLevel}`);
                }
                
                // æª¢æŸ¥æ˜¯å¦å·²è£å‚™
                const isEquipped = (Player.weapon && Player.weapon.name === item.name) || 
                                  (Player.armor && Player.armor.name === item.name);
                
                if (isEquipped) {
                    slot.classList.add('item-equipped');
                }
                
                // é¡¯ç¤ºåœ–æ¨™
                slot.innerHTML = `${item.icon}`;
                
                // é¡¯ç¤ºæ•¸é‡ï¼ˆå¦‚æœå¤§æ–¼1ï¼‰
                if ((item.count > 1 || item.isMaterial) && !isEquipped) {
                    const count = item.count || 1;
                    if (count > 1) {
                        const countBadge = document.createElement('div');
                        countBadge.className = 'item-count';
                        countBadge.innerText = count > 9 ? '9+' : (count > 999 ? '999+' : count);
                        slot.appendChild(countBadge);
                    }
                }
                
                // ç‚ºç´ ææ·»åŠ é»æ“Šäº‹ä»¶
                if (item.isMaterial) {
                    // ç´ æé»æ“Šï¼šé¡¯ç¤ºè©³ç´°ä¿¡æ¯
                    slot.onclick = () => {
                        this.openMaterialModal(item);
                    };
                } else {
                    // æ™®é€šç‰©å“é»æ“Š
                    slot.onclick = () => this.openItemModal(item);
                }
                
                bagDiv.appendChild(slot);
            });
        },
        
        // æ–°å¢ï¼šæ‰“é–‹ç´ æè©³ç´°ä¿¡æ¯
        openMaterialModal(item) {
            document.getElementById('m-icon').innerText = item.icon;
            document.getElementById('m-title').innerText = item.name;
            
            // é¡¯ç¤ºç¨€æœ‰åº¦
            let rarityText = "";
            let rarityColor = "";
            if (item.r === 'common') { rarityText = "æ™®é€š"; rarityColor = "var(--r-common)"; }
            else if (item.r === 'rare') { rarityText = "ç¨€æœ‰"; rarityColor = "var(--r-rare)"; }
            else if (item.r === 'epic') { rarityText = "å²è©©"; rarityColor = "var(--r-epic)"; }
            else if (item.r === 'legend') { rarityText = "å‚³èªª"; rarityColor = "var(--r-legend)"; }
            else if (item.r === 'mythic' || item.isSpecial) { rarityText = "ç¥è©±"; rarityColor = "var(--r-mythic)"; }
            
            document.getElementById('m-rarity').innerText = rarityText;
            document.getElementById('m-rarity').style.color = rarityColor;
            
            document.getElementById('m-desc').innerText = item.desc;
            
            // é¡¯ç¤ºç´ ææ•¸é‡
            document.getElementById('m-stats').innerHTML = `<div>æ•¸é‡: ${item.count.toLocaleString()}</div>`;
            
            // éš±è—å‹•ä½œæŒ‰éˆ•ï¼Œåªé¡¯ç¤ºé—œé–‰æŒ‰éˆ•
            document.getElementById('m-action').style.display = 'none';
            document.getElementById('item-modal').querySelectorAll('button')[0].style.flex = '1';
            document.getElementById('item-modal').querySelectorAll('button')[0].style.gridColumn = '1 / -1';
            document.getElementById('item-modal').querySelectorAll('button')[0].innerText = 'é—œé–‰';
            document.getElementById('item-modal').querySelectorAll('button')[0].onclick = () => this.closeModal();
            
            document.getElementById('item-modal').style.display = 'flex';
        },

        renderShop() {
            ['potion', 'weapon', 'armor', 'material'].forEach(cat => {
                const div = document.getElementById('shop-' + cat);
                if (div) div.innerHTML = "";
            });
            
            Object.entries(DB.items).forEach(([name, item]) => {
                // è·³éåªèƒ½é›é€ çš„ç‰©å“å’Œä¸Šå¸å°ˆå±¬è£å‚™
                if (item.craftOnly || item.godOnly) return;
                
                const cat = item.category;
                const shopDiv = document.getElementById('shop-' + cat);
                if (!shopDiv) return;
                
                const card = document.createElement('div');
                card.className = `shop-card`;
                card.innerHTML = `
                    <div class="shop-card-icon">${item.icon}</div>
                    <div class="shop-card-name">${name}</div>
                    <div class="shop-card-desc">${item.desc}</div>
                    <div class="shop-card-footer">
                        <span class="shop-card-price">${item.price}G</span>
                        <button class="btn" style="padding:3px 6px; font-size:0.65em;" 
                            onclick="Game.buyItem('${name}')" ${Player.gold < item.price ? 'disabled' : ''}>è³¼è²·</button>
                    </div>
                `;
                shopDiv.appendChild(card);
            });
            
            this.switchShopCategory(currentShopCategory);
        },

        renderRecipes() {
            const recipeList = document.getElementById('recipe-list');
            if (!recipeList) return;
            
            recipeList.innerHTML = "";
            
            DB.recipes.forEach(recipe => {
                const card = document.createElement('div');
                card.className = 'recipe-card';
                
                let hasAllMaterials = true;
                const materialsHtml = recipe.materials.map(mat => {
                    let hasEnough = false;
                    if (mat.name === "éŠ€è£½é•·åŠ" || mat.name === "é‹¼éµé•·åŠ") {
                        // æª¢æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰é€™å€‹æ­¦å™¨
                        const weapon = Game.findItemInBag(mat.name);
                        hasEnough = weapon && weapon.count >= mat.amount;
                    } else {
                        hasEnough = Game.getMaterialCount(mat.name) >= mat.amount;
                    }
                    
                    if (!hasEnough) hasAllMaterials = false;
                    
                    let countText = "";
                    if (mat.name === "éŠ€è£½é•·åŠ" || mat.name === "é‹¼éµé•·åŠ") {
                        const weapon = Game.findItemInBag(mat.name);
                        const weaponCount = weapon ? weapon.count : 0;
                        countText = `(${weaponCount}/${mat.amount})`;
                    } else {
                        countText = `(${Game.getMaterialCount(mat.name)}/${mat.amount})`;
                    }
                    
                    return `
                        <div class="material-item ${hasEnough ? 'has-enough' : 'not-enough'}">
                            <span>${DB.items[mat.name]?.icon || 'â“'}</span>
                            <span>${mat.name} x${mat.amount}</span>
                            <span>${countText}</span>
                        </div>
                    `;
                }).join('');
                
                if (hasAllMaterials) {
                    card.classList.add('available');
                }
                
                card.innerHTML = `
                    <div class="recipe-header">
                        <div style="display:flex; align-items:center; gap:6px;">
                            <div class="recipe-icon">${recipe.icon}</div>
                            <div class="recipe-name">${recipe.name}</div>
                        </div>
                        <button class="btn" style="padding:3px 6px; font-size:0.65em;" 
                            onclick="Game.craftItem(${recipe.id})" ${!hasAllMaterials ? 'disabled' : ''}>
                            é›é€ 
                        </button>
                    </div>
                    <div class="recipe-desc">${recipe.desc}</div>
                    <div class="recipe-materials">
                        ${materialsHtml}
                    </div>
                `;
                
                recipeList.appendChild(card);
            });
        },

        renderUpgrade() {
            const upgradeList = document.getElementById('upgrade-list');
            if (!upgradeList) return;
            
            upgradeList.innerHTML = "";
            
            // æ‰¾å‡ºæ‰€æœ‰å¯ä»¥å¼·åŒ–çš„ç‰©å“ï¼ˆæ­¦å™¨å’Œç›”ç”²ï¼‰
            const upgradableItems = [];
            Object.keys(Player.bag).forEach(name => {
                const item = Player.bag[name];
                if ((item.type === 'weapon' || item.type === 'armor') && item.count > 0) {
                    // ç‚ºæ¯å€‹ç‰©å“å¯¦ä¾‹å‰µå»ºä¸€å€‹æ¢ç›®
                    upgradableItems.push({name: name, ...item});
                }
            });
            
            if (upgradableItems.length === 0) {
                upgradeList.innerHTML = `
                    <div style="grid-column:1/-1; text-align:center; color:#666; padding:20px; font-size:0.9em;">
                        <div style="font-size:3em; margin-bottom:10px;">ğŸ”§</div>
                        <div>æ²’æœ‰å¯ä»¥å¼·åŒ–çš„è£å‚™</div>
                        <div style="font-size:0.8em; color:#888; margin-top:10px;">è«‹å…ˆç²å¾—æ­¦å™¨æˆ–ç›”ç”²</div>
                    </div>
                `;
                return;
            }
            
            upgradableItems.forEach((item) => {
                const rules = DB.enhancementRules[item.type];
                const nextLevel = item.enhanceLevel + 1;
                const cost = rules.costMultiplier * nextLevel;
                const materialNeeded = rules.materialCost;
                const successRate = rules.successRate[item.enhanceLevel];
                
                const card = document.createElement('div');
                card.className = 'upgrade-card';
                
                // è¨ˆç®—å¼·åŒ–å¾Œçš„å±¬æ€§
                let enhancedStats = "";
                if (item.type === 'weapon') {
                    const baseAtk = item.baseAtk || item.atk || 0;
                    const baseAtkPercent = item.baseAtkPercent || item.atkPercent || 0;
                    const newAtk = baseAtk + (rules.atk * nextLevel);
                    const newAtkPercent = baseAtkPercent + (rules.atkPercent * nextLevel);
                    enhancedStats = `æ”»æ“ŠåŠ›: ${item.atk || 0} â†’ ${newAtk} (+${rules.atk})<br>æ”»æ“ŠåŠ›%: ${item.atkPercent || 0}% â†’ ${newAtkPercent}% (+${rules.atkPercent}%)`;
                } else if (item.type === 'armor') {
                    const baseHp = item.baseHp || item.hp || 0;
                    const baseDef = item.baseDef || item.def || 0;
                    const baseHpPercent = item.baseHpPercent || item.hpPercent || 0;
                    const newHp = baseHp + (rules.hp * nextLevel);
                    const newDef = baseDef + (rules.def * nextLevel);
                    const newHpPercent = baseHpPercent + (rules.hpPercent * nextLevel);
                    enhancedStats = `ç”Ÿå‘½å€¼: ${item.hp || 0} â†’ ${newHp} (+${rules.hp})<br>é˜²ç¦¦åŠ›: ${item.def || 0} â†’ ${newDef} (+${rules.def})`;
                    if (item.hpPercent || rules.hpPercent) {
                        enhancedStats += `<br>ç”Ÿå‘½å€¼%: ${item.hpPercent || 0}% â†’ ${newHpPercent}% (+${rules.hpPercent}%)`;
                    }
                }
                
                card.innerHTML = `
                    <div class="upgrade-card-icon">${item.icon}</div>
                    <div class="upgrade-card-name">${item.name} ${item.enhanceLevel > 0 ? `+${item.enhanceLevel}` : ''}</div>
                    <div class="upgrade-card-desc">${item.desc}</div>
                    <div style="font-size:0.7em; color:#ccc; margin-bottom:8px;">
                        ${enhancedStats}
                    </div>
                    <div style="font-size:0.7em; color:#ff9800; margin-bottom:8px;">
                        æˆåŠŸç‡: ${successRate}% | æ¶ˆè€—: ${cost} G + å¼·åŒ–å¯¶çŸ³ x${materialNeeded}
                    </div>
                    <div class="upgrade-card-footer">
                        <span class="upgrade-card-price">å¼·åŒ–ç­‰ç´š: ${item.enhanceLevel}/9</span>
                        <button class="btn" style="padding:3px 6px; font-size:0.65em;" 
                            onclick="Game.enhanceItem('${item.name}')" 
                            ${Player.gold < cost || Game.getMaterialCount("å¼·åŒ–å¯¶çŸ³") < materialNeeded || item.enhanceLevel >= 9 ? 'disabled' : ''}>
                            å¼·åŒ–
                        </button>
                    </div>
                `;
                
                upgradeList.appendChild(card);
            });
        },

        openItemModal(item) {
            document.getElementById('m-icon').innerText = item.icon;
            
            // é¡¯ç¤ºç‰©å“åç¨±ï¼ˆå«å¼·åŒ–ç­‰ç´šï¼‰
            let itemName = item.name;
            if (item.enhanceLevel > 0) {
                itemName += ` +${item.enhanceLevel}`;
            }
            document.getElementById('m-title').innerText = itemName;
            
            // é¡¯ç¤ºç¨€æœ‰åº¦
            let rarityText = "";
            let rarityColor = "";
            if (item.r === 'common') { rarityText = "æ™®é€š"; rarityColor = "var(--r-common)"; }
            else if (item.r === 'rare') { rarityText = "ç¨€æœ‰"; rarityColor = "var(--r-rare)"; }
            else if (item.r === 'epic') { rarityText = "å²è©©"; rarityColor = "var(--r-epic)"; }
            else if (item.r === 'legend') { rarityText = "å‚³èªª"; rarityColor = "var(--r-legend)"; }
            else if (item.r === 'mythic' || item.isSpecial) { rarityText = "ç¥è©±"; rarityColor = "var(--r-mythic)"; }
            
            document.getElementById('m-rarity').innerText = rarityText;
            document.getElementById('m-rarity').style.color = rarityColor;
            
            document.getElementById('m-desc').innerText = item.desc;
            
            // é¡¯ç¤ºç‰©å“çµ±è¨ˆæ•¸æ“š
            const statsDiv = document.getElementById('m-stats');
            let statsHTML = "";
            
            if (item.isMaterial) {
                statsHTML = `<div>æ•¸é‡: ${item.count.toLocaleString()}</div>`;
                // å¦‚æœæ˜¯ç´ æï¼Œåªé¡¯ç¤ºä¸€å€‹é—œé–‰æŒ‰éˆ•
                document.getElementById('m-action').style.display = 'none';
                document.getElementById('item-modal').querySelectorAll('button')[0].style.flex = '1';
                document.getElementById('item-modal').querySelectorAll('button')[0].style.gridColumn = '1 / -1';
                document.getElementById('item-modal').querySelectorAll('button')[0].innerText = 'é—œé–‰';
                document.getElementById('item-modal').querySelectorAll('button')[0].onclick = () => this.closeModal();
            } else {
                // æ¢å¾©å…©å€‹æŒ‰éˆ•çš„ä½ˆå±€
                document.getElementById('m-action').style.display = 'flex';
                document.getElementById('item-modal').querySelectorAll('button')[0].style.flex = '1';
                document.getElementById('item-modal').querySelectorAll('button')[0].style.gridColumn = '';
                document.getElementById('item-modal').querySelectorAll('button')[0].innerText = 'é—œé–‰';
                document.getElementById('item-modal').querySelectorAll('button')[0].onclick = () => this.closeModal();
                
                if (item.type === 'weapon') {
                    statsHTML = `<div>æ”»æ“ŠåŠ›: +${(item.atk || 0).toLocaleString()}</div>`;
                    if (item.atkPercent) {
                        statsHTML += `<div>æ”»æ“ŠåŠ›åŠ æˆ: +${item.atkPercent}%</div>`;
                    }
                    if (item.enhanceLevel > 0) {
                        statsHTML += `<div class="enhance-level">å¼·åŒ–ç­‰ç´š: +${item.enhanceLevel}</div>`;
                    }
                } else if (item.type === 'armor') {
                    statsHTML = `<div>ç”Ÿå‘½å€¼: +${(item.hp || 0).toLocaleString()}</div>`;
                    if (item.hpPercent) {
                        statsHTML += `<div>ç”Ÿå‘½å€¼åŠ æˆ: +${item.hpPercent}%</div>`;
                    }
                    statsHTML += `<div>é˜²ç¦¦åŠ›: +${(item.def || 0).toLocaleString()}</div>`;
                    if (item.mp) {
                        statsHTML += `<div>é­”åŠ›å€¼: +${item.mp}</div>`;
                    }
                    if (item.enhanceLevel > 0) {
                        statsHTML += `<div class="enhance-level">å¼·åŒ–ç­‰ç´š: +${item.enhanceLevel}</div>`;
                    }
                } else if (item.type === 'potion') {
                    if (item.effect === 'hp') {
                        statsHTML = `<div>æ¢å¾©ç”Ÿå‘½å€¼: ${item.val}</div>`;
                    } else if (item.effect === 'mp') {
                        statsHTML = `<div>æ¢å¾©é­”åŠ›å€¼: ${item.val}</div>`;
                    } else if (item.effect === 'both') {
                        statsHTML = `<div>æ¢å¾©å…¨éƒ¨HPå’ŒMP</div>`;
                    }
                } else if (item.type === 'buff') {
                    statsHTML = `<div>æ•ˆæœ: ${item.desc}</div>`;
                }
                
                // é¡¯ç¤ºæ•¸é‡ï¼ˆå¦‚æœä¸æ˜¯è£å‚™ä¸­çš„ç‰©å“ï¼‰
                const isEquipped = (Player.weapon && Player.weapon.name === item.name) || 
                                  (Player.armor && Player.armor.name === item.name);
                if (!isEquipped && item.count > 1) {
                    statsHTML += `<div>æ•¸é‡: ${item.count}</div>`;
                }
            }
            
            statsDiv.innerHTML = statsHTML;
            
            const act = document.getElementById('m-action');
            
            if (item.isMaterial) {
                // ç´ æåªæœ‰ä¸€å€‹é—œé–‰æŒ‰éˆ•ï¼Œä¸Šé¢å·²ç¶“è™•ç†äº†
                return;
            } else {
                // æª¢æŸ¥æ˜¯å¦å·²è£å‚™
                const isEquippedWeapon = Player.weapon && Player.weapon.name === item.name;
                const isEquippedArmor = Player.armor && Player.armor.name === item.name;
                const isEquipped = isEquippedWeapon || isEquippedArmor;
                
                // æª¢æŸ¥æ˜¯å¦åœ¨æˆ°é¬¥ä¸­ï¼ˆæŸäº›ç‰©å“ä¸èƒ½åœ¨æˆ°é¬¥ä¸­ä½¿ç”¨ï¼‰
                const inCombat = Game.state === 'combat' && Game.currentPage === 'adventure';
                
                if (item.type === 'weapon') {
                    if (inCombat) {
                        act.innerText = "æˆ°é¬¥ä¸­ç„¡æ³•ä½¿ç”¨";
                        act.disabled = true;
                        act.style.background = '#666';
                        act.onclick = null;
                    } else if (isEquipped) {
                        act.innerText = "å¸ä¸‹";
                        act.onclick = () => {
                            // å¸ä¸‹æ­¦å™¨ï¼Œæ”¾å›èƒŒåŒ…
                            Game.addItem(item.name, 1);
                            Player.weapon = null;
                            Player.equipmentAtkPercent = 0;
                            Game.updatePlayerStats();
                            this.closeModal();
                            UI.log(`å¸ä¸‹äº† ${item.name}ï¼`);
                            UI.update();
                        };
                    } else {
                        act.innerText = "è£å‚™";
                        act.onclick = () => {
                            // å¾èƒŒåŒ…ç§»é™¤ä¸€å€‹
                            Game.removeItemFromBag(item.name, 1);
                            
                            // å¦‚æœå·²æœ‰è£å‚™çš„æ­¦å™¨ï¼Œæ”¾å›èƒŒåŒ…
                            if (Player.weapon) {
                                Game.addItem(Player.weapon.name, 1);
                                Player.equipmentAtkPercent = 0;
                            }
                            
                            // è£å‚™æ–°æ­¦å™¨
                            Player.weapon = {...item};
                            Player.weapon.name = item.name;
                            
                            // æ·»åŠ æ­¦å™¨ç™¾åˆ†æ¯”åŠ æˆ
                            if (item.atkPercent) {
                                Player.equipmentAtkPercent = item.atkPercent;
                            }
                            
                            Game.updatePlayerStats();
                            
                            this.closeModal();
                            UI.log(`è£å‚™äº† ${item.name}ï¼`);
                            UI.update();
                        };
                    }
                } else if (item.type === 'armor') {
                    if (inCombat) {
                        act.innerText = "æˆ°é¬¥ä¸­ç„¡æ³•ä½¿ç”¨";
                        act.disabled = true;
                        act.style.background = '#666';
                        act.onclick = null;
                    } else if (isEquipped) {
                        act.innerText = "å¸ä¸‹";
                        act.onclick = () => {
                            // å¸ä¸‹ç›”ç”²ï¼Œæ”¾å›èƒŒåŒ…
                            Game.addItem(item.name, 1);
                            Player.armor = null;
                            
                            // ç§»é™¤ç›”ç”²åŠ æˆ
                            if (item.hp) Player.equipmentHpBonus -= item.hp;
                            if (item.hpPercent) Player.equipmentHpPercent -= item.hpPercent;
                            if (item.def) Player.equipmentDefBonus -= item.def;
                            
                            Game.updatePlayerStats();
                            
                            this.closeModal();
                            UI.log(`å¸ä¸‹äº† ${item.name}ï¼`);
                            UI.update();
                        };
                    } else {
                        act.innerText = "è£å‚™";
                        act.onclick = () => {
                            // å¾èƒŒåŒ…ç§»é™¤ä¸€å€‹
                            Game.removeItemFromBag(item.name, 1);
                            
                            if (Player.armor) {
                                // ç§»é™¤èˆŠç›”ç”²åŠ æˆ
                                if (Player.armor.hp) Player.equipmentHpBonus -= Player.armor.hp;
                                if (Player.armor.hpPercent) Player.equipmentHpPercent -= Player.armor.hpPercent;
                                if (Player.armor.def) Player.equipmentDefBonus -= Player.armor.def;
                                
                                // æ”¾å›èƒŒåŒ…
                                Game.addItem(Player.armor.name, 1);
                            }
                            
                            // è£å‚™æ–°ç›”ç”²
                            Player.armor = {...item};
                            Player.armor.name = item.name;
                            
                            // æ·»åŠ æ–°ç›”ç”²åŠ æˆ
                            if (item.hp) Player.equipmentHpBonus += item.hp;
                            if (item.hpPercent) Player.equipmentHpPercent += item.hpPercent;
                            if (item.def) Player.equipmentDefBonus += item.def;
                            
                            Game.updatePlayerStats();
                            
                            this.closeModal();
                            UI.log(`è£å‚™äº† ${item.name}ï¼`);
                            UI.update();
                        };
                    }
                } else if (item.type === 'buff') {
                    act.innerText = "ä½¿ç”¨";
                    act.onclick = () => {
                        // å¾èƒŒåŒ…ç§»é™¤ä¸€å€‹
                        Game.removeItemFromBag(item.name, 1);
                        
                        if (item.stat === 'atk') {
                            Player.baseAtk += item.val;
                            Player.equipmentAtkPercent = 0; // é‡ç½®ç™¾åˆ†æ¯”åŠ æˆ
                            if (Player.weapon && Player.weapon.atkPercent) {
                                Player.equipmentAtkPercent = Player.weapon.atkPercent;
                            }
                        }
                        else if (item.stat === 'def') Player.baseDef += item.val;
                        else if (item.stat === 'crit') Player.crit += item.val;
                        else if (item.stat === 'maxHp') { 
                            Player.baseMaxHp += item.val;
                            Game.updatePlayerStats();
                            Player.hp += item.val;
                        }
                        else if (item.stat === 'maxMp') { 
                            Player.maxMp += item.val; 
                            Player.mp += item.val;
                        }
                        this.closeModal();
                        UI.log(`ä½¿ç”¨äº† ${item.name}ï¼`);
                        Game.updatePlayerStats();
                        UI.update();
                    };
                } else {
                    // è—¥æ°´é¡å¯ä»¥åœ¨æˆ°é¬¥ä¸­ä½¿ç”¨
                    act.innerText = "ä½¿ç”¨";
                    act.onclick = () => {
                        // å¾èƒŒåŒ…ç§»é™¤ä¸€å€‹
                        Game.removeItemFromBag(item.name, 1);
                        
                        if(item.effect === 'hp') Player.hp = Math.min(Player.maxHp, Player.hp + item.val);
                        else if(item.effect === 'mp') Player.mp = Math.min(Player.maxMp, Player.mp + item.val);
                        else if(item.effect === 'both') {
                            Player.hp = Player.maxHp;
                            Player.mp = Player.maxMp;
                        }
                        this.closeModal();
                        UI.log(`ä½¿ç”¨äº† ${item.name}ï¼`);
                        UI.update();
                    };
                }
            }
            
            document.getElementById('item-modal').style.display = 'flex';
        },

        closeModal() { 
            document.getElementById('item-modal').style.display = 'none'; 
        },

        switchTab(tab, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tabs-container button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${tab}-tab`).classList.add('active');
            btn.classList.add('active');
            
            if (tab === 'bag') {
                this.renderBag();
            }
        },

        switchBagCategory(cat) {
            currentBagCategory = cat;
            document.querySelectorAll('.bag-category-tabs button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            this.renderBag();
        },

        switchShopCategory(cat) {
            currentShopCategory = cat;
            document.querySelectorAll('.shop-category').forEach(div => div.classList.remove('active'));
            document.querySelectorAll('.shop-category-tabs button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('shop-' + cat).classList.add('active');
            event.target.classList.add('active');
        },

        log(msg) {
            const log = document.getElementById('log-tab');
            if (!log) return;
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `&gt; ${msg}`;
            log.appendChild(logEntry);
            
            while (log.children.length > 50) {
                log.removeChild(log.firstChild);
            }
            
            log.scrollTop = log.scrollHeight;
        },

        float(txt, color) {
            const f = document.createElement('div');
            f.className = 'floating-text';
            f.innerText = txt; 
            f.style.color = color;
            f.style.left = "50%"; 
            f.style.top = "40%";
            f.style.transform = "translateX(-50%)";
            document.getElementById('stage').appendChild(f);
            setTimeout(() => f.remove(), 1000);
        },

        shake() {
            const s = document.getElementById('stage');
            s.classList.add('shake');
            setTimeout(() => s.classList.remove('shake'), 300);
        }
    };

    // å¯†ç¢¼ç›¸é—œå‡½æ•¸
    function showPasswordModal() {
        document.getElementById('password-modal').style.display = 'flex';
        document.getElementById('password-input').value = '';
        document.getElementById('password-error').textContent = '';
        document.getElementById('password-input').focus();
    }

    function hidePasswordModal() {
        document.getElementById('password-modal').style.display = 'none';
        passwordAttempts = 0;
    }

    function checkPassword() {
        const input = document.getElementById('password-input').value;
        const errorElement = document.getElementById('password-error');
        
        passwordAttempts++;
        
        if (GOD_PASSWORDS.includes(input)) {
            hidePasswordModal();
            startGame('god');
        } else {
            if (passwordAttempts >= MAX_PASSWORD_ATTEMPTS) {
                errorElement.textContent = `å¯†ç¢¼éŒ¯èª¤ï¼å·²å˜—è©¦ ${passwordAttempts} æ¬¡ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚`;
                setTimeout(hidePasswordModal, 2000);
            } else {
                const remaining = MAX_PASSWORD_ATTEMPTS - passwordAttempts;
                errorElement.textContent = `å¯†ç¢¼éŒ¯èª¤ï¼é‚„å‰© ${remaining} æ¬¡å˜—è©¦æ©Ÿæœƒã€‚`;
            }
        }
    }

    // éŠæˆ²é–‹å§‹å‡½æ•¸
    function startGame(cls) {
        Game.init(cls);
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // ç¢ºä¿CSSé¡æ­£ç¢ºæ‡‰ç”¨
        const statLabels = document.querySelectorAll('.stat-label');
        statLabels.forEach(label => {
            label.classList.add('stat-label');
        });
        
        UI.switchShopCategory('potion');
        Game.updateButtons();
        
        // å¯†ç¢¼è¼¸å…¥æ¡†å›è»Šéµæ”¯æŒ
        document.getElementById('password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        
        // æ‰‹æ©Ÿè§¸æ§å„ªåŒ–
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // é˜²æ­¢æ‰‹æ©Ÿé›™æ“Šæ”¾å¤§
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // ä¿®å¾©èƒŒåŒ…åˆ†é¡æŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.querySelectorAll('.bag-category-tabs button').forEach(button => {
            button.addEventListener('click', function() {
                const cat = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                UI.switchBagCategory(cat);
            });
        });
        
        // ä¿®å¾©å•†åº—åˆ†é¡æŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.querySelectorAll('.shop-category-tabs button').forEach(button => {
            button.addEventListener('click', function() {
                const cat = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                UI.switchShopCategory(cat);
            });
        });
    });
</script>
</body>
</html>
